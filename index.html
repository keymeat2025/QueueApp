
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueApp - Smart Queue Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #f97316; --primary-dark: #ea580c; --secondary: #ec4899;
            --success: #22c55e; --warning: #eab308; --danger: #dc2626;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827; --white: #ffffff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: var(--gray-900); background: var(--gray-50); font-size: 16px; }
        h1 { font-size: clamp(1.5rem, 4vw, 3.5rem); font-weight: 700; }
        h2 { font-size: clamp(1.25rem, 3vw, 2.5rem); font-weight: 700; }
        h3 { font-size: clamp(1.1rem, 2.5vw, 2rem); font-weight: 600; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 clamp(1rem, 3vw, 2rem); }
        nav { background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: clamp(0.75rem, 2vw, 1.5rem); position: sticky; top: 0; z-index: 100; }
        nav .nav-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        nav h1 { color: var(--primary); cursor: pointer; font-size: clamp(1.25rem, 3vw, 2rem); }
        nav .nav-buttons { display: flex; gap: clamp(0.5rem, 1.5vw, 1rem); flex-wrap: wrap; }
        button, .btn { padding: clamp(0.5rem, 1.5vw, 1rem) clamp(1rem, 3vw, 2rem); border: none; border-radius: clamp(0.5rem, 1vw, 1rem); font-size: clamp(0.875rem, 1.5vw, 1.125rem); font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; }
        button:hover, .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); }
        .btn-secondary { background: var(--gray-600); color: var(--white); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .card { background: var(--white); border-radius: clamp(1rem, 2vw, 2rem); padding: clamp(1.5rem, 3vw, 3rem); box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: clamp(1rem, 2vw, 2rem); }
        .grid { display: grid; gap: clamp(1rem, 2vw, 2rem); margin-bottom: clamp(1rem, 2vw, 2rem); }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(min(150px, 100%), 1fr)); }
        input, select, textarea { width: 100%; padding: clamp(0.75rem, 2vw, 1.25rem); border: 2px solid var(--gray-200); border-radius: clamp(0.5rem, 1vw, 1rem); font-size: clamp(0.875rem, 1.5vw, 1.125rem); margin-bottom: clamp(0.75rem, 1.5vw, 1.5rem); transition: border 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .badge { display: inline-block; padding: clamp(0.25rem, 0.5vw, 0.5rem) clamp(0.5rem, 1vw, 1rem); border-radius: 999px; font-size: clamp(0.75rem, 1vw, 0.875rem); font-weight: 700; }
        .badge-primary { background: var(--primary); color: var(--white); }
        .badge-warning { background: var(--warning); color: var(--white); }
        .badge-danger { background: var(--danger); color: var(--white); }
        .badge-secondary { background: var(--gray-600); color: var(--white); }
        .bg-gradient { background: linear-gradient(135deg, #fff7ed 0%, #fce7f3 100%); }
        .bg-gradient-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); }
        .display-screen { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: var(--white); min-height: 100vh; padding: clamp(1rem, 3vw, 4rem); }
        .display-screen h1 { font-size: clamp(2rem, 6vw, 6rem); margin-bottom: clamp(1rem, 3vw, 3rem); }
        .display-screen h2 { font-size: clamp(1.5rem, 4vw, 4rem); }
        .display-screen .queue-number { font-size: clamp(3rem, 10vw, 12rem); font-weight: 900; }
        .alert { padding: clamp(1rem, 2vw, 1.5rem); border-radius: clamp(0.5rem, 1vw, 1rem); margin-bottom: clamp(1rem, 2vw, 1.5rem); border: 2px solid; }
        .alert-warning { background: #fef9c3; border-color: var(--warning); color: #854d0e; }
        .alert-danger { background: #fee2e2; border-color: var(--danger); color: #991b1b; }
        .alert-success { background: #dcfce7; border-color: var(--success); color: #166534; }
        .alert-info { background: #dbeafe; border-color: #2563eb; color: #1e40af; }
        details summary { transition: all 0.3s ease; list-style: none; cursor: pointer; }
        details[open] summary { color: var(--primary); }
        details[open] summary span { transform: rotate(90deg); display: inline-block; }
        details summary::-webkit-details-marker { display: none; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: clamp(0.5rem, 1vw, 1rem); }
        .w-full { width: 100%; }
        .hidden { display: none; }
        .space-y > * + * { margin-top: clamp(0.75rem, 1.5vw, 1.5rem); }
        .mb { margin-bottom: clamp(1rem, 2vw, 2rem); }
        .mt { margin-top: clamp(1rem, 2vw, 2rem); }
        .loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; background: linear-gradient(135deg, #fff7ed 0%, #fce7f3 100%); }
        .loading-icon { font-size: clamp(3rem, 8vw, 6rem); margin-bottom: clamp(1rem, 2vw, 2rem); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .progress-bar { background: var(--gray-200); height: 30px; border-radius: 999px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; transition: width 0.3s ease; }
        .qr-container { background: white; padding: 2rem; border-radius: 1rem; display: inline-block; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .qr-badge { position: absolute; top: -10px; right: -10px; background: var(--success); color: white; padding: 0.5rem 1rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; animation: pulse 2s infinite; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @media (max-width: 640px) { nav .nav-buttons { width: 100%; justify-content: center; } .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        @media (min-width: 1920px) { body { font-size: 20px; } .display-screen .queue-number { font-size: 15rem; } }
        @media (min-width: 2560px) { body { font-size: 24px; } .container { max-width: 2000px; } .display-screen .queue-number { font-size: 20rem; } }
        @media print { 
            body * { visibility: hidden; }
            .print-qr, .print-qr * { visibility: visible; }
            .print-qr { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-screen">
            <div class="loading-icon">‚è≥</div>
            <h1>Loading QueueApp...</h1>
        </div>
    </div>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyBQRfA1_qgG9x4w4aiDqAzAPghMEc5zE6Q",
          authDomain: "queueapp-97728.firebaseapp.com",
          projectId: "queueapp-97728",
          storageBucket: "queueapp-97728.firebasestorage.app",
          messagingSenderId: "41156558140",
          appId: "1:41156558140:web:f3277e7018176d0870f239",
          measurementId: "G-QSP7ZXNSFT"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log('üî• Firebase initialized');
        
        // Daily QR Code Generator
        function getTodayQRCode(restaurantId) {
            const baseUrl = window.location.origin + window.location.pathname;
            const qrUrl = `${baseUrl}#/r/${restaurantId}/join`;
            return qrUrl;
        }
        
        function generateQRCode(elementId, restaurantId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = '';
            const qrUrl = getTodayQRCode(restaurantId);
            
            new QRCode(element, {
                text: qrUrl,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function printQRCode() {
            window.print();
        }
        
        function downloadQRCode(restaurantId) {
            const canvas = document.querySelector('#daily-qr canvas');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `QueueApp-QR-${new Date().toISOString().slice(0, 10)}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
        
        // Firebase Admin Auth
        const FirebaseAdmin = {
            async signIn(email, password) {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            async signOut() {
                try {
                    await auth.signOut();
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            getCurrentUser() { return auth.currentUser; },
            onAuthStateChanged(callback) { return auth.onAuthStateChanged(callback); }
        };
        
        window.FirebaseAdmin = FirebaseAdmin;
        
        // Firebase Database with Analytics
        const FirebaseDB = {
            async addRestaurant(restaurantId, data) {
                try {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const today = new Date().toISOString().slice(0, 10);
                    
                    await db.collection('restaurants').doc(restaurantId).set({
                        ...data,
                        queue: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        plan: 'free',
                        planStatus: 'active',
                        analytics: {
                            currentMonth,
                            customersThisMonth: 0,
                            lastResetDate: today,
                            dailyStats: {}
                        },
                        monthlyHistory: [],
                        queueArchive: {}
                    });
                    return { success: true, id: restaurantId };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getRestaurant(restaurantId) {
                try {
                    const doc = await db.collection('restaurants').doc(restaurantId).get();
                    return doc.exists ? { success: true, data: doc.data() } : { success: false, error: 'Not found' };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getAllRestaurants() {
                try {
                    const snapshot = await db.collection('restaurants').get();
                    const restaurants = {};
                    snapshot.forEach(doc => { restaurants[doc.id] = doc.data(); });
                    return { success: true, data: restaurants };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async addToQueue(restaurantId, customer) {
                try {
                    const restaurantRef = db.collection('restaurants').doc(restaurantId);
                    const doc = await restaurantRef.get();
                    
                    if (!doc.exists) return { success: false, error: 'Restaurant not found' };
                    
                    const restaurant = doc.data();
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const today = new Date().toISOString().slice(0, 10);
                    
                    let analytics = restaurant.analytics || {
                        currentMonth,
                        customersThisMonth: 0,
                        lastResetDate: today,
                        dailyStats: {}
                    };
                    
                    // Reset monthly count if new month
                    if (analytics.currentMonth !== currentMonth) {
                        const monthlyHistory = restaurant.monthlyHistory || [];
                        monthlyHistory.push({
                            month: analytics.currentMonth,
                            totalCustomers: analytics.customersThisMonth,
                            dailyStats: analytics.dailyStats,
                            archivedAt: new Date().toISOString()
                        });
                        
                        analytics = {
                            currentMonth,
                            customersThisMonth: 0,
                            lastResetDate: today,
                            dailyStats: {}
                        };
                        
                        await restaurantRef.update({ monthlyHistory, analytics });
                    }
                    
                    // Check FREE plan limit
                    if (restaurant.plan === 'free' && analytics.customersThisMonth >= 500) {
                        return { 
                            success: false, 
                            error: 'LIMIT_REACHED',
                            message: 'Monthly limit reached. Upgrade to Premium.',
                            customersUsed: analytics.customersThisMonth,
                            limit: 500
                        };
                    }
                    
                    const queueNumber = `A-${Math.floor(Math.random() * 900) + 100}`;
                    const queueItem = {
                        ...customer,
                        queueNumber,
                        status: 'waiting',
                        joinedAt: new Date().toISOString()
                    };
                    
                    analytics.customersThisMonth += 1;
                    analytics.dailyStats[today] = (analytics.dailyStats[today] || 0) + 1;
                    
                    await restaurantRef.update({
                        queue: firebase.firestore.FieldValue.arrayUnion(queueItem),
                        analytics
                    });
                    
                    console.log(`‚úÖ Added to queue: ${queueNumber} (${analytics.customersThisMonth}/${restaurant.plan === 'free' ? 500 : '‚àû'})`);
                    
                    return { 
                        success: true, 
                        queueNumber,
                        customersThisMonth: analytics.customersThisMonth,
                        limit: restaurant.plan === 'free' ? 500 : 'unlimited'
                    };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async allocateTable(restaurantId, queueNumber, tableNo) {
                try {
                    const result = await this.getRestaurant(restaurantId);
                    if (!result.success) return result;
                    
                    const restaurant = result.data;
                    const updatedQueue = restaurant.queue.map(q => 
                        q.queueNumber === queueNumber 
                            ? { ...q, status: 'allocated', tableNo, allocatedAt: new Date().toISOString() }
                            : q
                    );
                    
                    await db.collection('restaurants').doc(restaurantId).update({ queue: updatedQueue });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getAnalytics(restaurantId) {
                try {
                    const doc = await db.collection('restaurants').doc(restaurantId).get();
                    if (!doc.exists) return { success: false, error: 'Not found' };
                    const restaurant = doc.data();
                    return { 
                        success: true, 
                        analytics: restaurant.analytics || {},
                        monthlyHistory: restaurant.monthlyHistory || []
                    };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async dailyCleanup(restaurantId) {
                try {
                    const restaurantRef = db.collection('restaurants').doc(restaurantId);
                    const doc = await restaurantRef.get();
                    if (!doc.exists) return { success: false, error: 'Not found' };
                    
                    const restaurant = doc.data();
                    const today = new Date().toISOString().slice(0, 10);
                    
                    const queueArchive = restaurant.queueArchive || {};
                    queueArchive[today] = {
                        date: today,
                        totalCustomers: restaurant.queue.length,
                        served: restaurant.queue.filter(q => q.status === 'allocated').length,
                        waiting: restaurant.queue.filter(q => q.status === 'waiting').length,
                        archivedAt: new Date().toISOString()
                    };
                    
                    await restaurantRef.update({
                        queue: [],
                        lastCleanup: firebase.firestore.FieldValue.serverTimestamp(),
                        queueArchive
                    });
                    
                    console.log(`‚úÖ Cleanup completed for ${restaurantId}`);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async savePaymentProof(restaurantId, paymentData) {
                try {
                    await db.collection('restaurants').doc(restaurantId).update({
                        paymentProof: {
                            ...paymentData,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        planStatus: 'pending'
                    });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async approvePremium(restaurantId, auditData) {
                try {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    
                    const updateData = {
                        plan: 'premium',
                        planStatus: 'active',
                        planExpiryDate: expiryDate.getTime()
                    };
                    
                    // Add audit data if provided
                    if (auditData) {
                        updateData['paymentProof.approvedAt'] = firebase.firestore.FieldValue.serverTimestamp();
                        updateData['paymentProof.approvedBy'] = auditData.approvedBy || 'platform_admin';
                        updateData['paymentProof.approvalReason'] = auditData.approvalReason || 'Approved';
                    }
                    
                    await db.collection('restaurants').doc(restaurantId).update(updateData);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async rejectPremium(restaurantId, reason, auditData) {
                try {
                    const updateData = {
                        planStatus: 'rejected',
                        'paymentProof.rejectedAt': firebase.firestore.FieldValue.serverTimestamp(),
                        'paymentProof.rejectionReason': reason
                    };
                    
                    // Add audit data if provided
                    if (auditData) {
                        updateData['paymentProof.rejectedBy'] = auditData.rejectedBy || 'platform_admin';
                        updateData['paymentProof.rejectedTimestamp'] = auditData.rejectedTimestamp;
                    }
                    
                    await db.collection('restaurants').doc(restaurantId).update(updateData);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        };
        
        window.FirebaseDB = FirebaseDB;
        
        // Local Storage (Backup)
        const DB = {
            restaurants: JSON.parse(localStorage.getItem('restaurants') || '{}'),
            save() { localStorage.setItem('restaurants', JSON.stringify(this.restaurants)); },
            addRestaurant(id, data) { 
                const currentMonth = new Date().toISOString().slice(0, 7);
                const today = new Date().toISOString().slice(0, 10);
                this.restaurants[id] = { 
                    ...data, 
                    queue: [], 
                    plan: 'free', 
                    planStatus: 'active',
                    analytics: { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} },
                    monthlyHistory: []
                }; 
                this.save(); 
                return id; 
            },
            addToQueue(restaurantId, customer) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) return null;
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                const today = new Date().toISOString().slice(0, 10);
                
                if (!restaurant.analytics) {
                    restaurant.analytics = { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} };
                }
                
                if (restaurant.analytics.currentMonth !== currentMonth) {
                    if (!restaurant.monthlyHistory) restaurant.monthlyHistory = [];
                    restaurant.monthlyHistory.push({
                        month: restaurant.analytics.currentMonth,
                        totalCustomers: restaurant.analytics.customersThisMonth
                    });
                    restaurant.analytics = { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} };
                }
                
                if (restaurant.plan === 'free' && restaurant.analytics.customersThisMonth >= 500) return null;
                
                const queueNumber = `A-${Math.floor(Math.random() * 900) + 100}`; 
                restaurant.queue.push({ ...customer, queueNumber, status: 'waiting', joinedAt: new Date().toISOString() }); 
                restaurant.analytics.customersThisMonth += 1;
                restaurant.analytics.dailyStats[today] = (restaurant.analytics.dailyStats[today] || 0) + 1;
                this.save(); 
                return queueNumber; 
            },
            allocateTable(restaurantId, queueNumber, tableNo) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) return false;
                const queueItem = restaurant.queue.find(q => q.queueNumber === queueNumber); 
                if (queueItem) { 
                    queueItem.status = 'allocated'; 
                    queueItem.tableNo = tableNo; 
                    queueItem.allocatedAt = new Date().toISOString(); 
                    this.save(); 
                    return true; 
                } 
                return false; 
            },
            login(restaurantId, phone) { 
                const restaurant = this.restaurants[restaurantId]; 
                return restaurant && restaurant.phone === phone; 
            },
            savePaymentProof(restaurantId, paymentData) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.paymentProof = { ...paymentData, uploadedAt: Date.now() }; 
                    restaurant.planStatus = 'pending'; 
                    this.save(); 
                    return true; 
                }
                return false;
            },
            approvePremium(restaurantId) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.plan = 'premium'; 
                    restaurant.planStatus = 'active'; 
                    const expiryDate = new Date(); 
                    expiryDate.setDate(expiryDate.getDate() + 30); 
                    restaurant.planExpiryDate = expiryDate.getTime(); 
                    this.save(); 
                    return true; 
                }
                return false;
            },
            rejectPremium(restaurantId, reason) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.planStatus = 'rejected'; 
                    if (restaurant.paymentProof) {
                        restaurant.paymentProof.rejectedAt = Date.now();
                        restaurant.paymentProof.rejectionReason = reason;
                    }
                    this.save(); 
                    return true; 
                }
                return false;
            }
        };
        
        window.DB = DB;
        
        // Daily Cleanup Scheduler - Runs at Midnight (12 AM IST)
        async function checkDailyCleanup() {
            const today = new Date().toISOString().slice(0, 10);
            const lastCleanupDate = localStorage.getItem('lastCleanupDate');
            
            if (lastCleanupDate !== today) {
                console.log('üßπ Daily cleanup: New day detected');
                console.log(`   Last cleanup: ${lastCleanupDate || 'Never'}`);
                console.log(`   Current date: ${today}`);
                console.log('   üîÑ Queues will be cleared, QR stays active');
                
                try {
                    const result = await FirebaseDB.getAllRestaurants();
                    if (result.success) {
                        let cleanedCount = 0;
                        for (const [restaurantId] of Object.entries(result.data)) {
                            const cleanupResult = await FirebaseDB.dailyCleanup(restaurantId);
                            if (cleanupResult.success) cleanedCount++;
                        }
                        
                        localStorage.setItem('lastCleanupDate', today);
                        console.log(`‚úÖ Cleanup completed: ${cleanedCount} restaurants cleaned`);
                        console.log(`   Next cleanup: After midnight tomorrow`);
                    }
                } catch (error) {
                    console.error('‚ùå Cleanup error:', error);
                }
            } else {
                console.log('‚ÑπÔ∏è Cleanup already done today - Next cleanup after midnight');
            }
        }
        
        // Helper Functions
        function getLoggedInRestaurant() {
            for (let id of Object.keys(DB.restaurants)) { 
                if (sessionStorage.getItem(`loggedIn_${id}`)) 
                    return { id, data: DB.restaurants[id] }; 
            }
            return null;
        }
        
        function navigateHome() { 
            const loggedIn = getLoggedInRestaurant(); 
            loggedIn ? navigate(`/r/${loggedIn.id}/admin`) : navigate('/'); 
        }
        
        function render(html) { document.getElementById('app').innerHTML = html; }
        function navigate(path) { window.location.hash = path; }
        
        // Router
        function handleRoute() {
            const hash = window.location.hash.slice(1) || '/';
            const parts = hash.split('/').filter(Boolean);
            
            // Clean up platform admin listener if navigating away from admin
            if (hash !== '/admin' && platformAdminListener) {
                platformAdminListener();
                platformAdminListener = null;
                console.log('‚úÖ Platform admin listener cleaned up (route change)');
            }
            
            if (hash === '/' || hash === '') showHome();
            else if (hash === '/pricing') showPricing();
            else if (hash === '/terms') showLegal('Terms of Service', getTermsContent());
            else if (hash === '/privacy') showLegal('Privacy Policy', getPrivacyContent());
            else if (hash === '/signup') showSignup();
            else if (hash === '/login') showLogin();
            else if (hash === '/admin') checkFirebaseAdminAuth() ? showPlatformAdmin() : showAdminPasswordPrompt();
            else if (parts[0] === 'payment' && parts[1] && parts[2] === 'upload') showUploadScreenshot(parts[1]);
            else if (parts[0] === 'payment' && parts[1]) showPaymentPage(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'join') showJoinQueue(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'display') showDisplay(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'status' && parts[3]) showQueueStatus(parts[1], parts[3]);
            else if (parts[0] === 'r' && parts[2] === 'admin') sessionStorage.getItem(`loggedIn_${parts[1]}`) ? showRestaurantAdmin(parts[1]) : showRestaurantLogin(parts[1]);
            else render(`<div class="container text-center" style="padding-top: 4rem;"><h1>404 - Not Found</h1><button onclick="navigate('/')" class="btn btn-primary mt">Go Home</button></div>`);
        }
        
        window.onhashchange = handleRoute;
        
        // Legal Content
        function getTermsContent() {
            return `<h3>1. Acceptance</h3><p>By using QueueApp, you agree to these Terms.</p>
                <h3>2. Service</h3><p>QueueApp provides queue management, QR entry, displays, and analytics.</p>
                <h3>3. Plans</h3><p><strong>Free:</strong> 500 customers/month, basic features.<br><strong>Premium (‚Çπ2,999/month):</strong> Unlimited customers, analytics.</p>
                <h3>4. Payment</h3><p>Monthly billing. Non-refundable. Cancel anytime.</p>
                <h3>5. Contact</h3><p>support@queueapp.com</p>`;
        }
        
        function getPrivacyContent() {
            return `<h3>1. Data Collection</h3><p>Restaurant and customer info for service delivery.</p>
                <h3>2. Data Use</h3><p>Service provision, analytics, improvements.</p>
                <h3>3. Storage</h3><p>Firebase cloud storage with localStorage backup.</p>
                <h3>4. Rights</h3><p>Access, correct, delete data anytime.</p>
                <h3>5. Contact</h3><p>privacy@queueapp.com</p>`;
        }
        
        function showLegal(title, content) {
            render(`
                <div style="min-height: 100vh; background: var(--gray-50);">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1><button onclick="navigateHome()" class="btn btn-secondary">‚Üê Back</button></div></nav>
                    <div class="container" style="padding: 3rem 0; max-width: 900px;">
                        <h1 class="mb">${title}</h1>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Last Updated: December 2024</p>
                        <div class="card"><div class="space-y">${content}</div></div>
                        <div class="text-center mt"><button onclick="navigateHome()" class="btn btn-primary">Back</button></div>
                    </div>
                </div>
            `);
        }
        
        // Home Page
        function showHome() {
            render(`
                <div class="bg-gradient" style="min-height: 100vh;">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1>
                    <div class="nav-buttons">
                        <button onclick="navigate('/pricing')" class="btn btn-secondary">Pricing</button>
                        <button onclick="navigate('/login')" class="btn btn-secondary">Login</button>
                        <button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button>
                    </div></div></nav>
                    <main class="container text-center" style="padding: clamp(2rem, 5vw, 8rem) 0;">
                        <h1 style="margin-bottom: 1rem;">Smart Queue Management</h1>
                        <p style="font-size: clamp(1.125rem, 2vw, 1.5rem); color: var(--gray-600); margin-bottom: 2rem;">No more crowded entrances. Happy customers.</p>
                        <div class="grid grid-3 mb">
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üì±</div><h3>Digital Queue</h3><p style="color: var(--gray-600);">QR code entry</p></div>
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üì∫</div><h3>Live Display</h3><p style="color: var(--gray-600);">Real-time updates</p></div>
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div><h3>Analytics</h3><p style="color: var(--gray-600);">Track customer flow</p></div>
                        </div>
                        <button onclick="navigate('/signup')" class="btn btn-primary" style="font-size: 1.5rem; padding: 1.5rem 3rem;">Start Free Forever</button>
                        <p style="margin-top: 1rem; color: var(--gray-600);">500 customers/month free ‚Ä¢ No credit card</p>
                    </main>
                    <footer style="background: white; border-top: 2px solid var(--gray-200); padding: 2rem 0; margin-top: 4rem;">
                        <div class="container text-center">
                            <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button onclick="navigate('/terms')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; text-decoration: underline;">Terms</button>
                                <button onclick="navigate('/privacy')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; text-decoration: underline;">Privacy</button>
                                <a href="mailto:support@queueapp.com" style="color: var(--gray-600); text-decoration: underline;">Support</a>
                            </div>
                            <p style="color: var(--gray-500); font-size: 0.875rem;">¬© 2024 QueueApp</p>
                        </div>
                    </footer>
                </div>
            `);
        }

        // Pricing Page
        function showPricing() {
            const loggedIn = getLoggedInRestaurant();
            const restaurant = loggedIn?.data;
            const restaurantId = loggedIn?.id;
            const currentPlan = restaurant?.plan || 'free';
            const planStatus = restaurant?.planStatus || 'active';
            
            const navButtons = loggedIn 
                ? `<div class="flex gap-1 flex-wrap items-center">
                     <span style="font-weight: 600;">${restaurant.name}</span>
                     <span class="badge ${currentPlan === 'premium' ? 'badge-primary' : planStatus === 'pending' ? 'badge-warning' : 'badge-secondary'}">${planStatus === 'pending' ? 'PENDING' : currentPlan.toUpperCase()}</span>
                     <button onclick="navigate('/r/${restaurantId}/admin')" class="btn btn-secondary">Dashboard</button>
                     <button onclick="logout('${restaurantId}')" class="btn btn-danger">Logout</button>
                   </div>`
                : `<div class="nav-buttons"><button onclick="navigate('/login')" class="btn btn-secondary">Login</button><button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button></div>`;
            
            let premiumCTA = loggedIn && currentPlan === 'premium' && planStatus === 'active' 
                ? `<button class="btn btn-success w-full" disabled style="opacity: 0.7;">‚úì Current Plan</button>`
                : loggedIn && planStatus === 'pending'
                ? `<button class="btn btn-warning w-full" disabled style="opacity: 0.7;">‚è≥ Pending</button>`
                : loggedIn && currentPlan === 'free'
                ? `<button onclick="handleUpgrade('${restaurantId}')" class="btn w-full" style="background: white; color: var(--primary);">Upgrade Now</button>`
                : `<button onclick="navigate('/signup')" class="btn w-full" style="background: white; color: var(--primary);">Get Started</button>`;

            render(`
                <div class="bg-gradient" style="min-height: 100vh;">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1>${navButtons}</div></nav>
                    <div class="container" style="padding: 2rem 0;">
                        <div class="text-center mb"><h1>Simple Pricing</h1><p style="font-size: 1.25rem; color: var(--gray-600);">Start free. Upgrade anytime.</p></div>
                        <div class="grid grid-2" style="max-width: 1200px; margin: 0 auto;">
                            <div class="card">
                                <div class="text-center">
                                    <p style="color: var(--success); font-weight: 700; font-size: 0.875rem; margin-bottom: 1rem;">FREE FOREVER</p>
                                    <h3>Free</h3>
                                    <div style="font-size: 4rem; font-weight: 900; margin: 1rem 0;">‚Çπ0<span style="font-size: 1.5rem; color: var(--gray-600);">/mo</span></div>
                                    <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 2rem;">500 customers/month</p>
                                </div>
                                <div class="space-y">
                                    <p>‚úì Digital queue</p>
                                    <p>‚úì QR code entry</p>
                                    <p>‚úì Live display</p>
                                    <p>‚úì Basic analytics</p>
                                </div>
                            </div>
                            <div class="card bg-gradient-primary" style="transform: scale(1.05);">
                                <div class="text-center">
                                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">MOST POPULAR</p>
                                    <h3>Premium</h3>
                                    <div style="margin: 1rem 0;">
                                        <div style="font-size: 2rem; font-weight: 700; text-decoration: line-through; opacity: 0.6;">‚Çπ2,999</div>
                                        <div style="font-size: 4rem; font-weight: 900;">‚Çπ1,999<span style="font-size: 1.5rem; opacity: 0.8;">/mo</span></div>
                                    </div>
                                    <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 0.5rem 1rem; border-radius: 999px; margin-bottom: 1rem;">
                                        <span style="font-size: 0.875rem; font-weight: 700;">üéâ SAVE ‚Çπ1,000!</span>
                                    </div>
                                    <p style="opacity: 0.9; margin-bottom: 2rem;">Unlimited customers</p>
                                </div>
                                <div class="space-y">
                                    <p>‚úì Everything in Free</p>
                                    <p>‚úì Unlimited customers</p>
                                    <p>‚úì Advanced analytics</p>
                                    <p>‚úì Priority support</p>
                                </div>
                                <div class="mt">${premiumCTA}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // Payment Pages
        function showPaymentPage(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) { render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`); return; }

            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #faf5ff 0%, #eff6ff 100%); padding: 2rem;">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="display: inline-block; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white; padding: 0.75rem 2rem; border-radius: 999px; font-size: 1rem; font-weight: 700; animation: pulse 2s infinite; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);">
                                üéâ FIRST TIME OFFER - 33% OFF!
                            </div>
                        </div>
                        <h2>Upgrade to Premium</h2>
                        <p style="color: var(--gray-600);">${restaurant.name}</p>
                        <div class="card bg-gradient-primary text-center mb">
                            <p>Total Amount</p>
                            <div style="position: relative; display: inline-block;">
                                <div style="font-size: 3rem; font-weight: 900; text-decoration: line-through; opacity: 0.5;">‚Çπ2,999</div>
                                <div style="font-size: 6rem; font-weight: 900; color: white; text-shadow: 0 4px 12px rgba(0,0,0,0.2);">‚Çπ1,999</div>
                            </div>
                            <p style="opacity: 0.9;">per month ‚Ä¢ 30 days</p>
                            <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 0.5rem 1rem; border-radius: 999px; margin-top: 0.5rem;">
                                <span style="font-weight: 700;">üí∞ Save ‚Çπ1,000/month!</span>
                            </div>
                        </div>
                        <div class="card text-center" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border: 3px solid var(--primary);">
                            <div style="display: inline-block; background: var(--primary); color: white; padding: 0.5rem 1.5rem; border-radius: 999px; font-size: 0.875rem; font-weight: 700; margin-bottom: 1rem;">SECURED PAYMENT</div>
                            <p style="font-weight: 600; font-size: 1.25rem; color: var(--gray-700); margin-bottom: 0.5rem;">Pay to</p>
                            <p style="font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 1rem;">QueueApp</p>
                            <div style="background: white; display: inline-block; padding: 1rem; border-radius: 1rem; margin-bottom: 0.5rem;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">Amount: <span style="color: var(--success);">‚Çπ1,999</span></div>
                            </div>
                        </div>
                        <div class="card text-center" style="background: var(--gray-50);">
                            <p style="font-weight: 600; margin-bottom: 1rem;">Scan QR Code to Pay</p>
                            <div id="payment-qr" style="display: inline-block; padding: 1rem; background: white; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
                            <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 1rem;">Or pay directly with your UPI app</p>
                            <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem;">
                                <a href="upi://pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=1999&cu=INR&tn=QueueApp-Premium-Offer-${restaurantId}" class="btn" style="background: #5f259f; color: white; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üì±</span> PhonePe
                                </a>
                                <a href="tez://upi/pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=1999&cu=INR&tn=QueueApp-Premium-Offer-${restaurantId}" class="btn" style="background: #1a73e8; color: white; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üí≥</span> GPay
                                </a>
                                <a href="paytmmp://pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=1999&cu=INR&tn=QueueApp-Premium-Offer-${restaurantId}" class="btn" style="background: #00baf2; color: white; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üí∞</span> Paytm
                                </a>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 1rem;">Note: App buttons work on mobile only. Desktop users, please scan QR.</p>
                        </div>
                        <div class="alert alert-success" style="text-align: center;">
                            <p style="font-weight: 700; margin-bottom: 0.5rem;">‚è∞ Limited Time Offer!</p>
                            <p style="font-size: 0.875rem; margin: 0;">This special price is available for first-time Premium upgrades only</p>
                        </div>
                        <button onclick="navigate('/payment/${restaurantId}/upload')" class="btn btn-success w-full">I've Paid ‚Çπ1,999 ‚Üí Upload Screenshot</button>
                    </div>
                </div>
            `);

            setTimeout(() => {
                const upiString = `upi://pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=1999&cu=INR&tn=QueueApp-Premium-Offer-${restaurantId}`;
                new QRCode(document.getElementById('payment-qr'), { text: upiString, width: 200, height: 200 });
            }, 100);
        }

        function showUploadScreenshot(restaurantId) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 2rem;">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h2 class="text-center">Upload Payment Proof</h2>
                        <div class="space-y">
                            <input type="text" id="transactionId" placeholder="Transaction ID / UTR">
                            <div class="card text-center" style="border: 2px dashed var(--gray-200); cursor: pointer;" onclick="document.getElementById('screenshotFile').click()">
                                <input type="file" id="screenshotFile" accept="image/*" onchange="previewScreenshot()" class="hidden">
                                <button type="button" class="btn btn-primary" style="pointer-events: none;">üì∑ Choose Screenshot</button>
                            </div>
                            <div id="screenshotPreview" class="hidden mt">
                                <img id="previewImage" class="w-full" style="border: 2px solid var(--gray-200); border-radius: 1rem;" />
                            </div>
                            <button onclick="submitPaymentProof('${restaurantId}')" class="btn btn-success w-full">Submit</button>
                        </div>
                    </div>
                </div>
            `);
        }

        function previewScreenshot() {
            const file = document.getElementById('screenshotFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('screenshotPreview').classList.remove('hidden');
                    document.getElementById('previewImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function submitPaymentProof(restaurantId) {
            const transactionId = document.getElementById('transactionId').value.trim();
            const fileInput = document.getElementById('screenshotFile');
            if (!transactionId || !fileInput.files[0]) { alert('‚ö†Ô∏è Fill all fields'); return; }

            const reader = new FileReader();
            reader.onload = async function(e) {
                // Generate unique internal transaction ID for audit
                const internalTxnId = 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                // Get restaurant details for audit
                const restaurant = DB.restaurants[restaurantId];
                
                // Comprehensive audit data
                const auditData = {
                    // Transaction IDs
                    internalTransactionId: internalTxnId,
                    utrNumber: transactionId,
                    
                    // Payment details
                    screenshot: e.target.result,
                    amount: 1999,
                    currency: 'INR',
                    paymentMethod: 'UPI',
                    
                    // Customer details (from existing data)
                    customerDetails: {
                        restaurantId: restaurantId,
                        restaurantName: restaurant?.name || 'N/A',
                        ownerName: restaurant?.owner || 'N/A',
                        email: restaurant?.email || 'N/A',
                        phone: restaurant?.phone || 'N/A',
                        city: restaurant?.city || 'N/A'
                    },
                    
                    // Timestamps
                    uploadedAt: new Date().toISOString(),
                    uploadedTimestamp: Date.now(),
                    
                    // Status tracking
                    status: 'pending',
                    
                    // Audit trail
                    auditTrail: [{
                        action: 'payment_proof_uploaded',
                        timestamp: new Date().toISOString(),
                        by: 'restaurant_owner',
                        details: 'Payment proof submitted for verification'
                    }]
                };
                
                await FirebaseDB.savePaymentProof(restaurantId, auditData);
                DB.savePaymentProof(restaurantId, auditData);
                alert('‚úÖ Submitted! Verification takes 2-24 hours.\n\nTransaction ID: ' + internalTxnId);
                navigate(`/r/${restaurantId}/admin`);
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        
        function handleUpgrade(restaurantId) { navigate(`/payment/${restaurantId}`); }
        
        // Auth Pages
        function showLogin() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Restaurant Login</h2>
                        <div class="space-y">
                            <input type="text" id="loginRestaurantId" placeholder="Restaurant ID">
                            <input type="tel" id="loginPhone" placeholder="Phone" maxlength="10">
                            <button onclick="handleLogin(event)" class="btn btn-primary w-full">Login</button>
                            <p class="text-center" style="font-size: 0.875rem;">No account? <button onclick="navigate('/signup')" style="background: none; border: none; color: var(--primary); font-weight: 600; text-decoration: underline; cursor: pointer;">Sign Up</button></p>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function handleLogin(event) {
            const restaurantId = document.getElementById('loginRestaurantId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            if (!restaurantId || !phone) { alert('‚ö†Ô∏è Fill all fields'); return; }
            
            const btn = event.target;
            btn.textContent = 'Logging in...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseDB.getRestaurant(restaurantId);
                
                if (result.success && result.data.phone === phone) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    DB.restaurants[restaurantId] = result.data;
                    DB.save();
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else if (DB.login(restaurantId, phone)) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else {
                    alert('‚ùå Invalid credentials');
                    btn.textContent = 'Login';
                    btn.disabled = false;
                }
            } catch (error) {
                if (DB.login(restaurantId, phone)) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else {
                    alert(`‚ùå Error: ${error.message}`);
                    btn.textContent = 'Login';
                    btn.disabled = false;
                }
            }
        }
        
        function showRestaurantLogin(restaurantId) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Login Required</h2>
                        <input type="tel" id="restaurantLoginPhone" placeholder="Phone" maxlength="10">
                        <button onclick="handleRestaurantLogin('${restaurantId}')" class="btn btn-primary w-full mt">Login</button>
                    </div>
                </div>
            `);
        }
        
        function handleRestaurantLogin(restaurantId) {
            const phone = document.getElementById('restaurantLoginPhone').value.trim();
            if (!phone) { alert('Enter phone'); return; }
            if (DB.login(restaurantId, phone)) { 
                sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true'); 
                handleRoute(); 
            } else { 
                alert('‚ùå Invalid'); 
            }
        }
        
        function showSignup() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 700px; width: 100%;">
                        <h2 class="text-center mb">Register Restaurant</h2>
                        <div class="space-y">
                            <input type="text" id="restaurantName" placeholder="Restaurant Name">
                            <input type="text" id="ownerName" placeholder="Owner Name">
                            <input type="email" id="email" placeholder="Email">
                            <input type="tel" id="phone" placeholder="Phone (10 digits)" maxlength="10">
                            <input type="text" id="city" placeholder="Location (e.g., Mumbai - Andheri)">
                            <div class="flex gap-1">
                                <input type="checkbox" id="agreeTerms">
                                <label for="agreeTerms" style="font-size: 0.875rem;">I agree to Terms & Privacy</label>
                            </div>
                            <button onclick="handleSignup(event)" class="btn btn-primary w-full">Register</button>
                            <p class="text-center" style="font-size: 0.875rem;">Have account? <button onclick="navigate('/login')" style="background: none; border: none; color: var(--primary); font-weight: 600; text-decoration: underline; cursor: pointer;">Login</button></p>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function handleSignup(event) {
            const name = document.getElementById('restaurantName').value.trim();
            const owner = document.getElementById('ownerName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const city = document.getElementById('city').value.trim();
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            if (!name || !owner || !email || !phone || !city) { alert('‚ö†Ô∏è Fill all fields'); return; }
            if (!agreeTerms) { alert('‚ö†Ô∏è Agree to terms'); return; }
            
            const btn = event.target;
            btn.textContent = 'Registering...';
            btn.disabled = true;
            
            try {
                const restaurantId = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X') + Math.floor(Math.random() * 10000);
                const result = await FirebaseDB.addRestaurant(restaurantId, { name, owner, email, phone, city });
                
                if (result.success) {
                    DB.addRestaurant(restaurantId, { name, owner, email, phone, city });
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    alert(`‚úÖ Success! ID: ${restaurantId}\n\nFREE plan: 500/month\n\nSave your ID!`);
                    navigate(`/r/${restaurantId}/admin`);
                } else {
                    alert(`‚ùå Failed: ${result.error}`);
                    btn.textContent = 'Register';
                    btn.disabled = false;
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                btn.textContent = 'Register';
                btn.disabled = false;
            }
        }
        
        // Customer Queue
        async function showJoinQueue(restaurantId) {
            let restaurant = DB.restaurants[restaurantId];
            
            // Only fetch from Firebase if restaurant doesn't exist in localStorage (rare case)
            if (!restaurant) {
                const result = await FirebaseDB.getRestaurant(restaurantId);
                if (result.success) {
                    restaurant = result.data;
                    DB.restaurants[restaurantId] = restaurant;
                    DB.save();
                    console.log('üì• Fetched restaurant from Firebase (1 read)');
                } else {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Restaurant Not Found</h1><button onclick="navigate('/')" class="btn btn-primary mt">Go Home</button></div>`);
                    return;
                }
            }
            
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Join Queue</h2>
                        <p class="text-center mb" style="color: var(--gray-600);">${restaurant.name}</p>
                        <div class="space-y">
                            <input type="text" id="customerName" placeholder="Your Name">
                            <input type="tel" id="customerPhone" placeholder="Mobile" maxlength="10">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Guests</label>
                                <div class="grid grid-4">${[1,2,3,4,5,6,7,8].map(n => `<button onclick="selectGuests(${n})" id="guest-${n}" class="btn ${n === 2 ? 'btn-primary' : 'btn-secondary'}">${n}</button>`).join('')}</div>
                            </div>
                            <button onclick="handleJoinQueue('${restaurantId}')" class="btn btn-primary w-full">Join Queue</button>
                        </div>
                    </div>
                </div>
            `);
            window.selectedGuests = 2;
        }
        
        function selectGuests(n) {
            window.selectedGuests = n;
            document.querySelectorAll('[id^="guest-"]').forEach(btn => btn.className = 'btn btn-secondary');
            document.getElementById(`guest-${n}`).className = 'btn btn-primary';
        }
        
        async function handleJoinQueue(restaurantId) {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const guests = window.selectedGuests || 2;
            if (!name || !phone) { alert('‚ö†Ô∏è Fill all fields'); return; }
            
            const btn = event.target;
            btn.textContent = 'Joining...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseDB.addToQueue(restaurantId, { name, phone, guests });
                
                if (result.success) {
                    // Update local storage with the SAME queue number from Firebase
                    const restaurant = DB.restaurants[restaurantId];
                    if (restaurant) {
                        const today = new Date().toISOString().slice(0, 10);
                        const currentMonth = new Date().toISOString().slice(0, 7);
                        
                        // Initialize analytics if needed
                        if (!restaurant.analytics) {
                            restaurant.analytics = { 
                                currentMonth, 
                                customersThisMonth: 0, 
                                lastResetDate: today, 
                                dailyStats: {} 
                            };
                        }
                        
                        // Add queue item with Firebase queue number
                        restaurant.queue.push({ 
                            name, 
                            phone, 
                            guests,
                            queueNumber: result.queueNumber,  // Use Firebase queue number
                            status: 'waiting', 
                            joinedAt: new Date().toISOString() 
                        });
                        
                        // Update analytics
                        restaurant.analytics.customersThisMonth += 1;
                        restaurant.analytics.dailyStats[today] = (restaurant.analytics.dailyStats[today] || 0) + 1;
                        
                        DB.save();
                    }
                    
                    // Show success with loading before navigating to status
                    showLoadingSuccess(restaurantId, result.queueNumber, result.customersThisMonth, result.limit);
                } else if (result.error === 'LIMIT_REACHED') {
                    showUpgradeModal(restaurantId, result);
                    btn.textContent = 'Join Queue';
                    btn.disabled = false;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                btn.textContent = 'Join Queue';
                btn.disabled = false;
            }
        }
        
        function showLoadingSuccess(restaurantId, queueNumber, customersThisMonth, limit) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <div style="font-size: 8rem; margin-bottom: 2rem; animation: pulse 1.5s infinite;">‚úÖ</div>
                        <h1 style="margin-bottom: 2rem; font-size: 3rem;">You're In!</h1>
                        <div class="card" style="background: white; color: var(--gray-900); max-width: 500px; margin: 0 auto 2rem;">
                            <div style="font-size: 6rem; font-weight: 900; color: var(--success); margin-bottom: 1rem;">${queueNumber}</div>
                            <p style="font-size: 1.5rem; font-weight: 600;">Your Queue Number</p>
                            ${limit !== 'unlimited' ? `<p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 1rem;">Usage: ${customersThisMonth}/${limit} this month</p>` : ''}
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 1.5rem; border-radius: 1rem; max-width: 500px; margin: 0 auto;">
                            <p style="font-size: 1.25rem; margin-bottom: 1rem;">üì∫ Watch the display for your number</p>
                            <p style="font-size: 1rem; opacity: 0.9;">Loading your status in <span id="countdown" style="font-weight: 900;">3</span> seconds...</p>
                        </div>
                    </div>
                </div>
            `);
            
            let seconds = 3;
            const countdownInterval = setInterval(() => {
                seconds--;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) countdownEl.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    navigate(`/r/${restaurantId}/status/${queueNumber}`);
                }
            }, 1000);
        }
        
        function showUpgradeModal(restaurantId, result) {
            render(`
                <div style="min-height: 100vh; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 600px; border: 3px solid var(--warning);">
                        <div class="text-center">
                            <div style="font-size: 5rem;">üö´</div>
                            <h2 style="color: var(--warning); margin: 1rem 0;">Monthly Limit Reached</h2>
                            <p style="font-size: 1.25rem; margin-bottom: 1rem;">Free plan limit of <strong>500 customers/month</strong> reached.</p>
                            <div class="card" style="background: #fef9c3; margin: 2rem 0;">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--warning);">${result.customersUsed} / ${result.limit}</div>
                                <p>Customers this month</p>
                            </div>
                            <p style="margin-bottom: 2rem; color: var(--gray-600);">Restaurant needs Premium for unlimited customers.</p>
                            <div class="flex gap-1" style="justify-content: center;">
                                <button onclick="navigate('/r/${restaurantId}/join')" class="btn btn-secondary">‚Üê Back</button>
                                <button onclick="navigate('/pricing')" class="btn btn-primary">Learn More</button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function showQueueStatus(restaurantId, queueNumber) {
            // Show loading first
            render(`
                <div style="min-height: 100vh; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">‚è≥</div>
                        <h2>Loading your queue status...</h2>
                    </div>
                </div>
            `);
            
            // Wait for 3-second countdown to complete + extra 500ms buffer
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Try local storage first (most common case - no Firebase read)
            let restaurant = DB.restaurants[restaurantId];
            let myQueue = restaurant?.queue.find(q => q.queueNumber === queueNumber);
            
            // Only fetch from Firebase if absolutely necessary (1 read maximum)
            if (!myQueue) {
                const result = await FirebaseDB.getRestaurant(restaurantId);
                if (result.success) {
                    restaurant = result.data;
                    DB.restaurants[restaurantId] = restaurant;
                    DB.save();
                    myQueue = restaurant.queue.find(q => q.queueNumber === queueNumber);
                } else {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1>Restaurant Not Found</h1><button onclick="navigate('/')" class="btn btn-primary mt">Go Home</button></div>`);
                    return;
                }
            }
            
            if (!myQueue) { 
                render(`<div class="container text-center" style="padding-top: 4rem;">
                    <h1>Queue Number Not Found</h1>
                    <p style="color: var(--gray-600); margin: 2rem 0;">Queue #${queueNumber} not found. It may have been served or the queue was reset.</p>
                    <button onclick="navigate('/r/${restaurantId}/join')" class="btn btn-primary mt">Join Queue Again</button>
                    <button onclick="navigate('/r/${restaurantId}/display')" class="btn btn-secondary mt">View Display</button>
                </div>`); 
                return; 
            }
            
            if (myQueue.status === 'allocated') {
                render(`<div style="min-height: 100vh; background: var(--success); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <h1 style="margin-bottom: 2rem;">üéâ Table Ready!</h1>
                        <div class="card" style="background: white; color: var(--gray-900);">
                            <div style="font-size: 12rem; font-weight: 900; color: var(--success);">${myQueue.tableNo}</div>
                            <p style="font-size: 2rem; margin-bottom: 1rem;">Queue: ${queueNumber}</p>
                            <div style="padding: 1rem; background: var(--gray-50); border-radius: 1rem; margin-top: 1rem;">
                                <p style="font-size: 1.5rem; font-weight: 600; color: var(--gray-700);">${myQueue.name}</p>
                                <p style="font-size: 1rem; color: var(--gray-600);">${myQueue.guests} guest${myQueue.guests !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                    </div>
                </div>`);
            } else {
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const position = waiting.findIndex(q => q.queueNumber === queueNumber) + 1;
                render(`<div style="min-height: 100vh; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <h1 style="margin-bottom: 2rem;">Still in Queue</h1>
                        <div class="card" style="background: white; color: var(--gray-900);">
                            <div style="font-size: 12rem; font-weight: 900; color: var(--primary);">${queueNumber}</div>
                            <p style="font-size: 2rem; margin-bottom: 1rem;">Position: #${position}</p>
                            <div style="padding: 1rem; background: var(--gray-50); border-radius: 1rem; margin-top: 1rem;">
                                <p style="font-size: 1.5rem; font-weight: 600; color: var(--gray-700);">${myQueue.name}</p>
                                <p style="font-size: 1rem; color: var(--gray-600);">${myQueue.guests} guest${myQueue.guests !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <button onclick="navigate('/r/${restaurantId}/display')" class="btn btn-primary mt" style="background: white; color: var(--primary);">View Display</button>
                    </div>
                </div>`);
            }
        }
        
        // TV Display - Real-time
        let displayUnsubscribe = null;
        
        async function showDisplay(restaurantId) {
            if (displayUnsubscribe) displayUnsubscribe();
            
            displayUnsubscribe = db.collection('restaurants').doc(restaurantId).onSnapshot((doc) => {
                if (!doc.exists) {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`);
                    return;
                }
                
                const restaurant = doc.data();
                DB.restaurants[restaurantId] = restaurant;
                DB.save();
                
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const allocated = restaurant.queue.filter(q => q.status === 'allocated');
                const justCalled = allocated.slice(-3);
                
                render(`
                    <div class="display-screen" style="position: relative;">
                        <div style="position: fixed; top: 2rem; right: 2rem; z-index: 1000; max-width: 350px;">
                            <div style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding: 2rem; border-radius: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 5px solid var(--primary);">
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <div style="font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; animation: pulse-badge 1.5s infinite;">üëâ SCAN HERE üëà</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem;">Welcome! üéâ</div>
                                    <div style="font-size: 1.1rem; color: var(--gray-700); line-height: 1.4;">Join our queue instantly with your phone</div>
                                </div>
                                <div style="background: white; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: relative;">
                                    <div id="display-qr" style="background: white;"></div>
                                </div>
                                <div style="text-align: center; margin-top: 1rem;">
                                    <div style="font-size: 1.3rem; color: var(--primary); font-weight: 700;">üì± Open Camera & Scan</div>
                                    <div style="font-size: 1rem; color: var(--gray-600); margin-top: 0.3rem;">No app needed!</div>
                                </div>
                            </div>
                        </div>
                        <div class="container">
                            <div class="text-center mb" style="padding-bottom: 2rem; border-bottom: 4px solid var(--primary);">
                                <h1 style="color: var(--primary);">${restaurant.name}</h1>
                                <p style="font-size: 2rem; color: rgba(255,255,255,0.7);">Queue Management</p>
                                <div style="font-size: 3rem; color: var(--primary); font-weight: 700; margin-top: 0.5rem;">${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                                <div style="font-size: 1.25rem; color: #10b981; margin-top: 0.5rem;">üî• Live</div>
                            </div>
                            
                            ${justCalled.length > 0 ? `
                            <div class="card mb" style="background: linear-gradient(135deg, rgba(22, 163, 74, 0.9), rgba(21, 128, 61, 0.9)); border: 4px solid var(--success); padding: 4rem;">
                                <h2 class="text-center" style="font-size: 5rem; margin-bottom: 2rem;"><span style="font-size: 8rem; animation: pulse 2s infinite;">üîî</span>NOW SERVING</h2>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                    ${justCalled.map(a => `
                                        <div class="card text-center" style="background: white; padding: 4rem; border: 4px solid white;">
                                            <div style="font-size: 12rem; font-weight: 900; color: var(--success); line-height: 1;">${a.queueNumber}</div>
                                            <div style="font-size: 6rem; font-weight: 800; color: var(--gray-900);">Table ${a.tableNo}</div>
                                            <div style="font-size: 3rem; color: var(--gray-600);">${a.guests} ${a.guests === 1 ? 'guest' : 'guests'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : `<div class="card text-center mb" style="background: rgba(55, 65, 81, 0.5); padding: 4rem;"><p style="font-size: 4rem; color: rgba(255,255,255,0.6);">‚è≥ Waiting...</p></div>`}
                            
                            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                                <div class="card" style="background: rgba(249, 115, 22, 0.2); border: 3px solid var(--primary); padding: 3rem;">
                                    <h2 class="text-center" style="color: var(--primary); margin-bottom: 2rem; font-size: 4rem;">‚è≥ Waiting (${waiting.length})</h2>
                                    <div style="max-height: 60vh; overflow-y: auto;"><div class="space-y">
                                        ${waiting.length > 0 ? waiting.slice(0, 15).map((w, i) => `
                                            <div class="card" style="background: ${i < 3 ? 'rgba(249, 115, 22, 0.9)' : 'rgba(55, 65, 81, 0.8)'}; padding: 2rem; border: ${i < 3 ? '3px solid var(--primary)' : '2px solid rgba(156, 163, 175, 0.3)'};">
                                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 6rem; font-weight: 900; color: ${i < 3 ? '#ffffff' : 'var(--primary)'};">${w.queueNumber}</div>
                                                        ${i < 3 ? '<div style="font-size: 1.5rem; color: #fef9c3; font-weight: 700;">üîú NEXT</div>' : ''}
                                                        <div style="font-size: 1.8rem; font-weight: 600; color: ${i < 3 ? '#ffffff' : 'rgba(255,255,255,0.9)'}; margin-top: 0.5rem;">${w.name}</div>
                                                        <div style="font-size: 1.3rem; color: ${i < 3 ? 'rgba(255,255,255,0.8)' : 'rgba(255,255,255,0.6)'}; font-family: monospace;">${w.phone}</div>
                                                        <div style="font-size: 1.5rem; color: ${i < 3 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)'}; margin-top: 0.3rem;">${w.guests} guest${w.guests !== 1 ? 's' : ''}</div>
                                                    </div>
                                                    <div style="text-align: right;">
                                                        <div style="font-size: 5rem; font-weight: 900; color: ${i < 3 ? '#ffffff' : 'rgba(255,255,255,0.7)'};">#${i + 1}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') : '<p class="text-center" style="color: rgba(255,255,255,0.6); font-size: 2rem; padding: 2rem;">No customers</p>'}
                                    </div></div>
                                </div>
                                
                                <div class="card" style="background: rgba(168, 85, 247, 0.2); border: 3px solid #9333ea; padding: 3rem;">
                                    <h2 class="text-center" style="color: #c084fc; margin-bottom: 2rem; font-size: 3rem;">üìä Stats</h2>
                                    <div class="grid grid-2" style="gap: 2rem;">
                                        <div class="card text-center" style="background: rgba(255, 255, 255, 0.1); padding: 2rem;">
                                            <div style="font-size: 7rem; font-weight: 900; color: var(--primary);">${waiting.length}</div>
                                            <div style="font-size: 1.5rem; color: white; margin-top: 0.5rem;">Waiting</div>
                                        </div>
                                        <div class="card text-center" style="background: rgba(255, 255, 255, 0.1); padding: 2rem;">
                                            <div style="font-size: 7rem; font-weight: 900; color: var(--success);">${allocated.length}</div>
                                            <div style="font-size: 1.5rem; color: white; margin-top: 0.5rem;">Seated</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt" style="padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.2);"><p style="font-size: 2rem; color: rgba(255,255,255,0.5);">‚ö° QueueApp</p></div>
                        </div>
                    </div>
                `);
                
                // Generate QR Code for display after render
                setTimeout(() => generateQRCode('display-qr', restaurantId), 100);
            });
        }
        
        // Restaurant Admin - Real-time with QR Code
        let adminUnsubscribe = null;
        
        async function showRestaurantAdmin(restaurantId) {
            if (adminUnsubscribe) adminUnsubscribe();
            
            adminUnsubscribe = db.collection('restaurants').doc(restaurantId).onSnapshot(async (doc) => {
                if (!doc.exists) {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`);
                    return;
                }
                
                const restaurant = doc.data();
                DB.restaurants[restaurantId] = restaurant;
                DB.save();
                
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const allocated = restaurant.queue.filter(q => q.status === 'allocated');
                
                // Get analytics
                const analyticsResult = await FirebaseDB.getAnalytics(restaurantId);
                const analytics = analyticsResult.success ? analyticsResult.analytics : {};
                const customersThisMonth = analytics.customersThisMonth || 0;
                const limit = restaurant.plan === 'free' ? 500 : 'unlimited';
                const percentage = restaurant.plan === 'free' ? Math.round((customersThisMonth / 500) * 100) : 0;
                
                const currentPlan = restaurant.plan || 'free';
                const planStatus = restaurant.planStatus || 'active';
                const planBadge = `<span class="badge ${currentPlan === 'premium' && planStatus === 'active' ? 'badge-primary' : planStatus === 'pending' ? 'badge-warning' : planStatus === 'rejected' ? 'badge badge-danger' : 'badge-secondary'}">${planStatus === 'pending' ? 'PENDING' : planStatus === 'rejected' ? 'REJECTED' : currentPlan.toUpperCase()}</span>`;
                
                const today = new Date().toISOString().slice(0, 10);
                const todayFormatted = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                render(`
                    <div style="min-height: 100vh; background: var(--gray-100); padding: 2rem;">
                        <div class="container">
                            <div class="card mb flex justify-between items-center flex-wrap gap-1">
                                <div>
                                    <h1 onclick="navigateHome()" style="cursor: pointer;">QueueApp</h1>
                                    <p style="color: var(--gray-600);">${restaurant.name} ${planBadge}</p>
                                    <p style="color: #10b981; font-size: 0.875rem;">üî• Live</p>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="navigate('/pricing')" class="btn" style="background: #2563eb; color: white;">${currentPlan === 'free' && planStatus !== 'pending' ? 'Upgrade' : 'Plan'}</button>
                                    <button onclick="logout('${restaurantId}')" class="btn btn-danger">Logout</button>
                                </div>
                            </div>
                            
                            ${planStatus === 'pending' ? `
                                <div class="alert alert-warning mb">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="font-size: 2rem;">‚è≥</div>
                                        <div style="flex: 1;">
                                            <p style="font-weight: 700; margin-bottom: 0.25rem;">Premium Upgrade Pending Review</p>
                                            <p style="font-size: 0.875rem; margin: 0;">Your payment is being verified. This usually takes 2-24 hours.</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${planStatus === 'rejected' && restaurant.paymentProof?.rejectionReason ? `
                                <div class="alert alert-danger mb">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="font-size: 2rem;">‚ùå</div>
                                        <div style="flex: 1;">
                                            <p style="font-weight: 700; margin-bottom: 0.5rem;">Premium Upgrade Rejected</p>
                                            <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Reason:</strong> ${restaurant.paymentProof.rejectionReason}</p>
                                            <p style="font-size: 0.875rem; margin: 0;">Please contact support@queueapp.com or try upgrading again.</p>
                                        </div>
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <button onclick="navigate('/pricing')" class="btn btn-primary">Try Again</button>
                                        <a href="mailto:support@queueapp.com?subject=Payment Rejection - ${restaurantId}&body=My payment was rejected. Transaction ID: ${restaurant.paymentProof?.transactionId || 'N/A'}" class="btn btn-secondary" style="margin-left: 0.5rem;">Contact Support</a>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${currentPlan === 'premium' && planStatus === 'active' && restaurant.planExpiryDate && (restaurant.planExpiryDate - Date.now()) > 0 ? `
                                <div class="alert alert-success mb">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="font-size: 2rem;">‚úÖ</div>
                                        <div style="flex: 1;">
                                            <p style="font-weight: 700; margin-bottom: 0.25rem;">Premium Plan Active</p>
                                            <p style="font-size: 0.875rem; margin: 0;">Enjoy unlimited customers! Plan expires on ${new Date(restaurant.planExpiryDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="alert alert-info mb">
                                <div class="flex justify-between items-center flex-wrap gap-1">
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">üìÖ Your Queue QR Code</div>
                                        <p style="margin: 0;">${todayFormatted}</p>
                                        <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">üîÑ Queue resets at midnight daily</p>
                                    </div>
                                    <div style="position: relative;">
                                        <div class="qr-container">
                                            <div id="daily-qr"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-1 mt" style="flex-wrap: wrap;">
                                    <button onclick="printQRCode()" class="btn btn-secondary">üñ®Ô∏è Print QR</button>
                                    <button onclick="downloadQRCode('${restaurantId}')" class="btn btn-secondary">üíæ Download QR</button>
                                    <button onclick="copyQRLink('${restaurantId}')" class="btn" style="background: #2563eb; color: white;">üîó Copy Link</button>
                                </div>
                                <div class="mt">
                                    <p style="font-size: 0.875rem; color: #1e40af; font-weight: 600;">üí° How to use:</p>
                                    <ol style="font-size: 0.875rem; color: #1e40af; margin-left: 1.5rem;">
                                        <li>Print/display this QR at your entrance</li>
                                        <li>Customers scan to join queue instantly</li>
                                        <li>Queue resets daily at midnight automatically</li>
                                    </ol>
                                </div>
                            </div>
                            
                            ${restaurant.plan === 'free' ? `
                            <div class="card mb" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                                <h2 style="margin-bottom: 1rem;">üìä Monthly Usage</h2>
                                <div class="grid grid-3">
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: ${percentage > 80 ? 'var(--danger)' : 'var(--primary)'};">${customersThisMonth}</div>
                                        <p style="color: var(--gray-600);">This Month</p>
                                    </div>
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: var(--gray-600);">${limit}</div>
                                        <p style="color: var(--gray-600);">Limit</p>
                                    </div>
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: ${percentage > 80 ? 'var(--danger)' : 'var(--success)'};">${500 - customersThisMonth}</div>
                                        <p style="color: var(--gray-600);">Remaining</p>
                                    </div>
                                </div>
                                <div class="progress-bar mt">
                                    <div class="progress-fill" style="background: ${percentage > 80 ? 'var(--danger)' : 'var(--success)'}; width: ${percentage}%;">${percentage}%</div>
                                </div>
                                ${percentage > 80 ? '<div class="alert alert-warning mt">‚ö†Ô∏è Approaching limit! <button onclick="navigate(\'/pricing\')" class="btn btn-primary" style="margin-left: 1rem;">Upgrade</button></div>' : ''}
                            </div>
                            ` : ''}
                            
                            <div class="grid grid-2 mb">
                                <div class="card" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);">
                                    <div style="font-size: 3rem; font-weight: 900; color: var(--primary);">${waiting.length}</div>
                                    <p style="color: var(--gray-600);">Waiting</p>
                                </div>
                                <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                    <div style="font-size: 3rem; font-weight: 900; color: var(--success);">${allocated.length}</div>
                                    <p style="color: var(--gray-600);">Seated</p>
                                </div>
                            </div>
                            
                            <div class="card mb">
                                <h2 style="margin-bottom: 1rem;">Waiting Queue</h2>
                                <div class="space-y">
                                    ${waiting.length > 0 ? waiting.map(w => `
                                        <div class="card flex justify-between items-center flex-wrap gap-1" style="background: var(--gray-50);">
                                            <div>
                                                <div style="font-size: 1.5rem; font-weight: 700;">${w.queueNumber}</div>
                                                <p style="color: var(--gray-600);">${w.name} ‚Ä¢ ${w.phone} ‚Ä¢ ${w.guests} guests</p>
                                            </div>
                                            <div class="flex gap-1 items-center">
                                                <input type="number" id="table-${w.queueNumber}" placeholder="Table #" style="width: 100px;" min="1">
                                                <button onclick="allocateTable('${restaurantId}', '${w.queueNumber}')" class="btn btn-success">Seat</button>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-center" style="color: var(--gray-600); padding: 2rem;">No customers</p>'}
                                </div>
                            </div>
                            
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="navigate('/r/${restaurantId}/display')" class="btn" style="background: #2563eb; color: white;">üì∫ Display</button>
                                <button onclick="navigate('/r/${restaurantId}/join')" class="btn" style="background: #9333ea; color: white;">üì± Customer Entry</button>
                            </div>
                        </div>
                    </div>
                `);
                
                // Generate QR Code after render
                setTimeout(() => generateQRCode('daily-qr', restaurantId), 100);
            });
        }
        
        function copyQRLink(restaurantId) {
            const qrUrl = getTodayQRCode(restaurantId);
            navigator.clipboard.writeText(qrUrl).then(() => {
                alert('‚úÖ Link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link:', qrUrl);
            });
        }
        
        async function allocateTable(restaurantId, queueNumber) {
            const tableNo = document.getElementById(`table-${queueNumber}`).value;
            if (!tableNo || tableNo < 1) { alert('‚ö†Ô∏è Enter valid table'); return; }
            
            try {
                const result = await FirebaseDB.allocateTable(restaurantId, queueNumber, tableNo);
                if (result.success) {
                    DB.allocateTable(restaurantId, queueNumber, tableNo);
                    alert(`‚úÖ Table ${tableNo} allocated!`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function logout(restaurantId) {
            sessionStorage.removeItem(`loggedIn_${restaurantId}`);
            alert('‚úÖ Logged out');
            navigate('/');
        }
        
        // Platform Admin
        function showAdminPasswordPrompt() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #111827 0%, #1f2937 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">üîê Admin Login</h2>
                        <div class="space-y">
                            <input type="email" id="adminEmail" placeholder="Email" autocomplete="email">
                            <input type="password" id="adminPassword" placeholder="Password" autocomplete="current-password">
                            <button onclick="firebaseAdminLogin(event)" class="btn w-full" style="background: var(--gray-900); color: white;">Sign In</button>
                            <div id="adminLoginError" class="hidden alert alert-warning"></div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function firebaseAdminLogin(event) {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const errorDiv = document.getElementById('adminLoginError');
            
            if (!email || !password) {
                errorDiv.textContent = '‚ö†Ô∏è Enter email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const btn = event.target;
            btn.textContent = 'Signing in...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseAdmin.signIn(email, password);
                if (result.success) {
                    sessionStorage.setItem('adminAuth', 'yes');
                    sessionStorage.setItem('adminEmail', result.user.email);
                    window.location.hash = '/admin';
                    setTimeout(handleRoute, 100);
                } else {
                    errorDiv.textContent = `‚ùå ${result.error}`;
                    errorDiv.classList.remove('hidden');
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                }
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
                btn.textContent = 'Sign In';
                btn.disabled = false;
            }
        }
        
        function checkFirebaseAdminAuth() {
            return FirebaseAdmin.getCurrentUser() && sessionStorage.getItem('adminAuth') === 'yes';
        }
        
        // Global listener cleanup
        let platformAdminListener = null;
        
        async function showPlatformAdmin() {
            // Show loading first
            render(`
                <div style="min-height: 100vh; background: var(--gray-100); display: flex; align-items: center; justify-content: center;">
                    <div class="text-center">
                        <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">üìä</div>
                        <h2>Loading Platform Data...</h2>
                        <p style="color: var(--gray-600); margin-top: 0.5rem;">Setting up real-time sync...</p>
                    </div>
                </div>
            `);
            
            // Clean up old listener if exists
            if (platformAdminListener) {
                platformAdminListener();
                platformAdminListener = null;
            }
            
            // Set up real-time listener for ALL restaurants
            platformAdminListener = db.collection('restaurants').onSnapshot((snapshot) => {
                const updateTime = new Date().toLocaleTimeString();
                console.log(`üîÑ Platform admin: Real-time update at ${updateTime} (${snapshot.docs.length} restaurants)`);
                
                // Update localStorage with latest data
                snapshot.docs.forEach(doc => {
                    DB.restaurants[doc.id] = doc.data();
                });
                DB.save();
                
                // Re-render dashboard with updated data
                renderPlatformAdminDashboard();
            }, (error) => {
                console.error('‚ùå Real-time listener error:', error);
                alert('‚ö†Ô∏è Real-time sync error. Please refresh the page.');
            });
            
            console.log('‚úÖ Real-time listener set up for platform admin at', new Date().toLocaleTimeString());
        }
        
        function renderPlatformAdminDashboard() {
            const restaurants = Object.entries(DB.restaurants);
            const pendingPayments = restaurants.filter(([_, r]) => r.planStatus === 'pending');
            const totalCustomers = restaurants.reduce((sum, [_, r]) => sum + (r.queue?.length || 0), 0);
            const totalRevenue = restaurants.filter(([_, r]) => r.plan === 'premium' && r.planStatus === 'active').length * 1999;
            
            render(`
                <div style="min-height: 100vh; background: var(--gray-100); padding: 2rem;">
                    <div class="container">
                        <div class="card mb flex justify-between items-center flex-wrap">
                            <div>
                                <h1>üè¢ Platform Admin</h1>
                                <p style="color: var(--gray-600);">Manage all restaurants</p>
                                <p style="color: #10b981; font-size: 0.875rem;">
                                    <span style="display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; margin-right: 0.5rem;"></span>
                                    Live Sync Active ‚Ä¢ Auto-updates
                                </p>
                            </div>
                            <button onclick="adminLogout()" class="btn btn-danger">Logout</button>
                        </div>
                        
                        <div class="grid grid-4 mb">
                            <div class="card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: #2563eb;">${restaurants.length}</div>
                                <p>Restaurants</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--success);">${totalCustomers}</div>
                                <p>Customers</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: #9333ea;">‚Çπ${totalRevenue.toLocaleString()}</div>
                                <p>Revenue</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--warning);">${pendingPayments.length}</div>
                                <p>Pending</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mb" style="text-align: center;">
                            <p style="font-size: 0.875rem; margin: 0;">
                                <strong>Last Updated:</strong> ${new Date().toLocaleTimeString()} ‚Ä¢ 
                                Data syncs automatically in real-time
                            </p>
                        </div>
                        
                        ${pendingPayments.length > 0 ? `
                            <div class="card mb" style="border: 2px solid var(--warning);">
                                <h2 style="color: var(--warning); margin-bottom: 1rem;">‚è≥ Pending Payments (${pendingPayments.length})</h2>
                                <div class="space-y">
                                    ${pendingPayments.map(([id, r]) => `
                                        <div class="card" style="background: #fef9c3;">
                                            <div class="flex justify-between items-start flex-wrap gap-1">
                                                <div style="flex: 1;">
                                                    <h3>${r.name}</h3>
                                                    <p style="font-size: 0.875rem;">ID: ${id} ‚Ä¢ ${r.owner}</p>
                                                    ${r.paymentProof?.internalTransactionId ? `<p style="font-size: 0.875rem; font-weight: 600; color: #2563eb;">TXN: ${r.paymentProof.internalTransactionId}</p>` : ''}
                                                    <p style="font-size: 0.875rem;">UTR: ${r.paymentProof?.utrNumber || r.paymentProof?.transactionId || 'N/A'} ‚Ä¢ Amount: ‚Çπ${r.paymentProof?.amount || 1999}</p>
                                                    <p style="font-size: 0.75rem; color: var(--gray-600);">Submitted: ${r.paymentProof?.uploadedAt ? new Date(r.paymentProof.uploadedAt).toLocaleString() : 'N/A'}</p>
                                                </div>
                                                <div class="flex gap-1 flex-wrap">
                                                    <button onclick="viewScreenshot('${id}')" class="btn" style="background: #2563eb; color: white;">View</button>
                                                    <button onclick="approvePayment('${id}')" class="btn btn-success">‚úì Approve</button>
                                                    <button onclick="rejectPayment('${id}')" class="btn btn-danger">‚úó Reject</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${restaurants.filter(([_, r]) => r.planStatus === 'rejected').length > 0 ? `
                            <div class="card mb" style="border: 2px solid var(--danger);">
                                <h2 style="color: var(--danger); margin-bottom: 1rem;">‚ùå Rejected Payments (${restaurants.filter(([_, r]) => r.planStatus === 'rejected').length})</h2>
                                <div class="space-y">
                                    ${restaurants.filter(([_, r]) => r.planStatus === 'rejected').map(([id, r]) => `
                                        <div class="card" style="background: #fee2e2;">
                                            <div class="flex justify-between items-start flex-wrap gap-1">
                                                <div style="flex: 1;">
                                                    <h3>${r.name}</h3>
                                                    <p style="font-size: 0.875rem;">ID: ${id} ‚Ä¢ ${r.owner}</p>
                                                    ${r.paymentProof?.internalTransactionId ? `<p style="font-size: 0.875rem; font-weight: 600; color: #2563eb;">TXN: ${r.paymentProof.internalTransactionId}</p>` : ''}
                                                    <p style="font-size: 0.875rem;">UTR: ${r.paymentProof?.utrNumber || r.paymentProof?.transactionId || 'N/A'} ‚Ä¢ Amount: ‚Çπ${r.paymentProof?.amount || 1999}</p>
                                                    <p style="font-size: 0.875rem; margin-top: 0.5rem;"><strong>Rejection Reason:</strong> ${r.paymentProof?.rejectionReason || 'No reason provided'}</p>
                                                    <p style="font-size: 0.75rem; color: var(--gray-600);">Rejected by: ${r.paymentProof?.rejectedBy || 'Admin'} on ${r.paymentProof?.rejectedAt ? new Date(r.paymentProof.rejectedAt.seconds ? r.paymentProof.rejectedAt.seconds * 1000 : r.paymentProof.rejectedAt).toLocaleString() : 'N/A'}</p>
                                                </div>
                                                <div class="flex gap-1 flex-wrap">
                                                    <button onclick="viewScreenshot('${id}')" class="btn" style="background: #2563eb; color: white;">View</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="card">
                            <h2 style="margin-bottom: 1rem;">All Restaurants</h2>
                            <div class="space-y">
                                ${restaurants.length > 0 ? restaurants.map(([id, r]) => `
                                    <div class="card" style="background: var(--gray-50);">
                                        <div class="flex justify-between items-center flex-wrap gap-1">
                                            <div>
                                                <h3>${r.name} ${r.plan === 'premium' && r.planStatus === 'active' ? '<span class="badge badge-primary">PREMIUM</span>' : r.planStatus === 'pending' ? '<span class="badge badge-warning">PENDING</span>' : '<span class="badge badge-secondary">FREE</span>'}</h3>
                                                <p style="font-size: 0.875rem;">ID: ${id} ‚Ä¢ ${r.city} ‚Ä¢ ${r.queue?.length || 0} customers</p>
                                            </div>
                                            <div class="flex gap-1">
                                                <button onclick="navigate('/r/${id}/admin')" class="btn btn-secondary">Admin</button>
                                                <button onclick="navigate('/r/${id}/display')" class="btn" style="background: #2563eb; color: white;">Display</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : `
                                    <div class="card text-center" style="background: var(--gray-50); padding: 4rem;">
                                        <div style="font-size: 4rem; margin-bottom: 1rem;">üè™</div>
                                        <h3 style="color: var(--gray-600);">No Restaurants Yet</h3>
                                        <p style="color: var(--gray-500); margin-top: 0.5rem;">Restaurants will appear here once they sign up</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function viewScreenshot(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (restaurant?.paymentProof?.screenshot) {
                window.open(restaurant.paymentProof.screenshot, '_blank');
            } else { 
                alert('No screenshot'); 
            }
        }
        
        function approvePayment(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            const paymentInfo = restaurant?.paymentProof;
            
            const confirmMsg = `‚úì Approve Premium for ${restaurant?.name}?\n\nTransaction ID: ${paymentInfo?.internalTransactionId || 'N/A'}\nUTR: ${paymentInfo?.utrNumber || paymentInfo?.transactionId || 'N/A'}\nAmount: ‚Çπ${paymentInfo?.amount || 1999}\n\nThis will activate unlimited customers for 30 days.`;
            
            if (confirm(confirmMsg)) {
                // Add approval audit trail
                const approvalData = {
                    approvedAt: new Date().toISOString(),
                    approvedTimestamp: Date.now(),
                    approvedBy: sessionStorage.getItem('adminEmail') || 'platform_admin',
                    approvalReason: 'Payment verified and approved'
                };
                
                // Add to audit trail
                if (!restaurant.paymentProof.auditTrail) {
                    restaurant.paymentProof.auditTrail = [];
                }
                restaurant.paymentProof.auditTrail.push({
                    action: 'payment_approved',
                    timestamp: new Date().toISOString(),
                    by: approvalData.approvedBy,
                    details: 'Premium plan activated for 30 days'
                });
                
                // Merge approval data
                Object.assign(restaurant.paymentProof, approvalData);
                DB.save();
                
                FirebaseDB.approvePremium(restaurantId, approvalData);
                DB.approvePremium(restaurantId);
                alert('‚úÖ Premium activated! Restaurant owner can now use unlimited customers.');
                handleRoute();
            }
        }
        
        function rejectPayment(restaurantId) {
            const reason = prompt('‚ùå Rejection Reason:\n\nPlease provide a reason for rejecting this payment (e.g., "Amount mismatch", "Invalid screenshot", "Payment not received")');
            
            if (!reason || reason.trim() === '') {
                alert('‚ö†Ô∏è Rejection reason is required');
                return;
            }
            
            if (confirm(`Reject payment with reason: "${reason}"?`)) {
                const restaurant = DB.restaurants[restaurantId];
                
                // Add rejection audit trail
                const rejectionData = {
                    rejectedAt: new Date().toISOString(),
                    rejectedTimestamp: Date.now(),
                    rejectedBy: sessionStorage.getItem('adminEmail') || 'platform_admin',
                    rejectionReason: reason.trim()
                };
                
                // Add to audit trail
                if (restaurant.paymentProof && !restaurant.paymentProof.auditTrail) {
                    restaurant.paymentProof.auditTrail = [];
                }
                if (restaurant.paymentProof) {
                    restaurant.paymentProof.auditTrail.push({
                        action: 'payment_rejected',
                        timestamp: new Date().toISOString(),
                        by: rejectionData.rejectedBy,
                        details: 'Reason: ' + reason.trim()
                    });
                }
                
                FirebaseDB.rejectPremium(restaurantId, reason.trim(), rejectionData);
                DB.rejectPremium(restaurantId, reason.trim());
                alert('‚ùå Payment rejected. Restaurant owner will see the reason.');
                handleRoute();
            }
        }
        
        async function adminLogout() {
            // Clean up real-time listener
            if (platformAdminListener) {
                platformAdminListener();
                platformAdminListener = null;
                console.log('‚úÖ Platform admin listener cleaned up');
            }
            
            await FirebaseAdmin.signOut();
            sessionStorage.removeItem('adminAuth');
            sessionStorage.removeItem('adminEmail');
            alert('‚úÖ Logged out');
            navigate('/');
        }
        
        // Export functions
        window.navigate = navigate;
        window.navigateHome = navigateHome;
        window.selectGuests = selectGuests;
        window.handleSignup = handleSignup;
        window.handleLogin = handleLogin;
        window.handleRestaurantLogin = handleRestaurantLogin;
        window.handleJoinQueue = handleJoinQueue;
        window.allocateTable = allocateTable;
        window.logout = logout;
        window.firebaseAdminLogin = firebaseAdminLogin;
        window.adminLogout = adminLogout;
        window.handleUpgrade = handleUpgrade;
        window.previewScreenshot = previewScreenshot;
        window.submitPaymentProof = submitPaymentProof;
        window.viewScreenshot = viewScreenshot;
        window.approvePayment = approvePayment;
        window.rejectPayment = rejectPayment;
        window.printQRCode = printQRCode;
        window.downloadQRCode = downloadQRCode;
        window.copyQRLink = copyQRLink;
        window.generateQRCode = generateQRCode;
        window.showLoadingSuccess = showLoadingSuccess;
        
        // Firebase Auth Listener
        FirebaseAdmin.onAuthStateChanged((user) => {
            if (user) {
                console.log('üî• Admin:', user.email);
                if (sessionStorage.getItem('adminAuth') !== 'yes') {
                    sessionStorage.setItem('adminAuth', 'yes');
                    sessionStorage.setItem('adminEmail', user.email);
                }
            } else {
                if (sessionStorage.getItem('adminAuth') === 'yes') {
                    sessionStorage.removeItem('adminAuth');
                    sessionStorage.removeItem('adminEmail');
                }
            }
        });
        
        // Initialize
        setTimeout(() => {
            handleRoute();
            checkDailyCleanup();
        }, 500);
    </script>
</body>
</html>
