<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueApp - Complete System with Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    <script>
        const DB = {
            restaurants: JSON.parse(localStorage.getItem('restaurants') || '{}'),
            
            save() { 
                console.log('üíæ Saving to localStorage');
                localStorage.setItem('restaurants', JSON.stringify(this.restaurants)); 
            },
            
            addRestaurant(id, data) { 
                this.restaurants[id] = { 
                    ...data, 
                    queue: [], 
                    tables: [], 
                    createdAt: Date.now(), 
                    plan: 'free',
                    planStatus: 'active',
                    paymentProof: null,
                    planExpiryDate: null
                }; 
                console.log(`‚úÖ Restaurant ${id} created with FREE plan`);
                this.save(); 
                return id; 
            },
            
            addToQueue(restaurantId, customer) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) {
                    console.error(`‚ùå Restaurant ${restaurantId} not found`);
                    return null;
                }
                
                const originalPlan = restaurant.plan;
                const queueNumber = `A-${Math.floor(Math.random() * 900) + 100}`; 
                
                restaurant.queue.push({ 
                    ...customer, 
                    queueNumber, 
                    status: 'waiting', 
                    joinedAt: Date.now() 
                }); 
                
                restaurant.plan = originalPlan || 'free';
                
                console.log(`‚úÖ Customer added. Plan: ${restaurant.plan}`);
                this.save(); 
                return queueNumber; 
            },
            
            allocateTable(restaurantId, queueNumber, tableNo) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) return false;
                
                const queueItem = restaurant.queue.find(q => q.queueNumber === queueNumber); 
                if (queueItem) { 
                    queueItem.status = 'allocated'; 
                    queueItem.tableNo = tableNo; 
                    queueItem.allocatedAt = Date.now();
                    this.save(); 
                    return true; 
                } 
                return false; 
            },
            
            login(restaurantId, phone) { 
                const restaurant = this.restaurants[restaurantId]; 
                return restaurant && restaurant.phone === phone; 
            },
            
            upgradePlan(restaurantId, plan) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (restaurant) { 
                    restaurant.plan = plan; 
                    console.log(`‚úÖ Plan changed to: ${plan} for ${restaurantId}`);
                    this.save(); 
                    return true; 
                } 
                return false; 
            },

            // NEW: Save payment proof
            savePaymentProof(restaurantId, paymentData) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) {
                    restaurant.paymentProof = {
                        screenshot: paymentData.screenshot,
                        transactionId: paymentData.transactionId,
                        amount: paymentData.amount,
                        uploadedAt: Date.now()
                    };
                    restaurant.planStatus = 'pending';
                    console.log(`üí≥ Payment proof saved for ${restaurantId}`);
                    this.save();
                    return true;
                }
                return false;
            },

            // NEW: Approve Premium plan
            approvePremium(restaurantId) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) {
                    restaurant.plan = 'premium';
                    restaurant.planStatus = 'active';
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    restaurant.planExpiryDate = expiryDate.getTime();
                    console.log(`‚úÖ Premium activated for ${restaurantId}`);
                    this.save();
                    return true;
                }
                return false;
            },

            // NEW: Reject Premium request
            rejectPremium(restaurantId) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) {
                    restaurant.planStatus = 'rejected';
                    if (restaurant.paymentProof) {
                        restaurant.paymentProof.rejectedAt = Date.now();
                    }
                    console.log(`‚ùå Premium rejected for ${restaurantId}`);
                    this.save();
                    return true;
                }
                return false;
            }
        };
        
        function getLoggedInRestaurant() {
            const allRestaurants = Object.keys(DB.restaurants);
            for (let id of allRestaurants) {
                if (sessionStorage.getItem(`loggedIn_${id}`)) {
                    return { id, data: DB.restaurants[id] };
                }
            }
            return null;
        }
        
        function navigateHome() {
            const loggedIn = getLoggedInRestaurant();
            if (loggedIn) {
                console.log(`üè† Logo clicked: User logged in ‚Üí Dashboard`);
                navigate(`/r/${loggedIn.id}/admin`);
            } else {
                console.log(`üè† Logo clicked: User not logged in ‚Üí Home`);
                navigate('/');
            }
        }
        
        function render(html) { document.getElementById('app').innerHTML = html; }
        function navigate(path) { window.location.hash = path; }
        
        function handleRoute() {
            const hash = window.location.hash.slice(1) || '/';
            const parts = hash.split('/').filter(Boolean);
            
            if (hash === '/' || hash === '') showHome();
            else if (hash === '/pricing') showPricing();
            else if (hash === '/terms') showTerms();
            else if (hash === '/privacy') showPrivacy();
            else if (hash === '/signup') showSignup();
            else if (hash === '/login') showLogin();
            else if (hash === '/admin') {
                if (sessionStorage.getItem('adminAuth') === 'yes') {
                    showPlatformAdmin();
                } else {
                    showAdminPasswordPrompt();
                }
            }
            // NEW: Payment routes
            else if (parts[0] === 'payment' && parts[1] && parts[2] === 'upload') showUploadScreenshot(parts[1]);
            else if (parts[0] === 'payment' && parts[1]) showPaymentPage(parts[1]);
            // Existing routes
            else if (parts[0] === 'r' && parts[2] === 'join') showJoinQueue(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'display') showDisplay(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'status' && parts[3]) showQueueStatus(parts[1], parts[3]);
            else if (parts[0] === 'r' && parts[2] === 'admin') { 
                const loggedIn = sessionStorage.getItem(`loggedIn_${parts[1]}`); 
                if (loggedIn) {
                    const restaurant = DB.restaurants[parts[1]];
                    console.log(`üîç Loading admin for ${parts[1]}, Plan: ${restaurant?.plan}`);
                    showRestaurantAdmin(parts[1]); 
                } else {
                    showRestaurantLogin(parts[1]); 
                }
            }
            else render(`<div class="p-8 text-center"><h1 class="text-4xl">404 - Page Not Found</h1><button onclick="navigate('/')" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg">Go Home</button></div>`);
        }
        
        window.onhashchange = handleRoute;
        
        // [The existing showHome, showTerms, showPrivacy functions remain exactly the same]
        // I'll include a minimal version here to save space - you should use your full versions
        
        function showHome() {
            render(`<div class="min-h-screen bg-gradient-to-br from-orange-50 to-pink-50"><nav class="bg-white shadow-md p-4"><div class="container mx-auto flex justify-between items-center"><h1 class="text-2xl font-bold text-orange-600 cursor-pointer" onclick="navigateHome()">QueueApp</h1><div class="space-x-4"><button onclick="navigate('/pricing')" class="text-gray-700 hover:text-orange-600 font-semibold">Pricing</button><button onclick="navigate('/login')" class="text-gray-700 hover:text-orange-600 font-semibold">Login</button><button onclick="navigate('/signup')" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700">Sign Up</button></div></div></nav><main class="container mx-auto px-4 py-16 text-center"><h1 class="text-6xl font-bold text-gray-900 mb-6">Smart Queue Management</h1><p class="text-2xl text-gray-600 mb-12">No more crowded entrances. Happy customers.</p><button onclick="navigate('/signup')" class="bg-gradient-to-r from-orange-500 to-pink-600 text-white px-12 py-4 rounded-xl text-xl font-bold hover:shadow-xl">Start Free Forever</button></main></div>`);
        }

        function showTerms() {
            render(`<div class="min-h-screen bg-gray-50"><nav class="bg-white shadow-md p-4"><div class="container mx-auto"><h1 class="text-2xl font-bold text-orange-600 cursor-pointer" onclick="navigateHome()">QueueApp</h1></div></nav><div class="container mx-auto px-4 py-12"><h1 class="text-4xl font-bold">Terms of Service</h1><p class="mt-4">Terms content here...</p><button onclick="navigateHome()" class="mt-8 bg-orange-600 text-white px-8 py-3 rounded-xl">Back</button></div></div>`);
        }

        function showPrivacy() {
            render(`<div class="min-h-screen bg-gray-50"><nav class="bg-white shadow-md p-4"><div class="container mx-auto"><h1 class="text-2xl font-bold text-orange-600 cursor-pointer" onclick="navigateHome()">QueueApp</h1></div></nav><div class="container mx-auto px-4 py-12"><h1 class="text-4xl font-bold">Privacy Policy</h1><p class="mt-4">Privacy content here...</p><button onclick="navigateHome()" class="mt-8 bg-orange-600 text-white px-8 py-3 rounded-xl">Back</button></div></div>`);
        }

        function showPricing() {
            const loggedIn = getLoggedInRestaurant();
            const isLoggedIn = !!loggedIn;
            const restaurant = loggedIn?.data;
            const restaurantId = loggedIn?.id;
            const currentPlan = restaurant?.plan || 'free';
            const planStatus = restaurant?.planStatus || 'active';
            
            const navButtons = isLoggedIn 
                ? `<div class="flex items-center gap-4">
                     <span class="text-sm font-semibold text-gray-700">${restaurant.name}</span>
                     <span class="px-3 py-1 rounded-full text-xs font-bold ${currentPlan === 'premium' ? 'bg-orange-500 text-white' : planStatus === 'pending' ? 'bg-yellow-500 text-white' : 'bg-gray-400 text-white'}">${planStatus === 'pending' ? 'PENDING' : currentPlan.toUpperCase()}</span>
                     <button onclick="navigate('/r/${restaurantId}/admin')" class="text-gray-700 hover:text-orange-600 font-semibold">Dashboard</button>
                     <button onclick="logout('${restaurantId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
                   </div>`
                : `<div class="space-x-4">
                     <button onclick="navigate('/login')" class="text-gray-700 hover:text-orange-600 font-semibold">Login</button>
                     <button onclick="navigate('/signup')" class="bg-orange-600 text-white px-6 py-2 rounded-lg">Sign Up</button>
                   </div>`;
            
            let premiumCTA;
            if (isLoggedIn && currentPlan === 'premium' && planStatus === 'active') {
                premiumCTA = `<button class="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg cursor-not-allowed" disabled>‚úì Current Plan</button>`;
            } else if (isLoggedIn && planStatus === 'pending') {
                premiumCTA = `<button class="w-full bg-yellow-500 text-white py-4 rounded-xl font-bold text-lg cursor-not-allowed" disabled>‚è≥ Verification Pending</button>`;
            } else if (isLoggedIn && currentPlan === 'free') {
                premiumCTA = `<button onclick="handleUpgrade('${restaurantId}')" class="w-full bg-white hover:bg-gray-100 text-orange-600 py-4 rounded-xl font-bold text-lg shadow-lg">Upgrade Now</button>`;
            } else {
                premiumCTA = `<button onclick="navigate('/signup')" class="w-full bg-white hover:bg-gray-100 text-orange-600 py-4 rounded-xl font-bold text-lg shadow-lg">Get Started</button>`;
            }

            render(`<div class="min-h-screen bg-gradient-to-br from-orange-50 to-pink-50"><nav class="bg-white shadow-md p-4"><div class="container mx-auto flex justify-between items-center"><h1 class="text-2xl font-bold text-orange-600 cursor-pointer" onclick="navigateHome()">QueueApp</h1>${navButtons}</div></nav><div class="container mx-auto px-4 py-16"><div class="text-center mb-16"><h1 class="text-5xl font-bold text-gray-900 mb-4">Simple, Honest Pricing</h1>${isLoggedIn && planStatus === 'pending' ? `<div class="inline-flex items-center gap-2 bg-yellow-100 text-yellow-800 px-6 py-3 rounded-full font-semibold mb-4">‚è≥ Payment verification in progress</div>` : ''}</div><div class="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto"><div class="bg-white rounded-3xl shadow-xl p-8"><h3 class="text-3xl font-bold mb-2">Free</h3><div class="text-6xl font-bold text-gray-900 mb-6">‚Çπ0<span class="text-lg">/month</span></div><ul class="space-y-3 mb-8"><li>‚úì 500 customers/month</li><li>‚úì Digital queue</li><li>‚úì QR code entry</li><li>‚úì Live display</li></ul></div><div class="bg-gradient-to-br from-orange-500 to-pink-600 rounded-3xl shadow-2xl p-8 text-white"><h3 class="text-3xl font-bold mb-2">Premium</h3><div class="text-6xl font-bold mb-6">‚Çπ2,999<span class="text-lg">/month</span></div><ul class="space-y-3 mb-8"><li>‚úì Unlimited customers</li><li>‚úì WhatsApp notifications</li><li>‚úì Advanced analytics</li><li>‚úì Custom branding</li><li>‚úì Priority support</li></ul>${premiumCTA}</div></div></div></div>`);
        }
        
        // NEW: Payment Page
        function showPaymentPage(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) {
                render(`<div class="p-8 text-center"><h1 class="text-2xl text-red-600">Restaurant not found</h1></div>`);
                return;
            }

            render(`
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-6">
                    <div class="max-w-2xl mx-auto">
                        
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-900">Upgrade to Premium</h1>
                                    <p class="text-gray-600">${restaurant.name}</p>
                                </div>
                                <button onclick="navigate('/pricing')" class="text-gray-600 hover:text-gray-900 text-2xl">‚úï</button>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-orange-500 to-pink-600 rounded-2xl shadow-xl p-8 mb-6 text-white text-center">
                            <p class="text-lg mb-2">Total Amount</p>
                            <div class="text-6xl font-bold mb-2">‚Çπ2,999</div>
                            <p class="text-orange-100">per month ‚Ä¢ 30 days validity</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Pay via UPI</h2>
                            
                            <div class="bg-gray-50 rounded-xl p-4 mb-6 text-center">
                                <p class="text-sm text-gray-600 mb-2">UPI ID</p>
                                <p class="text-xl font-mono font-bold text-orange-600">sriramvasudev@okhdfcbank</p>
                            </div>

                            <div class="bg-gray-50 rounded-xl p-6 mb-6 text-center">
                                <p class="text-sm font-semibold text-gray-700 mb-4">Scan QR Code</p>
                                <div id="payment-qr" class="inline-block bg-white p-4 rounded-xl"></div>
                            </div>

                            <div class="space-y-3 mb-6">
                                <button onclick="payWithUPIApp('phonepe', '${restaurantId}')" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
                                    <span class="text-2xl">üì±</span> Pay with PhonePe
                                </button>
                                <button onclick="payWithUPIApp('gpay', '${restaurantId}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
                                    <span class="text-2xl">üîµ</span> Pay with Google Pay
                                </button>
                                <button onclick="payWithUPIApp('paytm', '${restaurantId}')" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
                                    <span class="text-2xl">üíô</span> Pay with Paytm
                                </button>
                                <button onclick="payWithUPIApp('generic', '${restaurantId}')" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-4 rounded-xl font-semibold flex items-center justify-center gap-3">
                                    <span class="text-2xl">üí∞</span> Pay with Any UPI App
                                </button>
                            </div>

                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4">
                                <p class="text-sm text-yellow-800 font-semibold">‚ö†Ô∏è <strong>Important:</strong> After payment, upload screenshot on next page for verification</p>
                            </div>
                        </div>

                        <button onclick="navigate('/payment/${restaurantId}/upload')" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg">
                            I've Completed Payment ‚Üí Upload Screenshot
                        </button>

                    </div>
                </div>
            `);

            // Generate QR Code
            setTimeout(() => {
                const upiString = `upi://pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=2999&cu=INR&tn=QueueApp-${restaurantId}-Premium`;
                new QRCode(document.getElementById('payment-qr'), {
                    text: upiString,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }, 100);
        }

        // NEW: Screenshot Upload Page
        function showUploadScreenshot(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) {
                render(`<div class="p-8 text-center"><h1 class="text-2xl text-red-600">Restaurant not found</h1></div>`);
                return;
            }

            render(`
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 p-6">
                    <div class="max-w-2xl mx-auto">
                        
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <h1 class="text-2xl font-bold text-gray-900 text-center">Upload Payment Proof</h1>
                            <p class="text-gray-600 text-center">${restaurant.name}</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Transaction ID / UTR Number *</label>
                                <input type="text" id="transactionId" placeholder="e.g., 123456789012" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-orange-500 focus:outline-none">
                            </div>

                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Upload Payment Screenshot *</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-orange-500">
                                    <input type="file" id="screenshotFile" accept="image/*" onchange="previewScreenshot()" class="hidden">
                                    <button onclick="document.getElementById('screenshotFile').click()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold">
                                        üì∑ Choose Screenshot
                                    </button>
                                    <p class="text-sm text-gray-500 mt-3">PNG, JPG up to 5MB</p>
                                </div>
                                <div id="screenshotPreview" class="mt-4 hidden">
                                    <p class="text-sm font-semibold text-gray-700 mb-2">Preview:</p>
                                    <img id="previewImage" class="w-full rounded-xl border-2 border-gray-200" />
                                </div>
                            </div>

                            <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
                                <p class="font-semibold text-blue-900 mb-2">üìã What to include:</p>
                                <ul class="text-sm text-blue-800 space-y-1 ml-4 list-disc">
                                    <li>Transaction ID / UTR number</li>
                                    <li>Amount paid (‚Çπ2,999)</li>
                                    <li>Date and time</li>
                                    <li>Transaction status (Success)</li>
                                </ul>
                            </div>

                            <button onclick="submitPaymentProof('${restaurantId}')" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-lg">
                                Submit for Verification
                            </button>

                            <p class="text-center text-sm text-gray-500 mt-4">Verification typically takes 2-24 hours</p>
                        </div>

                    </div>
                </div>
            `);
        }

        // NEW: Preview screenshot
        function previewScreenshot() {
            const file = document.getElementById('screenshotFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('screenshotPreview').classList.remove('hidden');
                    document.getElementById('previewImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // NEW: Submit payment proof
        function submitPaymentProof(restaurantId) {
            const transactionId = document.getElementById('transactionId').value.trim();
            const fileInput = document.getElementById('screenshotFile');
            
            if (!transactionId) {
                alert('‚ö†Ô∏è Please enter transaction ID');
                return;
            }
            
            if (!fileInput.files[0]) {
                alert('‚ö†Ô∏è Please upload payment screenshot');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const screenshot = e.target.result;
                
                DB.savePaymentProof(restaurantId, {
                    screenshot: screenshot,
                    transactionId: transactionId,
                    amount: 2999
                });

                alert('‚úÖ Payment proof submitted successfully!\n\nYour payment is under verification.\nYou will be notified once approved (typically within 2-24 hours).\n\nTrack status in your dashboard.');
                
                navigate(`/r/${restaurantId}/admin`);
            };
            
            reader.readAsDataURL(fileInput.files[0]);
        }

        // NEW: Handle UPI app payment
        function payWithUPIApp(app, restaurantId) {
            const upiId = 'sriramvasudev@okhdfcbank';
            const amount = '2999';
            const note = `QueueApp-${restaurantId}-Premium`;
            
            let url;
            switch(app) {
                case 'phonepe':
                    url = `phonepe://pay?pa=${upiId}&pn=QueueApp&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
                    break;
                case 'gpay':
                    url = `tez://upi/pay?pa=${upiId}&pn=QueueApp&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
                    break;
                case 'paytm':
                    url = `paytmmp://pay?pa=${upiId}&pn=QueueApp&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
                    break;
                default:
                    url = `upi://pay?pa=${upiId}&pn=QueueApp&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
            }
            
            window.location.href = url;
            
            setTimeout(() => {
                const genericUrl = `upi://pay?pa=${upiId}&pn=QueueApp&am=${amount}&cu=INR&tn=${encodeURIComponent(note)}`;
                window.location.href = genericUrl;
            }, 2000);
        }
        
        // MODIFIED: Upgrade handler now navigates to payment page
        function handleUpgrade(restaurantId) {
            navigate(`/payment/${restaurantId}`);
        }
        
        function confirmDowngrade(restaurantId) {
            if (confirm('Are you sure you want to downgrade to Free plan?\n\nYou will lose Premium features.')) {
                DB.upgradePlan(restaurantId, 'free');
                const restaurant = DB.restaurants[restaurantId];
                restaurant.planStatus = 'active';
                restaurant.planExpiryDate = null;
                DB.save();
                alert('‚úÖ Downgraded to Free plan successfully!');
                navigate('/pricing');
            }
        }
        
        // [Include all other existing functions: showLogin, showSignup, showJoinQueue, showQueueStatus, showDisplay, showRestaurantAdmin, showPlatformAdmin, etc.]
        // For brevity, I'll add minimal versions - use your full implementations
        
        function showLogin() {
            render(`<div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-6 flex items-center justify-center"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Restaurant Login</h1><div class="space-y-4"><input type="text" id="loginRestaurantId" placeholder="Restaurant ID" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="tel" id="loginPhone" placeholder="Phone Number" maxlength="10" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><button onclick="handleLogin()" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg">Login</button></div></div></div>`);
        }
        
        function handleLogin() {
            const restaurantId = document.getElementById('loginRestaurantId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            if (!restaurantId || !phone) { alert('Please enter Restaurant ID and Phone'); return; }
            if (DB.login(restaurantId, phone)) { 
                sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true'); 
                alert('‚úÖ Login successful!'); 
                navigate(`/r/${restaurantId}/admin`); 
            } else { 
                alert('‚ùå Invalid Restaurant ID or Phone Number'); 
            }
        }
        
        function showRestaurantLogin(restaurantId) {
            render(`<div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 p-6 flex items-center justify-center"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Login Required</h1><input type="tel" id="restaurantLoginPhone" placeholder="Phone Number" maxlength="10" class="w-full px-4 py-3 border-2 rounded-xl outline-none mb-4"><button onclick="handleRestaurantLogin('${restaurantId}')" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 rounded-xl font-bold text-lg">Login</button></div></div>`);
        }
        
        function handleRestaurantLogin(restaurantId) {
            const phone = document.getElementById('restaurantLoginPhone').value.trim();
            if (!phone) { alert('Please enter phone number'); return; }
            if (DB.login(restaurantId, phone)) { 
                sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true'); 
                handleRoute(); 
            } else { 
                alert('‚ùå Invalid phone number'); 
            }
        }
        
        function showSignup() {
            render(`<div class="min-h-screen bg-gradient-to-br from-orange-500 to-pink-600 p-6 flex items-center justify-center"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Register Your Restaurant</h1><div class="space-y-4"><input type="text" id="restaurantName" placeholder="Restaurant Name" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="text" id="ownerName" placeholder="Owner Name" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="tel" id="phone" placeholder="Phone (10 digits)" maxlength="10" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="text" id="city" placeholder="City" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><div class="flex items-start gap-3"><input type="checkbox" id="agreeTerms" class="mt-1"><label for="agreeTerms" class="text-sm">I agree to Terms & Privacy</label></div><button onclick="handleSignup()" class="w-full bg-gradient-to-r from-orange-500 to-pink-600 text-white py-4 rounded-xl font-bold text-lg">Register</button></div></div></div>`);
        }
        
        function handleSignup() {
            const name = document.getElementById('restaurantName').value;
            const owner = document.getElementById('ownerName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const city = document.getElementById('city').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            if (!name || !owner || !email || !phone || !city) { alert('Please fill all fields'); return; }
            if (!agreeTerms) { alert('‚ö†Ô∏è Please agree to Terms of Service'); return; }
            
            const restaurantId = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X') + Math.floor(Math.random() * 1000);
            DB.addRestaurant(restaurantId, { name, owner, email, phone, city });
            sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
            
            alert(`‚úÖ Success! Your Restaurant ID: ${restaurantId}\n\nüéâ You're on the FREE plan (500 customers/month)`);
            navigate(`/r/${restaurantId}/admin`);
        }
        
        function showJoinQueue(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) { 
                render(`<div class="p-8 text-center"><h1 class="text-2xl text-red-600">Restaurant not found</h1></div>`); 
                return; 
            }
            render(`<div class="min-h-screen bg-gradient-to-br from-orange-500 to-pink-600 p-6 flex items-center justify-center"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full"><h1 class="text-3xl font-bold text-gray-900 mb-2 text-center">Join Queue</h1><p class="text-gray-600 text-center mb-6">${restaurant.name}</p><div class="space-y-6"><input type="text" id="customerName" placeholder="Your Name" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><input type="tel" id="customerPhone" placeholder="Mobile (10 digits)" maxlength="10" class="w-full px-4 py-3 border-2 rounded-xl outline-none"><div><label class="block text-sm font-semibold mb-2">Guests</label><div class="grid grid-cols-4 gap-2">${[1,2,3,4,5,6,7,8].map(n => `<button onclick="selectGuests(${n})" id="guest-${n}" class="py-3 rounded-xl font-semibold ${n === 2 ? 'bg-orange-500 text-white' : 'bg-gray-100'}">${n}</button>`).join('')}</div></div><button onclick="handleJoinQueue('${restaurantId}')" class="w-full bg-gradient-to-r from-orange-500 to-pink-600 text-white py-4 rounded-xl font-bold text-lg">Join Queue</button></div></div></div>`);
            window.selectedGuests = 2;
        }
        
        function selectGuests(n) {
            window.selectedGuests = n;
            document.querySelectorAll('[id^="guest-"]').forEach(btn => btn.className = 'py-3 rounded-xl font-semibold bg-gray-100');
            document.getElementById(`guest-${n}`).className = 'py-3 rounded-xl font-semibold bg-orange-500 text-white';
        }
        
        function handleJoinQueue(restaurantId) {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const guests = window.selectedGuests || 2;
            
            if (!name || !phone) { alert('Please fill all fields'); return; }
            
            const queueNumber = DB.addToQueue(restaurantId, { name, phone, guests });
            alert(`‚úÖ You're in queue!\n\nYour number: ${queueNumber}\n\nWatch the display screen!`);
            navigate(`/r/${restaurantId}/status/${queueNumber}`);
        }
        
        function showQueueStatus(restaurantId, queueNumber) {
            render(`<div class="p-8 text-center"><h1 class="text-3xl font-bold">Queue Status</h1><p class="text-xl mt-4">Number: ${queueNumber}</p><button onclick="navigate('/r/${restaurantId}/display')" class="mt-6 bg-blue-600 text-white px-8 py-4 rounded-xl">View Display</button></div>`);
        }
        
        function showDisplay(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) return;
            
            const waiting = restaurant.queue.filter(q => q.status === 'waiting');
            const allocated = restaurant.queue.filter(q => q.status === 'allocated');
            
            render(`<div class="min-h-screen bg-gray-900 text-white p-8"><h1 class="text-5xl font-bold mb-8 text-center">${restaurant.name}</h1><div class="grid grid-cols-2 gap-8"><div><h2 class="text-3xl font-bold mb-4">Waiting (${waiting.length})</h2>${waiting.map((w, i) => `<div class="bg-gray-800 p-4 rounded-xl mb-3"><div class="text-3xl font-bold">${w.queueNumber}</div><div class="text-gray-400">#${i+1} ‚Ä¢ ${w.guests} guests</div></div>`).join('')}</div><div><h2 class="text-3xl font-bold mb-4">Now Serving</h2>${allocated.slice(-3).map(a => `<div class="bg-green-600 p-4 rounded-xl mb-3"><div class="text-3xl font-bold">${a.queueNumber}</div><div>Table ${a.tableNo}</div></div>`).join('')}</div></div></div>`);
            
            setTimeout(() => handleRoute(), 3000);
        }
        
        function showRestaurantAdmin(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) return;
            
            const waiting = restaurant.queue.filter(q => q.status === 'waiting');
            const currentPlan = restaurant.plan || 'free';
            const planStatus = restaurant.planStatus || 'active';
            
            const planBadge = currentPlan === 'premium' 
                ? '<span class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-bold">PREMIUM</span>' 
                : planStatus === 'pending'
                ? '<span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold">PENDING</span>'
                : '<span class="bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-bold">FREE</span>';
            
            render(`<div class="min-h-screen bg-gray-100 p-6"><div class="max-w-6xl mx-auto"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6 flex justify-between items-center"><div><h1 class="text-3xl font-bold cursor-pointer" onclick="navigateHome()">QueueApp</h1><p class="text-gray-600">${restaurant.name} - Admin ${planBadge}</p></div><div class="flex gap-2"><button onclick="navigate('/pricing')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">${currentPlan === 'free' && planStatus !== 'pending' ? 'Upgrade' : 'Manage Plan'}</button><button onclick="logout('${restaurantId}')" class="bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button></div></div>${planStatus === 'pending' ? '<div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6"><p class="text-yellow-800 font-semibold">‚è≥ Premium upgrade pending verification. We\'ll notify you once approved!</p></div>' : ''}<div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4">Waiting Queue (${waiting.length})</h2><div class="space-y-3">${waiting.length > 0 ? waiting.map(w => `<div class="border-2 border-gray-200 rounded-xl p-4 flex justify-between items-center"><div><div class="text-xl font-bold">${w.queueNumber}</div><div class="text-gray-600">${w.name} ‚Ä¢ ${w.phone} ‚Ä¢ ${w.guests} guests</div></div><div class="flex gap-2 items-center"><input type="number" id="table-${w.queueNumber}" placeholder="Table #" class="w-24 px-3 py-2 border-2 rounded-lg" min="1"><button onclick="allocateTable('${restaurantId}', '${w.queueNumber}')" class="bg-green-600 text-white px-6 py-2 rounded-lg">Seat</button></div></div>`).join('') : '<p class="text-gray-500">No customers in queue</p>'}</div></div><div class="flex gap-4"><button onclick="navigate('/r/${restaurantId}/display')" class="bg-blue-600 text-white px-6 py-3 rounded-xl">üì∫ Display</button><button onclick="navigate('/r/${restaurantId}/join')" class="bg-purple-600 text-white px-6 py-3 rounded-xl">üì± Join Queue</button></div></div></div>`);
        }
        
        function allocateTable(restaurantId, queueNumber) {
            const tableNo = document.getElementById(`table-${queueNumber}`).value;
            if (!tableNo || tableNo < 1) { alert('‚ö†Ô∏è Please enter table number'); return; }
            DB.allocateTable(restaurantId, queueNumber, tableNo);
            alert(`‚úÖ Table ${tableNo} allocated to ${queueNumber}!`);
            handleRoute();
        }
        
        function logout(restaurantId) {
            sessionStorage.removeItem(`loggedIn_${restaurantId}`);
            alert('‚úÖ Logged out successfully');
            navigate('/');
        }
        
        function showAdminPasswordPrompt() {
            render(`<div class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 p-6 flex items-center justify-center"><div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full"><h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">üîê Platform Admin</h1><input type="password" id="adminPass" placeholder="Master Password" class="w-full px-4 py-3 border-2 rounded-xl outline-none mb-4"><button onclick="checkAdminPassword()" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg">Login</button></div></div>`);
        }
        
        function checkAdminPassword() {
            if (document.getElementById('adminPass').value === 'SuperAdmin2024!@#') {
                sessionStorage.setItem('adminAuth', 'yes');
                navigate('/admin');
            } else {
                alert('‚ùå Wrong password');
            }
        }
        
        // NEW: Enhanced Platform Admin with payment verification
        function showPlatformAdmin() {
            const restaurants = Object.entries(DB.restaurants);
            const pendingPayments = restaurants.filter(([_, r]) => r.planStatus === 'pending');
            const totalCustomers = restaurants.reduce((sum, [_, r]) => sum + r.queue.length, 0);
            const totalRevenue = restaurants.filter(([_, r]) => r.plan === 'premium' && r.planStatus === 'active').length * 2999;
            
            render(`<div class="min-h-screen bg-gray-100 p-6"><div class="max-w-7xl mx-auto"><div class="bg-white rounded-2xl shadow-lg p-6 mb-6 flex justify-between items-center"><div><h1 class="text-3xl font-bold">üè¢ Platform Admin</h1><p class="text-gray-600">Manage all restaurants</p></div><button onclick="adminLogout()" class="bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button></div><div class="grid grid-cols-4 gap-6 mb-6"><div class="bg-blue-50 rounded-xl p-6 border-2 border-blue-200"><div class="text-4xl font-bold text-blue-600">${restaurants.length}</div><div class="text-gray-600">Total Restaurants</div></div><div class="bg-green-50 rounded-xl p-6 border-2 border-green-200"><div class="text-4xl font-bold text-green-600">${totalCustomers}</div><div class="text-gray-600">Total Customers</div></div><div class="bg-purple-50 rounded-xl p-6 border-2 border-purple-200"><div class="text-4xl font-bold text-purple-600">‚Çπ${totalRevenue.toLocaleString()}</div><div class="text-gray-600">Monthly Revenue</div></div><div class="bg-yellow-50 rounded-xl p-6 border-2 border-yellow-200"><div class="text-4xl font-bold text-yellow-600">${pendingPayments.length}</div><div class="text-gray-600">Pending Payments</div></div></div>${pendingPayments.length > 0 ? `<div class="bg-white rounded-2xl shadow-lg p-6 mb-6"><h2 class="text-2xl font-bold mb-4 text-yellow-600">‚è≥ Pending Payment Verifications (${pendingPayments.length})</h2><div class="space-y-4">${pendingPayments.map(([id, r]) => `<div class="border-2 border-yellow-300 bg-yellow-50 rounded-xl p-4"><div class="flex justify-between items-start"><div class="flex-1"><div class="text-xl font-bold">${r.name}</div><div class="text-gray-600">ID: ${id} ‚Ä¢ Owner: ${r.owner}</div><div class="text-sm text-gray-500 mt-2">Transaction ID: ${r.paymentProof?.transactionId || 'N/A'}</div><div class="text-sm text-gray-500">Uploaded: ${new Date(r.paymentProof?.uploadedAt || 0).toLocaleString()}</div></div><div class="flex gap-2"><button onclick="viewScreenshot('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg">View Screenshot</button><button onclick="approvePayment('${id}')" class="bg-green-600 text-white px-4 py-2 rounded-lg">‚úì Approve</button><button onclick="rejectPayment('${id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg">‚úó Reject</button></div></div></div>`).join('')}</div></div>` : ''}<div class="bg-white rounded-2xl shadow-lg p-6"><h2 class="text-2xl font-bold mb-4">All Restaurants</h2><div class="space-y-3">${restaurants.map(([id, r]) => `<div class="border-2 border-gray-200 rounded-xl p-4"><div class="flex justify-between items-center"><div><div class="text-xl font-bold">${r.name} ${r.plan === 'premium' && r.planStatus === 'active' ? '<span class="text-sm bg-orange-500 text-white px-2 py-1 rounded-full ml-2">PREMIUM</span>' : r.planStatus === 'pending' ? '<span class="text-sm bg-yellow-500 text-white px-2 py-1 rounded-full ml-2">PENDING</span>' : '<span class="text-sm bg-gray-400 text-white px-2 py-1 rounded-full ml-2">FREE</span>'}</div><div class="text-gray-600">ID: ${id} ‚Ä¢ ${r.city} ‚Ä¢ ${r.queue.length} customers today</div></div><div class="flex gap-2"><button onclick="navigate('/r/${id}/join')" class="bg-purple-600 text-white px-4 py-2 rounded-lg">Join</button><button onclick="navigate('/r/${id}/display')" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Display</button></div></div></div>`).join('')}</div></div></div></div>`);
        }
        
        function viewScreenshot(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (restaurant && restaurant.paymentProof && restaurant.paymentProof.screenshot) {
                window.open(restaurant.paymentProof.screenshot, '_blank');
            } else {
                alert('No screenshot available');
            }
        }
        
        function approvePayment(restaurantId) {
            if (confirm('Approve this Premium payment?')) {
                DB.approvePremium(restaurantId);
                alert('‚úÖ Premium activated!');
                handleRoute();
            }
        }
        
        function rejectPayment(restaurantId) {
            if (confirm('Reject this payment?\n\nProvide reason to the restaurant owner separately.')) {
                DB.rejectPremium(restaurantId);
                alert('‚ùå Payment rejected. Please contact the restaurant owner.');
                handleRoute();
            }
        }
        
        function adminLogout() {
            sessionStorage.removeItem('adminAuth');
            alert('‚úÖ Logged out');
            navigate('/');
        }
        
        // Global exports
        window.navigate = navigate;
        window.navigateHome = navigateHome;
        window.selectGuests = selectGuests;
        window.handleSignup = handleSignup;
        window.handleLogin = handleLogin;
        window.handleRestaurantLogin = handleRestaurantLogin;
        window.handleJoinQueue = handleJoinQueue;
        window.allocateTable = allocateTable;
        window.logout = logout;
        window.checkAdminPassword = checkAdminPassword;
        window.adminLogout = adminLogout;
        window.handleUpgrade = handleUpgrade;
        window.confirmDowngrade = confirmDowngrade;
        window.payWithUPIApp = payWithUPIApp;
        window.previewScreenshot = previewScreenshot;
        window.submitPaymentProof = submitPaymentProof;
        window.viewScreenshot = viewScreenshot;
        window.approvePayment = approvePayment;
        window.rejectPayment = rejectPayment;
        
        // Start app
        handleRoute();
    </script>
</body>
</html>
