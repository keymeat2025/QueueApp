<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueApp - Smart Queue Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #f97316; --primary-dark: #ea580c; --secondary: #ec4899;
            --success: #22c55e; --warning: #eab308; --danger: #dc2626;
            --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
            --gray-600: #4b5563; --gray-700: #374151; --gray-900: #111827; --white: #ffffff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: var(--gray-900); background: var(--gray-50); font-size: 16px; }
        h1 { font-size: clamp(1.5rem, 4vw, 3.5rem); font-weight: 700; }
        h2 { font-size: clamp(1.25rem, 3vw, 2.5rem); font-weight: 700; }
        h3 { font-size: clamp(1.1rem, 2.5vw, 2rem); font-weight: 600; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 clamp(1rem, 3vw, 2rem); }
        nav { background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: clamp(0.75rem, 2vw, 1.5rem); position: sticky; top: 0; z-index: 100; }
        nav .nav-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        nav h1 { color: var(--primary); cursor: pointer; font-size: clamp(1.25rem, 3vw, 2rem); }
        nav .nav-buttons { display: flex; gap: clamp(0.5rem, 1.5vw, 1rem); flex-wrap: wrap; }
        button, .btn { padding: clamp(0.5rem, 1.5vw, 1rem) clamp(1rem, 3vw, 2rem); border: none; border-radius: clamp(0.5rem, 1vw, 1rem); font-size: clamp(0.875rem, 1.5vw, 1.125rem); font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; text-align: center; }
        button:hover, .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); }
        .btn-secondary { background: var(--gray-600); color: var(--white); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .card { background: var(--white); border-radius: clamp(1rem, 2vw, 2rem); padding: clamp(1.5rem, 3vw, 3rem); box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: clamp(1rem, 2vw, 2rem); }
        .grid { display: grid; gap: clamp(1rem, 2vw, 2rem); margin-bottom: clamp(1rem, 2vw, 2rem); }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(min(150px, 100%), 1fr)); }
        input, select, textarea { width: 100%; padding: clamp(0.75rem, 2vw, 1.25rem); border: 2px solid var(--gray-200); border-radius: clamp(0.5rem, 1vw, 1rem); font-size: clamp(0.875rem, 1.5vw, 1.125rem); margin-bottom: clamp(0.75rem, 1.5vw, 1.5rem); transition: border 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .badge { display: inline-block; padding: clamp(0.25rem, 0.5vw, 0.5rem) clamp(0.5rem, 1vw, 1rem); border-radius: 999px; font-size: clamp(0.75rem, 1vw, 0.875rem); font-weight: 700; }
        .badge-primary { background: var(--primary); color: var(--white); }
        .badge-warning { background: var(--warning); color: var(--white); }
        .badge-secondary { background: var(--gray-600); color: var(--white); }
        .bg-gradient { background: linear-gradient(135deg, #fff7ed 0%, #fce7f3 100%); }
        .bg-gradient-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: var(--white); }
        .display-screen { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: var(--white); min-height: 100vh; padding: clamp(1rem, 3vw, 4rem); }
        .display-screen h1 { font-size: clamp(2rem, 6vw, 6rem); margin-bottom: clamp(1rem, 3vw, 3rem); }
        .display-screen h2 { font-size: clamp(1.5rem, 4vw, 4rem); }
        .display-screen .queue-number { font-size: clamp(3rem, 10vw, 12rem); font-weight: 900; }
        .alert { padding: clamp(1rem, 2vw, 1.5rem); border-radius: clamp(0.5rem, 1vw, 1rem); margin-bottom: clamp(1rem, 2vw, 1.5rem); border: 2px solid; }
        .alert-warning { background: #fef9c3; border-color: var(--warning); color: #854d0e; }
        .alert-danger { background: #fee2e2; border-color: var(--danger); color: #991b1b; }
        .alert-success { background: #dcfce7; border-color: var(--success); color: #166534; }
        details summary { transition: all 0.3s ease; list-style: none; cursor: pointer; }
        details[open] summary { color: var(--primary); }
        details[open] summary span { transform: rotate(90deg); display: inline-block; }
        details summary::-webkit-details-marker { display: none; }
        .text-center { text-align: center; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: clamp(0.5rem, 1vw, 1rem); }
        .w-full { width: 100%; }
        .hidden { display: none; }
        .space-y > * + * { margin-top: clamp(0.75rem, 1.5vw, 1.5rem); }
        .mb { margin-bottom: clamp(1rem, 2vw, 2rem); }
        .mt { margin-top: clamp(1rem, 2vw, 2rem); }
        .loading-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; background: linear-gradient(135deg, #fff7ed 0%, #fce7f3 100%); }
        .loading-icon { font-size: clamp(3rem, 8vw, 6rem); margin-bottom: clamp(1rem, 2vw, 2rem); animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-bar { background: var(--gray-200); height: 30px; border-radius: 999px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; transition: width 0.3s ease; }
        @media (max-width: 640px) { nav .nav-buttons { width: 100%; justify-content: center; } .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
        @media (min-width: 1920px) { body { font-size: 20px; } .display-screen .queue-number { font-size: 15rem; } }
        @media (min-width: 2560px) { body { font-size: 24px; } .container { max-width: 2000px; } .display-screen .queue-number { font-size: 20rem; } }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading-screen">
            <div class="loading-icon">‚è≥</div>
            <h1>Loading QueueApp...</h1>
        </div>
    </div>
    
    <script>
        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyBQRfA1_qgG9x4w4aiDqAzAPghMEc5zE6Q",
          authDomain: "queueapp-97728.firebaseapp.com",
          projectId: "queueapp-97728",
          storageBucket: "queueapp-97728.firebasestorage.app",
          messagingSenderId: "41156558140",
          appId: "1:41156558140:web:f3277e7018176d0870f239",
          measurementId: "G-QSP7ZXNSFT"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        console.log('üî• Firebase initialized');
        
        // Firebase Admin Auth
        const FirebaseAdmin = {
            async signIn(email, password) {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            async signOut() {
                try {
                    await auth.signOut();
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            getCurrentUser() { return auth.currentUser; },
            onAuthStateChanged(callback) { return auth.onAuthStateChanged(callback); }
        };
        
        window.FirebaseAdmin = FirebaseAdmin;
        
        // Firebase Database with Analytics
        const FirebaseDB = {
            async addRestaurant(restaurantId, data) {
                try {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const today = new Date().toISOString().slice(0, 10);
                    
                    await db.collection('restaurants').doc(restaurantId).set({
                        ...data,
                        queue: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        plan: 'free',
                        planStatus: 'active',
                        analytics: {
                            currentMonth,
                            customersThisMonth: 0,
                            lastResetDate: today,
                            dailyStats: {}
                        },
                        monthlyHistory: [],
                        queueArchive: {}
                    });
                    return { success: true, id: restaurantId };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getRestaurant(restaurantId) {
                try {
                    const doc = await db.collection('restaurants').doc(restaurantId).get();
                    return doc.exists ? { success: true, data: doc.data() } : { success: false, error: 'Not found' };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getAllRestaurants() {
                try {
                    const snapshot = await db.collection('restaurants').get();
                    const restaurants = {};
                    snapshot.forEach(doc => { restaurants[doc.id] = doc.data(); });
                    return { success: true, data: restaurants };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async addToQueue(restaurantId, customer) {
                try {
                    const restaurantRef = db.collection('restaurants').doc(restaurantId);
                    const doc = await restaurantRef.get();
                    
                    if (!doc.exists) return { success: false, error: 'Restaurant not found' };
                    
                    const restaurant = doc.data();
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    const today = new Date().toISOString().slice(0, 10);
                    
                    let analytics = restaurant.analytics || {
                        currentMonth,
                        customersThisMonth: 0,
                        lastResetDate: today,
                        dailyStats: {}
                    };
                    
                    // Reset monthly count if new month
                    if (analytics.currentMonth !== currentMonth) {
                        const monthlyHistory = restaurant.monthlyHistory || [];
                        monthlyHistory.push({
                            month: analytics.currentMonth,
                            totalCustomers: analytics.customersThisMonth,
                            dailyStats: analytics.dailyStats,
                            archivedAt: new Date().toISOString()
                        });
                        
                        analytics = {
                            currentMonth,
                            customersThisMonth: 0,
                            lastResetDate: today,
                            dailyStats: {}
                        };
                        
                        await restaurantRef.update({ monthlyHistory, analytics });
                    }
                    
                    // Check FREE plan limit
                    if (restaurant.plan === 'free' && analytics.customersThisMonth >= 500) {
                        return { 
                            success: false, 
                            error: 'LIMIT_REACHED',
                            message: 'Monthly limit reached. Upgrade to Premium.',
                            customersUsed: analytics.customersThisMonth,
                            limit: 500
                        };
                    }
                    
                    const queueNumber = `A-${Math.floor(Math.random() * 900) + 100}`;
                    const queueItem = {
                        ...customer,
                        queueNumber,
                        status: 'waiting',
                        joinedAt: new Date().toISOString()
                    };
                    
                    analytics.customersThisMonth += 1;
                    analytics.dailyStats[today] = (analytics.dailyStats[today] || 0) + 1;
                    
                    await restaurantRef.update({
                        queue: firebase.firestore.FieldValue.arrayUnion(queueItem),
                        analytics
                    });
                    
                    console.log(`‚úÖ Added to queue: ${queueNumber} (${analytics.customersThisMonth}/${restaurant.plan === 'free' ? 500 : '‚àû'})`);
                    
                    return { 
                        success: true, 
                        queueNumber,
                        customersThisMonth: analytics.customersThisMonth,
                        limit: restaurant.plan === 'free' ? 500 : 'unlimited'
                    };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async allocateTable(restaurantId, queueNumber, tableNo) {
                try {
                    const result = await this.getRestaurant(restaurantId);
                    if (!result.success) return result;
                    
                    const restaurant = result.data;
                    const updatedQueue = restaurant.queue.map(q => 
                        q.queueNumber === queueNumber 
                            ? { ...q, status: 'allocated', tableNo, allocatedAt: new Date().toISOString() }
                            : q
                    );
                    
                    await db.collection('restaurants').doc(restaurantId).update({ queue: updatedQueue });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async getAnalytics(restaurantId) {
                try {
                    const doc = await db.collection('restaurants').doc(restaurantId).get();
                    if (!doc.exists) return { success: false, error: 'Not found' };
                    const restaurant = doc.data();
                    return { 
                        success: true, 
                        analytics: restaurant.analytics || {},
                        monthlyHistory: restaurant.monthlyHistory || []
                    };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async dailyCleanup(restaurantId) {
                try {
                    const restaurantRef = db.collection('restaurants').doc(restaurantId);
                    const doc = await restaurantRef.get();
                    if (!doc.exists) return { success: false, error: 'Not found' };
                    
                    const restaurant = doc.data();
                    const today = new Date().toISOString().slice(0, 10);
                    
                    const queueArchive = restaurant.queueArchive || {};
                    queueArchive[today] = {
                        date: today,
                        totalCustomers: restaurant.queue.length,
                        served: restaurant.queue.filter(q => q.status === 'allocated').length,
                        waiting: restaurant.queue.filter(q => q.status === 'waiting').length,
                        archivedAt: new Date().toISOString()
                    };
                    
                    await restaurantRef.update({
                        queue: [],
                        lastCleanup: firebase.firestore.FieldValue.serverTimestamp(),
                        queueArchive
                    });
                    
                    console.log(`‚úÖ Cleanup completed for ${restaurantId}`);
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async savePaymentProof(restaurantId, paymentData) {
                try {
                    await db.collection('restaurants').doc(restaurantId).update({
                        paymentProof: {
                            ...paymentData,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        planStatus: 'pending'
                    });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async approvePremium(restaurantId) {
                try {
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    
                    await db.collection('restaurants').doc(restaurantId).update({
                        plan: 'premium',
                        planStatus: 'active',
                        planExpiryDate: expiryDate.getTime()
                    });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            },
            
            async rejectPremium(restaurantId) {
                try {
                    await db.collection('restaurants').doc(restaurantId).update({
                        planStatus: 'rejected',
                        'paymentProof.rejectedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        };
        
        window.FirebaseDB = FirebaseDB;
        
        // Local Storage (Backup)
        const DB = {
            restaurants: JSON.parse(localStorage.getItem('restaurants') || '{}'),
            save() { localStorage.setItem('restaurants', JSON.stringify(this.restaurants)); },
            addRestaurant(id, data) { 
                const currentMonth = new Date().toISOString().slice(0, 7);
                const today = new Date().toISOString().slice(0, 10);
                this.restaurants[id] = { 
                    ...data, 
                    queue: [], 
                    plan: 'free', 
                    planStatus: 'active',
                    analytics: { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} },
                    monthlyHistory: []
                }; 
                this.save(); 
                return id; 
            },
            addToQueue(restaurantId, customer) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) return null;
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                const today = new Date().toISOString().slice(0, 10);
                
                if (!restaurant.analytics) {
                    restaurant.analytics = { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} };
                }
                
                if (restaurant.analytics.currentMonth !== currentMonth) {
                    if (!restaurant.monthlyHistory) restaurant.monthlyHistory = [];
                    restaurant.monthlyHistory.push({
                        month: restaurant.analytics.currentMonth,
                        totalCustomers: restaurant.analytics.customersThisMonth
                    });
                    restaurant.analytics = { currentMonth, customersThisMonth: 0, lastResetDate: today, dailyStats: {} };
                }
                
                if (restaurant.plan === 'free' && restaurant.analytics.customersThisMonth >= 500) return null;
                
                const queueNumber = `A-${Math.floor(Math.random() * 900) + 100}`; 
                restaurant.queue.push({ ...customer, queueNumber, status: 'waiting', joinedAt: new Date().toISOString() }); 
                restaurant.analytics.customersThisMonth += 1;
                restaurant.analytics.dailyStats[today] = (restaurant.analytics.dailyStats[today] || 0) + 1;
                this.save(); 
                return queueNumber; 
            },
            allocateTable(restaurantId, queueNumber, tableNo) { 
                const restaurant = this.restaurants[restaurantId]; 
                if (!restaurant) return false;
                const queueItem = restaurant.queue.find(q => q.queueNumber === queueNumber); 
                if (queueItem) { 
                    queueItem.status = 'allocated'; 
                    queueItem.tableNo = tableNo; 
                    queueItem.allocatedAt = new Date().toISOString(); 
                    this.save(); 
                    return true; 
                } 
                return false; 
            },
            login(restaurantId, phone) { 
                const restaurant = this.restaurants[restaurantId]; 
                return restaurant && restaurant.phone === phone; 
            },
            savePaymentProof(restaurantId, paymentData) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.paymentProof = { ...paymentData, uploadedAt: Date.now() }; 
                    restaurant.planStatus = 'pending'; 
                    this.save(); 
                    return true; 
                }
                return false;
            },
            approvePremium(restaurantId) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.plan = 'premium'; 
                    restaurant.planStatus = 'active'; 
                    const expiryDate = new Date(); 
                    expiryDate.setDate(expiryDate.getDate() + 30); 
                    restaurant.planExpiryDate = expiryDate.getTime(); 
                    this.save(); 
                    return true; 
                }
                return false;
            },
            rejectPremium(restaurantId) {
                const restaurant = this.restaurants[restaurantId];
                if (restaurant) { 
                    restaurant.planStatus = 'rejected'; 
                    if (restaurant.paymentProof) restaurant.paymentProof.rejectedAt = Date.now(); 
                    this.save(); 
                    return true; 
                }
                return false;
            }
        };
        
        window.DB = DB;
        
        // Daily Cleanup Scheduler - Runs at Midnight (12 AM IST)
        async function checkDailyCleanup() {
            const today = new Date().toISOString().slice(0, 10);
            const lastCleanupDate = localStorage.getItem('lastCleanupDate');
            
            // Cleanup when date changes (after midnight 12 AM)
            // This runs on first visit after midnight, ensuring fresh start each day
            if (lastCleanupDate !== today) {
                console.log('üßπ Daily cleanup: New day detected');
                console.log(`   Last cleanup: ${lastCleanupDate || 'Never'}`);
                console.log(`   Current date: ${today}`);
                
                try {
                    const result = await FirebaseDB.getAllRestaurants();
                    if (result.success) {
                        let cleanedCount = 0;
                        for (const [restaurantId] of Object.entries(result.data)) {
                            const cleanupResult = await FirebaseDB.dailyCleanup(restaurantId);
                            if (cleanupResult.success) cleanedCount++;
                        }
                        
                        localStorage.setItem('lastCleanupDate', today);
                        console.log(`‚úÖ Cleanup completed: ${cleanedCount} restaurants cleaned`);
                        console.log(`   Next cleanup: After midnight tomorrow`);
                    }
                } catch (error) {
                    console.error('‚ùå Cleanup error:', error);
                }
            } else {
                console.log('‚ÑπÔ∏è Cleanup already done today - Next cleanup after midnight');
            }
        }
        
        // Helper Functions
        function getLoggedInRestaurant() {
            for (let id of Object.keys(DB.restaurants)) { 
                if (sessionStorage.getItem(`loggedIn_${id}`)) 
                    return { id, data: DB.restaurants[id] }; 
            }
            return null;
        }
        
        function navigateHome() { 
            const loggedIn = getLoggedInRestaurant(); 
            loggedIn ? navigate(`/r/${loggedIn.id}/admin`) : navigate('/'); 
        }
        
        function render(html) { document.getElementById('app').innerHTML = html; }
        function navigate(path) { window.location.hash = path; }
        
        // Router
        function handleRoute() {
            const hash = window.location.hash.slice(1) || '/';
            const parts = hash.split('/').filter(Boolean);
            
            if (hash === '/' || hash === '') showHome();
            else if (hash === '/pricing') showPricing();
            else if (hash === '/terms') showLegal('Terms of Service', getTermsContent());
            else if (hash === '/privacy') showLegal('Privacy Policy', getPrivacyContent());
            else if (hash === '/signup') showSignup();
            else if (hash === '/login') showLogin();
            else if (hash === '/admin') checkFirebaseAdminAuth() ? showPlatformAdmin() : showAdminPasswordPrompt();
            else if (parts[0] === 'payment' && parts[1] && parts[2] === 'upload') showUploadScreenshot(parts[1]);
            else if (parts[0] === 'payment' && parts[1]) showPaymentPage(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'join') {
                // Check if token provided
                if (parts[3]) {
                    // Has token - verify it
                    const valid = verifyDailyToken(parts[1], parts[3]);
                    if (valid) {
                        showJoinQueue(parts[1]);
                    } else {
                        showExpiredQRPage(parts[1]);
                    }
                } else {
                    // No token - show error
                    showNoTokenPage();
                }
            }
            else if (parts[0] === 'r' && parts[2] === 'display') showDisplay(parts[1]);
            else if (parts[0] === 'r' && parts[2] === 'status' && parts[3]) showQueueStatus(parts[1], parts[3]);
            else if (parts[0] === 'r' && parts[2] === 'admin') sessionStorage.getItem(`loggedIn_${parts[1]}`) ? showRestaurantAdmin(parts[1]) : showRestaurantLogin(parts[1]);
            else render(`<div class="container text-center" style="padding-top: 4rem;"><h1>404 - Not Found</h1><button onclick="navigate('/')" class="btn btn-primary mt">Go Home</button></div>`);
        }
        
        window.onhashchange = handleRoute;
        
        // Legal Content
        function getTermsContent() {
            return `<h3>1. Acceptance</h3><p>By using QueueApp, you agree to these Terms.</p>
                <h3>2. Service</h3><p>QueueApp provides queue management, QR entry, displays, and analytics.</p>
                <h3>3. Plans</h3><p><strong>Free:</strong> 500 customers/month, basic features.<br><strong>Premium (‚Çπ2,999/month):</strong> Unlimited customers, analytics.</p>
                <h3>4. Payment</h3><p>Monthly billing. Non-refundable. Cancel anytime.</p>
                <h3>5. Contact</h3><p>support@queueapp.com</p>`;
        }
        
        function getPrivacyContent() {
            return `<h3>1. Data Collection</h3><p>Restaurant and customer info for service delivery.</p>
                <h3>2. Data Use</h3><p>Service provision, analytics, improvements.</p>
                <h3>3. Storage</h3><p>Firebase cloud storage with localStorage backup.</p>
                <h3>4. Rights</h3><p>Access, correct, delete data anytime.</p>
                <h3>5. Contact</h3><p>privacy@queueapp.com</p>`;
        }
        
        function showLegal(title, content) {
            render(`
                <div style="min-height: 100vh; background: var(--gray-50);">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1><button onclick="navigateHome()" class="btn btn-secondary">‚Üê Back</button></div></nav>
                    <div class="container" style="padding: 3rem 0; max-width: 900px;">
                        <h1 class="mb">${title}</h1>
                        <p style="color: var(--gray-600); margin-bottom: 2rem;">Last Updated: December 2024</p>
                        <div class="card"><div class="space-y">${content}</div></div>
                        <div class="text-center mt"><button onclick="navigateHome()" class="btn btn-primary">Back</button></div>
                    </div>
                </div>
            `);
        }
        
        // Home Page
        function showHome() {
            render(`
                <div class="bg-gradient" style="min-height: 100vh;">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1>
                    <div class="nav-buttons">
                        <button onclick="navigate('/pricing')" class="btn btn-secondary">Pricing</button>
                        <button onclick="navigate('/login')" class="btn btn-secondary">Login</button>
                        <button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button>
                    </div></div></nav>
                    <main class="container text-center" style="padding: clamp(2rem, 5vw, 8rem) 0;">
                        <h1 style="margin-bottom: 1rem;">Smart Queue Management</h1>
                        <p style="font-size: clamp(1.125rem, 2vw, 1.5rem); color: var(--gray-600); margin-bottom: 2rem;">No more crowded entrances. Happy customers.</p>
                        <div class="grid grid-3 mb">
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üì±</div><h3>Digital Queue</h3><p style="color: var(--gray-600);">QR code entry</p></div>
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üì∫</div><h3>Live Display</h3><p style="color: var(--gray-600);">Real-time updates</p></div>
                            <div class="card text-center"><div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div><h3>Analytics</h3><p style="color: var(--gray-600);">Track customer flow</p></div>
                        </div>
                        <button onclick="navigate('/signup')" class="btn btn-primary" style="font-size: 1.5rem; padding: 1.5rem 3rem;">Start Free Forever</button>
                        <p style="margin-top: 1rem; color: var(--gray-600);">500 customers/month free ‚Ä¢ No credit card</p>
                    </main>
                    <footer style="background: white; border-top: 2px solid var(--gray-200); padding: 2rem 0; margin-top: 4rem;">
                        <div class="container text-center">
                            <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button onclick="navigate('/terms')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; text-decoration: underline;">Terms</button>
                                <button onclick="navigate('/privacy')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; text-decoration: underline;">Privacy</button>
                                <a href="mailto:support@queueapp.com" style="color: var(--gray-600); text-decoration: underline;">Support</a>
                            </div>
                            <p style="color: var(--gray-500); font-size: 0.875rem;">¬© 2024 QueueApp</p>
                        </div>
                    </footer>
                </div>
            `);
        }

        // Pricing Page (abbreviated)
        function showPricing() {
            const loggedIn = getLoggedInRestaurant();
            const restaurant = loggedIn?.data;
            const restaurantId = loggedIn?.id;
            const currentPlan = restaurant?.plan || 'free';
            const planStatus = restaurant?.planStatus || 'active';
            
            const navButtons = loggedIn 
                ? `<div class="flex gap-1 flex-wrap items-center">
                     <span style="font-weight: 600;">${restaurant.name}</span>
                     <span class="badge ${currentPlan === 'premium' ? 'badge-primary' : planStatus === 'pending' ? 'badge-warning' : 'badge-secondary'}">${planStatus === 'pending' ? 'PENDING' : currentPlan.toUpperCase()}</span>
                     <button onclick="navigate('/r/${restaurantId}/admin')" class="btn btn-secondary">Dashboard</button>
                     <button onclick="logout('${restaurantId}')" class="btn btn-danger">Logout</button>
                   </div>`
                : `<div class="nav-buttons"><button onclick="navigate('/login')" class="btn btn-secondary">Login</button><button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button></div>`;
            
            let premiumCTA = loggedIn && currentPlan === 'premium' && planStatus === 'active' 
                ? `<button class="btn btn-success w-full" disabled style="opacity: 0.7;">‚úì Current Plan</button>`
                : loggedIn && planStatus === 'pending'
                ? `<button class="btn btn-warning w-full" disabled style="opacity: 0.7;">‚è≥ Pending</button>`
                : loggedIn && currentPlan === 'free'
                ? `<button onclick="handleUpgrade('${restaurantId}')" class="btn w-full" style="background: white; color: var(--primary);">Upgrade Now</button>`
                : `<button onclick="navigate('/signup')" class="btn w-full" style="background: white; color: var(--primary);">Get Started</button>`;

            render(`
                <div class="bg-gradient" style="min-height: 100vh;">
                    <nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1>${navButtons}</div></nav>
                    <div class="container" style="padding: 2rem 0;">
                        <div class="text-center mb"><h1>Simple Pricing</h1><p style="font-size: 1.25rem; color: var(--gray-600);">Start free. Upgrade anytime.</p></div>
                        <div class="grid grid-2" style="max-width: 1200px; margin: 0 auto;">
                            <div class="card">
                                <div class="text-center">
                                    <p style="color: var(--success); font-weight: 700; font-size: 0.875rem; margin-bottom: 1rem;">FREE FOREVER</p>
                                    <h3>Free</h3>
                                    <div style="font-size: 4rem; font-weight: 900; margin: 1rem 0;">‚Çπ0<span style="font-size: 1.5rem; color: var(--gray-600);">/mo</span></div>
                                    <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 2rem;">500 customers/month</p>
                                </div>
                                <div class="space-y">
                                    <p>‚úì Digital queue</p>
                                    <p>‚úì QR code entry</p>
                                    <p>‚úì Live display</p>
                                    <p>‚úì Basic analytics</p>
                                </div>
                            </div>
                            <div class="card bg-gradient-primary" style="transform: scale(1.05);">
                                <div class="text-center">
                                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem; opacity: 0.9;">MOST POPULAR</p>
                                    <h3>Premium</h3>
                                    <div style="font-size: 4rem; font-weight: 900; margin: 1rem 0;">‚Çπ2,999<span style="font-size: 1.5rem; opacity: 0.8;">/mo</span></div>
                                    <p style="opacity: 0.9; margin-bottom: 2rem;">Unlimited customers</p>
                                </div>
                                <div class="space-y">
                                    <p>‚úì Everything in Free</p>
                                    <p>‚úì Unlimited customers</p>
                                    <p>‚úì Advanced analytics</p>
                                    <p>‚úì Priority support</p>
                                </div>
                                <div class="mt">${premiumCTA}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        // Payment Pages (simplified)
        function showPaymentPage(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) { render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`); return; }

            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #faf5ff 0%, #eff6ff 100%); padding: 2rem;">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h2>Upgrade to Premium</h2>
                        <p style="color: var(--gray-600);">${restaurant.name}</p>
                        <div class="card bg-gradient-primary text-center mb">
                            <p>Total Amount</p>
                            <div style="font-size: 5rem; font-weight: 900;">‚Çπ2,999</div>
                            <p style="opacity: 0.9;">per month ‚Ä¢ 30 days</p>
                        </div>
                        <div class="card text-center" style="background: var(--gray-50);">
                            <p style="color: var(--gray-600);">UPI ID</p>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary); font-family: monospace;">sriramvasudev@okhdfcbank</p>
                        </div>
                        <div class="card text-center" style="background: var(--gray-50);">
                            <p style="font-weight: 600; margin-bottom: 1rem;">Scan QR Code</p>
                            <div id="payment-qr" style="display: inline-block; padding: 1rem; background: white; border-radius: 1rem;"></div>
                        </div>
                        <button onclick="navigate('/payment/${restaurantId}/upload')" class="btn btn-success w-full">I've Paid ‚Üí Upload Screenshot</button>
                    </div>
                </div>
            `);

            setTimeout(() => {
                const upiString = `upi://pay?pa=sriramvasudev@okhdfcbank&pn=QueueApp&am=2999&cu=INR&tn=QueueApp-${restaurantId}`;
                new QRCode(document.getElementById('payment-qr'), { text: upiString, width: 200, height: 200 });
            }, 100);
        }

        function showUploadScreenshot(restaurantId) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 2rem;">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h2 class="text-center">Upload Payment Proof</h2>
                        <div class="space-y">
                            <input type="text" id="transactionId" placeholder="Transaction ID / UTR">
                            <div class="card text-center" style="border: 2px dashed var(--gray-200); cursor: pointer;" onclick="document.getElementById('screenshotFile').click()">
                                <input type="file" id="screenshotFile" accept="image/*" onchange="previewScreenshot()" class="hidden">
                                <button type="button" class="btn btn-primary" style="pointer-events: none;">üì∑ Choose Screenshot</button>
                            </div>
                            <div id="screenshotPreview" class="hidden mt">
                                <img id="previewImage" class="w-full" style="border: 2px solid var(--gray-200); border-radius: 1rem;" />
                            </div>
                            <button onclick="submitPaymentProof('${restaurantId}')" class="btn btn-success w-full">Submit</button>
                        </div>
                    </div>
                </div>
            `);
        }

        function previewScreenshot() {
            const file = document.getElementById('screenshotFile').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('screenshotPreview').classList.remove('hidden');
                    document.getElementById('previewImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function submitPaymentProof(restaurantId) {
            const transactionId = document.getElementById('transactionId').value.trim();
            const fileInput = document.getElementById('screenshotFile');
            if (!transactionId || !fileInput.files[0]) { alert('‚ö†Ô∏è Fill all fields'); return; }

            const reader = new FileReader();
            reader.onload = async function(e) {
                await FirebaseDB.savePaymentProof(restaurantId, { screenshot: e.target.result, transactionId, amount: 2999 });
                DB.savePaymentProof(restaurantId, { screenshot: e.target.result, transactionId, amount: 2999 });
                alert('‚úÖ Submitted! Verification takes 2-24 hours.');
                navigate(`/r/${restaurantId}/admin`);
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
        
        function handleUpgrade(restaurantId) { navigate(`/payment/${restaurantId}`); }
        
        // Auth Pages
        function showLogin() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Restaurant Login</h2>
                        <div class="space-y">
                            <input type="text" id="loginRestaurantId" placeholder="Restaurant ID">
                            <input type="tel" id="loginPhone" placeholder="Phone" maxlength="10">
                            <button onclick="handleLogin(event)" class="btn btn-primary w-full">Login</button>
                            <p class="text-center" style="font-size: 0.875rem;">No account? <button onclick="navigate('/signup')" style="background: none; border: none; color: var(--primary); font-weight: 600; text-decoration: underline; cursor: pointer;">Sign Up</button></p>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function handleLogin(event) {
            const restaurantId = document.getElementById('loginRestaurantId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            if (!restaurantId || !phone) { alert('‚ö†Ô∏è Fill all fields'); return; }
            
            const btn = event.target;
            btn.textContent = 'Logging in...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseDB.getRestaurant(restaurantId);
                
                if (result.success && result.data.phone === phone) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    DB.restaurants[restaurantId] = result.data;
                    DB.save();
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else if (DB.login(restaurantId, phone)) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else {
                    alert('‚ùå Invalid credentials');
                    btn.textContent = 'Login';
                    btn.disabled = false;
                }
            } catch (error) {
                if (DB.login(restaurantId, phone)) {
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    setTimeout(() => navigate(`/r/${restaurantId}/admin`), 100);
                } else {
                    alert(`‚ùå Error: ${error.message}`);
                    btn.textContent = 'Login';
                    btn.disabled = false;
                }
            }
        }
        
        function showRestaurantLogin(restaurantId) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Login Required</h2>
                        <input type="tel" id="restaurantLoginPhone" placeholder="Phone" maxlength="10">
                        <button onclick="handleRestaurantLogin('${restaurantId}')" class="btn btn-primary w-full mt">Login</button>
                    </div>
                </div>
            `);
        }
        
        function handleRestaurantLogin(restaurantId) {
            const phone = document.getElementById('restaurantLoginPhone').value.trim();
            if (!phone) { alert('Enter phone'); return; }
            if (DB.login(restaurantId, phone)) { 
                sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true'); 
                handleRoute(); 
            } else { 
                alert('‚ùå Invalid'); 
            }
        }
        
        function showSignup() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 700px; width: 100%;">
                        <h2 class="text-center mb">Register Restaurant</h2>
                        <div class="space-y">
                            <input type="text" id="restaurantName" placeholder="Restaurant Name">
                            <input type="text" id="ownerName" placeholder="Owner Name">
                            <input type="email" id="email" placeholder="Email">
                            <input type="tel" id="phone" placeholder="Phone (10 digits)" maxlength="10">
                            <input type="text" id="city" placeholder="Location (e.g., Mumbai - Andheri)">
                            <div class="flex gap-1">
                                <input type="checkbox" id="agreeTerms">
                                <label for="agreeTerms" style="font-size: 0.875rem;">I agree to Terms & Privacy</label>
                            </div>
                            <button onclick="handleSignup(event)" class="btn btn-primary w-full">Register</button>
                            <p class="text-center" style="font-size: 0.875rem;">Have account? <button onclick="navigate('/login')" style="background: none; border: none; color: var(--primary); font-weight: 600; text-decoration: underline; cursor: pointer;">Login</button></p>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function handleSignup(event) {
            const name = document.getElementById('restaurantName').value.trim();
            const owner = document.getElementById('ownerName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const city = document.getElementById('city').value.trim();
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            if (!name || !owner || !email || !phone || !city) { alert('‚ö†Ô∏è Fill all fields'); return; }
            if (!agreeTerms) { alert('‚ö†Ô∏è Agree to terms'); return; }
            
            const btn = event.target;
            btn.textContent = 'Registering...';
            btn.disabled = true;
            
            try {
                const restaurantId = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X') + Math.floor(Math.random() * 10000);
                const result = await FirebaseDB.addRestaurant(restaurantId, { name, owner, email, phone, city });
                
                if (result.success) {
                    DB.addRestaurant(restaurantId, { name, owner, email, phone, city });
                    sessionStorage.setItem(`loggedIn_${restaurantId}`, 'true');
                    
                    // Show success screen with QR code
                    showRegistrationSuccess(restaurantId, name);
                } else {
                    alert(`‚ùå Failed: ${result.error}`);
                    btn.textContent = 'Register';
                    btn.disabled = false;
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                btn.textContent = 'Register';
                btn.disabled = false;
            }
        }
        
        function showRegistrationSuccess(restaurantId, restaurantName) {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 600px; width: 100%; text-align: center;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">üéâ</div>
                        <h1 style="color: var(--success); margin-bottom: 1rem;">Registration Successful!</h1>
                        
                        <div class="card" style="background: var(--gray-50); margin: 2rem 0;">
                            <h2>${restaurantName}</h2>
                            <p style="font-size: 1.25rem; margin: 0.5rem 0;">Restaurant ID: <strong style="font-family: monospace; color: var(--primary);">${restaurantId}</strong></p>
                            <span class="badge badge-secondary">FREE PLAN ‚Ä¢ 500 Customers/Month</span>
                        </div>
                        
                        <div class="card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 3px solid #3b82f6;">
                            <h3 style="color: #1e40af; margin-bottom: 1rem;">üì∫ Customer Entry QR Code</h3>
                            <div style="font-size: 3rem; margin: 1rem 0;">üñ•Ô∏è</div>
                            <p style="color: var(--gray-700); font-size: 1.125rem; margin-bottom: 1rem; line-height: 1.6;">
                                Your <strong>daily QR code</strong> is displayed on your TV screen. It automatically refreshes at midnight for security.
                            </p>
                            
                            <div class="card" style="background: white; margin: 1.5rem 0; padding: 1.5rem;">
                                <h4 style="color: var(--primary); margin-bottom: 1rem;">üîí Why Daily QR?</h4>
                                <ul style="text-align: left; color: var(--gray-600); line-height: 1.8; margin-left: 1.5rem;">
                                    <li>Prevents remote queue joining</li>
                                    <li>Customers must be at your restaurant</li>
                                    <li>Automatic daily refresh (no work for you!)</li>
                                    <li>Fair system for everyone</li>
                                </ul>
                            </div>
                            
                            <button onclick="navigate('/r/${restaurantId}/display')" class="btn w-full" style="background: #2563eb; color: white; font-size: 1.125rem; padding: 1.25rem; margin-top: 1rem;">
                                üì∫ Open Display Screen (with QR)
                            </button>
                        </div>
                        
                        <div class="alert alert-success mt">
                            <strong>‚úÖ Important:</strong> Save your Restaurant ID <code style="background: rgba(0,0,0,0.1); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${restaurantId}</code> - you'll need it to login!
                        </div>
                        
                        <button onclick="navigate('/r/${restaurantId}/admin')" class="btn btn-primary w-full" style="font-size: 1.25rem; padding: 1.5rem;">
                            Go to Dashboard ‚Üí
                        </button>
                    </div>
                </div>
            `);
        }
        
        // Customer Queue
        function showJoinQueue(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) { render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`); return; }
            
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">Join Queue</h2>
                        <p class="text-center mb" style="color: var(--gray-600);">${restaurant.name}</p>
                        <div class="space-y">
                            <input type="text" id="customerName" placeholder="Your Name">
                            <input type="tel" id="customerPhone" placeholder="Mobile" maxlength="10">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Guests</label>
                                <div class="grid grid-4">${[1,2,3,4,5,6,7,8].map(n => `<button onclick="selectGuests(${n})" id="guest-${n}" class="btn ${n === 2 ? 'btn-primary' : 'btn-secondary'}">${n}</button>`).join('')}</div>
                            </div>
                            <button onclick="handleJoinQueue('${restaurantId}')" class="btn btn-primary w-full">Join Queue</button>
                        </div>
                    </div>
                </div>
            `);
            window.selectedGuests = 2;
        }
        
        function selectGuests(n) {
            window.selectedGuests = n;
            document.querySelectorAll('[id^="guest-"]').forEach(btn => btn.className = 'btn btn-secondary');
            document.getElementById(`guest-${n}`).className = 'btn btn-primary';
        }
        
        async function handleJoinQueue(restaurantId) {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const guests = window.selectedGuests || 2;
            if (!name || !phone) { alert('‚ö†Ô∏è Fill all fields'); return; }
            
            const btn = event.target;
            btn.textContent = 'Joining...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseDB.addToQueue(restaurantId, { name, phone, guests });
                
                if (result.success) {
                    DB.addToQueue(restaurantId, { name, phone, guests });
                    let msg = `‚úÖ You're in!\n\nNumber: ${result.queueNumber}\n\nWatch the display!`;
                    if (result.limit !== 'unlimited') msg += `\n\nüìä Usage: ${result.customersThisMonth}/${result.limit}`;
                    alert(msg);
                    navigate(`/r/${restaurantId}/status/${result.queueNumber}`);
                } else if (result.error === 'LIMIT_REACHED') {
                    showUpgradeModal(restaurantId, result);
                    btn.textContent = 'Join Queue';
                    btn.disabled = false;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
                btn.textContent = 'Join Queue';
                btn.disabled = false;
            }
        }
        
        function showUpgradeModal(restaurantId, result) {
            render(`
                <div style="min-height: 100vh; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 600px; border: 3px solid var(--warning);">
                        <div class="text-center">
                            <div style="font-size: 5rem;">üö´</div>
                            <h2 style="color: var(--warning); margin: 1rem 0;">Monthly Limit Reached</h2>
                            <p style="font-size: 1.25rem; margin-bottom: 1rem;">Free plan limit of <strong>500 customers/month</strong> reached.</p>
                            <div class="card" style="background: #fef9c3; margin: 2rem 0;">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--warning);">${result.customersUsed} / ${result.limit}</div>
                                <p>Customers this month</p>
                            </div>
                            <p style="margin-bottom: 2rem; color: var(--gray-600);">Restaurant needs Premium for unlimited customers.</p>
                            <div class="flex gap-1" style="justify-content: center;">
                                <button onclick="navigate('/r/${restaurantId}/join')" class="btn btn-secondary">‚Üê Back</button>
                                <button onclick="navigate('/pricing')" class="btn btn-primary">Learn More</button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        
        // Expired QR Code Page
        function showExpiredQRPage(restaurantId) {
            const restaurant = DB.restaurants[restaurantId] || { name: 'Restaurant' };
            
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 600px; text-align: center; border: 3px solid var(--danger);">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">‚è∞</div>
                        <h1 style="color: var(--danger); margin-bottom: 1rem;">QR Code Expired</h1>
                        
                        <p style="font-size: 1.25rem; color: var(--gray-700); margin-bottom: 2rem;">
                            This QR code is no longer valid. Our QR codes refresh daily at midnight for your security.
                        </p>
                        
                        <div class="card" style="background: var(--gray-50); margin-bottom: 2rem;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üìç To Join the Queue:</h3>
                            <ol style="text-align: left; margin-left: 2rem; color: var(--gray-600); line-height: 2;">
                                <li>Visit <strong>${restaurant.name}</strong> in person</li>
                                <li>Scan the QR code displayed on the TV screen</li>
                                <li>Join the queue instantly with today's code</li>
                            </ol>
                        </div>
                        
                        <div class="alert" style="background: #eff6ff; border: 2px solid #3b82f6; padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üí°</div>
                            <strong style="color: #1e40af;">Why daily QR codes?</strong><br>
                            <p style="color: var(--gray-700); margin-top: 0.5rem; line-height: 1.6;">
                                Daily rotating QR codes ensure fair service by preventing remote queue joining. 
                                This keeps wait times accurate for everyone at the restaurant!
                            </p>
                        </div>
                        
                        <button onclick="navigate('/')" class="btn btn-primary w-full" style="font-size: 1.125rem; padding: 1.25rem;">
                            Go to Homepage
                        </button>
                    </div>
                </div>
            `);
        }
        
        // No Token Page
        function showNoTokenPage() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 600px; text-align: center; border: 3px solid var(--danger);">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">üö´</div>
                        <h1 style="color: var(--danger); margin-bottom: 1rem;">Invalid Access</h1>
                        
                        <p style="font-size: 1.25rem; color: var(--gray-700); margin-bottom: 2rem;">
                            Please scan the QR code displayed at the restaurant to join the queue.
                        </p>
                        
                        <div class="card" style="background: var(--gray-50); margin-bottom: 2rem;">
                            <h3 style="color: var(--primary); margin-bottom: 1rem;">üì± How to Join:</h3>
                            <ol style="text-align: left; margin-left: 2rem; color: var(--gray-600); line-height: 2;">
                                <li>Visit the restaurant</li>
                                <li>Find the QR code on the display screen</li>
                                <li>Scan with your phone camera</li>
                                <li>Fill in your details and join</li>
                            </ol>
                        </div>
                        
                        <button onclick="navigate('/')" class="btn btn-primary w-full" style="font-size: 1.125rem; padding: 1.25rem;">
                            Go to Homepage
                        </button>
                    </div>
                </div>
            `);
        }
        
        // Full Page QR Code for Printing
        function showFullPageQR(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) {
                render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`);
                return;
            }
            
            render(`
                <div style="min-height: 100vh; background: white; display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div style="text-align: center; max-width: 800px;">
                        <h1 style="color: var(--primary); margin-bottom: 1rem; font-size: 3rem;">${restaurant.name}</h1>
                        <h2 style="color: var(--gray-600); margin-bottom: 3rem; font-size: 2rem;">Scan to Join Queue</h2>
                        
                        <div id="fullpage-qr" style="display: inline-block; padding: 2rem; background: white; border: 4px solid var(--primary); border-radius: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1);"></div>
                        
                        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--gray-50); border-radius: 1rem;">
                            <p style="font-size: 1.5rem; color: var(--gray-700); font-weight: 600;">üì± Open your camera and scan</p>
                            <p style="font-size: 1.25rem; color: var(--gray-600); margin-top: 0.5rem;">No app needed ‚Ä¢ Free entry ‚Ä¢ Get your queue number instantly</p>
                        </div>
                        
                        <div style="margin-top: 3rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;" class="no-print">
                            <button onclick="window.print()" class="btn btn-primary" style="font-size: 1.25rem; padding: 1rem 2rem;">üñ®Ô∏è Print This Page</button>
                            <button onclick="downloadQR('${restaurantId}', '${restaurant.name}')" class="btn btn-secondary" style="font-size: 1.25rem; padding: 1rem 2rem;">üì• Download QR</button>
                            <button onclick="navigate('/r/${restaurantId}/admin')" class="btn" style="background: var(--gray-600); color: white; font-size: 1.25rem; padding: 1rem 2rem;">‚Üê Back to Dashboard</button>
                        </div>
                    </div>
                </div>
                <style>
                    @media print {
                        .no-print { display: none !important; }
                        body { background: white !important; }
                    }
                </style>
            `);
            
            setTimeout(() => generateQRCode('fullpage-qr', restaurantId, 400), 100);
        }
        
        function showQueueStatus(restaurantId, queueNumber) {
            const restaurant = DB.restaurants[restaurantId];
            if (!restaurant) return;
            const myQueue = restaurant.queue.find(q => q.queueNumber === queueNumber);
            if (!myQueue) { render(`<div class="container text-center" style="padding-top: 4rem;"><h1>Not Found</h1><button onclick="navigate('/r/${restaurantId}/join')" class="btn btn-primary mt">Join Queue</button></div>`); return; }
            
            if (myQueue.status === 'allocated') {
                render(`<div style="min-height: 100vh; background: var(--success); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <h1 style="margin-bottom: 2rem;">üéâ Table Ready!</h1>
                        <div class="card" style="background: white; color: var(--gray-900);">
                            <div style="font-size: 12rem; font-weight: 900; color: var(--success);">${myQueue.tableNo}</div>
                            <p style="font-size: 2rem;">Queue: ${queueNumber}</p>
                        </div>
                    </div>
                </div>`);
            } else {
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const position = waiting.findIndex(q => q.queueNumber === queueNumber) + 1;
                render(`<div style="min-height: 100vh; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; padding: 2rem;">
                    <div class="text-center">
                        <h1 style="margin-bottom: 2rem;">Still in Queue</h1>
                        <div class="card" style="background: white; color: var(--gray-900);">
                            <div style="font-size: 12rem; font-weight: 900; color: var(--primary);">${queueNumber}</div>
                            <p style="font-size: 2rem;">Position: #${position}</p>
                        </div>
                        <button onclick="navigate('/r/${restaurantId}/display')" class="btn btn-primary mt" style="background: white; color: var(--primary);">View Display</button>
                    </div>
                </div>`);
            }
        }
        
        // TV Display - Real-time
        let displayUnsubscribe = null;
        
        async function showDisplay(restaurantId) {
            if (displayUnsubscribe) displayUnsubscribe();
            
            displayUnsubscribe = db.collection('restaurants').doc(restaurantId).onSnapshot((doc) => {
                if (!doc.exists) {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`);
                    return;
                }
                
                const restaurant = doc.data();
                DB.restaurants[restaurantId] = restaurant;
                DB.save();
                
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const allocated = restaurant.queue.filter(q => q.status === 'allocated');
                const justCalled = allocated.slice(-3);
                
                render(`
                    <div class="display-screen">
                        <div class="container">
                            <div class="text-center mb" style="padding-bottom: 2rem; border-bottom: 4px solid var(--primary);">
                                <h1 style="color: var(--primary);">${restaurant.name}</h1>
                                <p style="font-size: 2rem; color: rgba(255,255,255,0.7);">Queue Management</p>
                                <div style="font-size: 3rem; color: var(--primary); font-weight: 700; margin-top: 0.5rem;">${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
                                <div style="font-size: 1.25rem; color: #10b981; margin-top: 0.5rem;">üî• Live</div>
                            </div>
                            
                            ${justCalled.length > 0 ? `
                            <div class="card mb" style="background: linear-gradient(135deg, rgba(22, 163, 74, 0.9), rgba(21, 128, 61, 0.9)); border: 4px solid var(--success); padding: 4rem;">
                                <h2 class="text-center" style="font-size: 5rem; margin-bottom: 2rem;"><span style="font-size: 8rem; animation: pulse 2s infinite;">üîî</span>NOW SERVING</h2>
                                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                    ${justCalled.map(a => `
                                        <div class="card text-center" style="background: white; padding: 4rem; border: 4px solid white;">
                                            <div style="font-size: 12rem; font-weight: 900; color: var(--success); line-height: 1;">${a.queueNumber}</div>
                                            <div style="font-size: 6rem; font-weight: 800; color: var(--gray-900);">Table ${a.tableNo}</div>
                                            <div style="font-size: 3rem; color: var(--gray-600);">${a.guests} ${a.guests === 1 ? 'guest' : 'guests'}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : `<div class="card text-center mb" style="background: rgba(55, 65, 81, 0.5); padding: 4rem;"><p style="font-size: 4rem; color: rgba(255,255,255,0.6);">‚è≥ Waiting...</p></div>`}
                            
                            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                                <div class="card" style="background: rgba(249, 115, 22, 0.2); border: 3px solid var(--primary); padding: 3rem;">
                                    <h2 class="text-center" style="color: var(--primary); margin-bottom: 2rem; font-size: 4rem;">‚è≥ Waiting (${waiting.length})</h2>
                                    <div style="max-height: 60vh; overflow-y: auto;"><div class="space-y">
                                        ${waiting.length > 0 ? waiting.slice(0, 15).map((w, i) => `
                                            <div class="card" style="background: ${i < 3 ? 'rgba(249, 115, 22, 0.9)' : 'rgba(55, 65, 81, 0.8)'}; padding: 2rem; border: ${i < 3 ? '3px solid var(--primary)' : '2px solid rgba(156, 163, 175, 0.3)'};">
                                                <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 6rem; font-weight: 900; color: ${i < 3 ? '#ffffff' : 'var(--primary)'};">${w.queueNumber}</div>
                                                        ${i < 3 ? '<div style="font-size: 1.5rem; color: #fef9c3; font-weight: 700;">üîú NEXT</div>' : ''}
                                                        <div style="font-size: 1.5rem; color: ${i < 3 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.7)'};">${w.guests} guest${w.guests !== 1 ? 's' : ''}</div>
                                                    </div>
                                                    <div style="text-align: right;">
                                                        <div style="font-size: 5rem; font-weight: 900; color: ${i < 3 ? '#ffffff' : 'rgba(255,255,255,0.7)'};">#${i + 1}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('') : '<p class="text-center" style="color: rgba(255,255,255,0.6); font-size: 2rem; padding: 2rem;">No customers</p>'}
                                    </div></div>
                                </div>
                                
                                <div class="card" style="background: rgba(168, 85, 247, 0.2); border: 3px solid #9333ea; padding: 3rem;">
                                    <h2 class="text-center" style="color: #c084fc; margin-bottom: 2rem; font-size: 3rem;">üìä Stats</h2>
                                    <div class="grid grid-2" style="gap: 2rem;">
                                        <div class="card text-center" style="background: rgba(255, 255, 255, 0.1); padding: 2rem;">
                                            <div style="font-size: 7rem; font-weight: 900; color: var(--primary);">${waiting.length}</div>
                                            <div style="font-size: 1.5rem; color: white; margin-top: 0.5rem;">Waiting</div>
                                        </div>
                                        <div class="card text-center" style="background: rgba(255, 255, 255, 0.1); padding: 2rem;">
                                            <div style="font-size: 7rem; font-weight: 900; color: var(--success);">${allocated.length}</div>
                                            <div style="font-size: 1.5rem; color: white; margin-top: 0.5rem;">Seated</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt" style="padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.2);"><p style="font-size: 2rem; color: rgba(255,255,255,0.5);">‚ö° QueueApp</p></div>
                            
                            <!-- Daily QR Code Corner -->
                            <div style="position: fixed; bottom: 2rem; right: 2rem; background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
                                <div id="qr-display-${restaurantId}" style="margin-bottom: 0.5rem;"></div>
                                <p style="text-align: center; color: var(--gray-900); font-weight: 700; font-size: 1.25rem; margin-bottom: 0.25rem;">Scan to Join</p>
                                <p style="text-align: center; color: var(--gray-600); font-size: 0.875rem;">Valid until midnight ‚è∞</p>
                            </div>
                        </div>
                    </div>
                `);
                
                // Generate daily QR code with auto-refresh
                setTimeout(() => {
                    const containerId = `qr-display-${restaurantId}`;
                    generateDailyQRCode(containerId, restaurantId, 150);
                    scheduleQRRefresh(restaurantId, containerId, 150);
                }, 100);
            });
        }
        
        // Restaurant Admin - Real-time
        let adminUnsubscribe = null;
        
        async function showRestaurantAdmin(restaurantId) {
            if (adminUnsubscribe) adminUnsubscribe();
            
            adminUnsubscribe = db.collection('restaurants').doc(restaurantId).onSnapshot(async (doc) => {
                if (!doc.exists) {
                    render(`<div class="container text-center" style="padding-top: 4rem;"><h1 style="color: var(--danger);">Not found</h1></div>`);
                    return;
                }
                
                const restaurant = doc.data();
                DB.restaurants[restaurantId] = restaurant;
                DB.save();
                
                const waiting = restaurant.queue.filter(q => q.status === 'waiting');
                const allocated = restaurant.queue.filter(q => q.status === 'allocated');
                
                // Get analytics
                const analyticsResult = await FirebaseDB.getAnalytics(restaurantId);
                const analytics = analyticsResult.success ? analyticsResult.analytics : {};
                const customersThisMonth = analytics.customersThisMonth || 0;
                const limit = restaurant.plan === 'free' ? 500 : 'unlimited';
                const percentage = restaurant.plan === 'free' ? Math.round((customersThisMonth / 500) * 100) : 0;
                
                const currentPlan = restaurant.plan || 'free';
                const planStatus = restaurant.planStatus || 'active';
                const planBadge = `<span class="badge ${currentPlan === 'premium' && planStatus === 'active' ? 'badge-primary' : planStatus === 'pending' ? 'badge-warning' : 'badge-secondary'}">${planStatus === 'pending' ? 'PENDING' : currentPlan.toUpperCase()}</span>`;
                
                render(`
                    <div style="min-height: 100vh; background: var(--gray-100); padding: 2rem;">
                        <div class="container">
                            <div class="card mb flex justify-between items-center flex-wrap gap-1">
                                <div>
                                    <h1 onclick="navigateHome()" style="cursor: pointer;">QueueApp</h1>
                                    <p style="color: var(--gray-600);">${restaurant.name} ${planBadge}</p>
                                    <p style="color: #10b981; font-size: 0.875rem;">üî• Live</p>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="navigate('/pricing')" class="btn" style="background: #2563eb; color: white;">${currentPlan === 'free' && planStatus !== 'pending' ? 'Upgrade' : 'Plan'}</button>
                                    <button onclick="logout('${restaurantId}')" class="btn btn-danger">Logout</button>
                                </div>
                            </div>
                            
                            ${planStatus === 'pending' ? '<div class="alert alert-warning mb">‚è≥ Premium upgrade pending</div>' : ''}
                            
                            ${restaurant.plan === 'free' ? `
                            <div class="card mb" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                                <h2 style="margin-bottom: 1rem;">üìä Monthly Usage</h2>
                                <div class="grid grid-3">
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: ${percentage > 80 ? 'var(--danger)' : 'var(--primary)'};">${customersThisMonth}</div>
                                        <p style="color: var(--gray-600);">This Month</p>
                                    </div>
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: var(--gray-600);">${limit}</div>
                                        <p style="color: var(--gray-600);">Limit</p>
                                    </div>
                                    <div class="card text-center" style="background: white;">
                                        <div style="font-size: 3rem; font-weight: 900; color: ${percentage > 80 ? 'var(--danger)' : 'var(--success)'};">${500 - customersThisMonth}</div>
                                        <p style="color: var(--gray-600);">Remaining</p>
                                    </div>
                                </div>
                                <div class="progress-bar mt">
                                    <div class="progress-fill" style="background: ${percentage > 80 ? 'var(--danger)' : 'var(--success)'}; width: ${percentage}%;">${percentage}%</div>
                                </div>
                                ${percentage > 80 ? '<div class="alert alert-warning mt">‚ö†Ô∏è Approaching limit! <button onclick="navigate(\'/pricing\')" class="btn btn-primary" style="margin-left: 1rem;">Upgrade</button></div>' : ''}
                            </div>
                            ` : ''}
                            
                            <div class="grid grid-2 mb">
                                <div class="card" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);">
                                    <div style="font-size: 3rem; font-weight: 900; color: var(--primary);">${waiting.length}</div>
                                    <p style="color: var(--gray-600);">Waiting</p>
                                </div>
                                <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                    <div style="font-size: 3rem; font-weight: 900; color: var(--success);">${allocated.length}</div>
                                    <p style="color: var(--gray-600);">Seated</p>
                                </div>
                            </div>
                            
                            <div class="card mb" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6;">
                                <h2 style="color: #1e40af; margin-bottom: 1rem;">üì∫ Customer Entry QR Code</h2>
                                <div class="grid grid-2" style="gap: 2rem; align-items: center;">
                                    <div style="font-size: 8rem; text-align: center;">üñ•Ô∏è</div>
                                    <div>
                                        <p style="color: var(--gray-700); margin-bottom: 1rem; font-weight: 600; font-size: 1.125rem;">
                                            Your daily QR code is displayed on your TV screen
                                        </p>
                                        <div class="card" style="background: white; padding: 1.25rem; margin-bottom: 1rem;">
                                            <h4 style="color: var(--primary); margin-bottom: 0.75rem;">üîí Security Features:</h4>
                                            <ul style="text-align: left; color: var(--gray-600); line-height: 1.8; margin-left: 1.5rem; font-size: 0.95rem;">
                                                <li>QR code changes daily at midnight</li>
                                                <li>Only visible on your display screen</li>
                                                <li>Customers must be at restaurant to scan</li>
                                                <li>Prevents remote queue joining</li>
                                            </ul>
                                        </div>
                                        <button onclick="navigate('/r/${restaurantId}/display')" class="btn w-full" style="background: #2563eb; color: white; font-size: 1.125rem; padding: 1.25rem;">
                                            üì∫ Open Display Screen
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb">
                                <h2 style="margin-bottom: 1rem;">Waiting Queue</h2>
                                <div class="space-y">
                                    ${waiting.length > 0 ? waiting.map(w => `
                                        <div class="card flex justify-between items-center flex-wrap gap-1" style="background: var(--gray-50);">
                                            <div>
                                                <div style="font-size: 1.5rem; font-weight: 700;">${w.queueNumber}</div>
                                                <p style="color: var(--gray-600);">${w.name} ‚Ä¢ ${w.phone} ‚Ä¢ ${w.guests} guests</p>
                                            </div>
                                            <div class="flex gap-1 items-center">
                                                <input type="number" id="table-${w.queueNumber}" placeholder="Table #" style="width: 100px;" min="1">
                                                <button onclick="allocateTable('${restaurantId}', '${w.queueNumber}')" class="btn btn-success">Seat</button>
                                            </div>
                                        </div>
                                    `).join('') : '<p class="text-center" style="color: var(--gray-600); padding: 2rem;">No customers</p>'}
                                </div>
                            </div>
                            
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="navigate('/r/${restaurantId}/display')" class="btn" style="background: #2563eb; color: white;">üì∫ Display</button>
                                <button onclick="navigate('/r/${restaurantId}/join')" class="btn" style="background: #9333ea; color: white;">üì± Customer Entry</button>
                            </div>
                        </div>
                    </div>
                `);
            });
        }
        
        async function allocateTable(restaurantId, queueNumber) {
            const tableNo = document.getElementById(`table-${queueNumber}`).value;
            if (!tableNo || tableNo < 1) { alert('‚ö†Ô∏è Enter valid table'); return; }
            
            try {
                const result = await FirebaseDB.allocateTable(restaurantId, queueNumber, tableNo);
                if (result.success) {
                    DB.allocateTable(restaurantId, queueNumber, tableNo);
                    alert(`‚úÖ Table ${tableNo} allocated!`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }
        
        function logout(restaurantId) {
            sessionStorage.removeItem(`loggedIn_${restaurantId}`);
            alert('‚úÖ Logged out');
            navigate('/');
        }
        
        // Platform Admin
        function showAdminPasswordPrompt() {
            render(`
                <div style="min-height: 100vh; background: linear-gradient(135deg, #111827 0%, #1f2937 100%); display: flex; align-items: center; justify-content: center; padding: 2rem;">
                    <div class="card" style="max-width: 500px; width: 100%;">
                        <h2 class="text-center mb">üîê Admin Login</h2>
                        <div class="space-y">
                            <input type="email" id="adminEmail" placeholder="Email" autocomplete="email">
                            <input type="password" id="adminPassword" placeholder="Password" autocomplete="current-password">
                            <button onclick="firebaseAdminLogin(event)" class="btn w-full" style="background: var(--gray-900); color: white;">Sign In</button>
                            <div id="adminLoginError" class="hidden alert alert-warning"></div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        async function firebaseAdminLogin(event) {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const errorDiv = document.getElementById('adminLoginError');
            
            if (!email || !password) {
                errorDiv.textContent = '‚ö†Ô∏è Enter email and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const btn = event.target;
            btn.textContent = 'Signing in...';
            btn.disabled = true;
            
            try {
                const result = await FirebaseAdmin.signIn(email, password);
                if (result.success) {
                    sessionStorage.setItem('adminAuth', 'yes');
                    sessionStorage.setItem('adminEmail', result.user.email);
                    window.location.hash = '/admin';
                    setTimeout(handleRoute, 100);
                } else {
                    errorDiv.textContent = `‚ùå ${result.error}`;
                    errorDiv.classList.remove('hidden');
                    btn.textContent = 'Sign In';
                    btn.disabled = false;
                }
            } catch (error) {
                errorDiv.textContent = `‚ùå ${error.message}`;
                errorDiv.classList.remove('hidden');
                btn.textContent = 'Sign In';
                btn.disabled = false;
            }
        }
        
        function checkFirebaseAdminAuth() {
            return FirebaseAdmin.getCurrentUser() && sessionStorage.getItem('adminAuth') === 'yes';
        }
        
        function showPlatformAdmin() {
            const restaurants = Object.entries(DB.restaurants);
            const pendingPayments = restaurants.filter(([_, r]) => r.planStatus === 'pending');
            const totalCustomers = restaurants.reduce((sum, [_, r]) => sum + r.queue.length, 0);
            const totalRevenue = restaurants.filter(([_, r]) => r.plan === 'premium' && r.planStatus === 'active').length * 2999;
            
            render(`
                <div style="min-height: 100vh; background: var(--gray-100); padding: 2rem;">
                    <div class="container">
                        <div class="card mb flex justify-between items-center flex-wrap">
                            <div><h1>üè¢ Platform Admin</h1><p style="color: var(--gray-600);">Manage all restaurants</p></div>
                            <button onclick="adminLogout()" class="btn btn-danger">Logout</button>
                        </div>
                        
                        <div class="grid grid-4 mb">
                            <div class="card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: #2563eb;">${restaurants.length}</div>
                                <p>Restaurants</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--success);">${totalCustomers}</div>
                                <p>Customers</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: #9333ea;">‚Çπ${totalRevenue.toLocaleString()}</div>
                                <p>Revenue</p>
                            </div>
                            <div class="card" style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);">
                                <div style="font-size: 3rem; font-weight: 900; color: var(--warning);">${pendingPayments.length}</div>
                                <p>Pending</p>
                            </div>
                        </div>
                        
                        ${pendingPayments.length > 0 ? `
                            <div class="card mb" style="border: 2px solid var(--warning);">
                                <h2 style="color: var(--warning); margin-bottom: 1rem;">‚è≥ Pending Payments (${pendingPayments.length})</h2>
                                <div class="space-y">
                                    ${pendingPayments.map(([id, r]) => `
                                        <div class="card" style="background: #fef9c3;">
                                            <div class="flex justify-between items-start flex-wrap gap-1">
                                                <div style="flex: 1;">
                                                    <h3>${r.name}</h3>
                                                    <p style="font-size: 0.875rem;">ID: ${id} ‚Ä¢ ${r.owner}</p>
                                                    <p style="font-size: 0.875rem;">UTR: ${r.paymentProof?.transactionId || 'N/A'}</p>
                                                </div>
                                                <div class="flex gap-1 flex-wrap">
                                                    <button onclick="viewScreenshot('${id}')" class="btn" style="background: #2563eb; color: white;">View</button>
                                                    <button onclick="approvePayment('${id}')" class="btn btn-success">‚úì Approve</button>
                                                    <button onclick="rejectPayment('${id}')" class="btn btn-danger">‚úó Reject</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="card">
                            <h2 style="margin-bottom: 1rem;">All Restaurants</h2>
                            <div class="space-y">
                                ${restaurants.map(([id, r]) => `
                                    <div class="card" style="background: var(--gray-50);">
                                        <div class="flex justify-between items-center flex-wrap gap-1">
                                            <div>
                                                <h3>${r.name} ${r.plan === 'premium' && r.planStatus === 'active' ? '<span class="badge badge-primary">PREMIUM</span>' : r.planStatus === 'pending' ? '<span class="badge badge-warning">PENDING</span>' : '<span class="badge badge-secondary">FREE</span>'}</h3>
                                                <p style="font-size: 0.875rem;">ID: ${id} ‚Ä¢ ${r.city} ‚Ä¢ ${r.queue.length} customers</p>
                                            </div>
                                            <div class="flex gap-1">
                                                <button onclick="navigate('/r/${id}/admin')" class="btn btn-secondary">Admin</button>
                                                <button onclick="navigate('/r/${id}/display')" class="btn" style="background: #2563eb; color: white;">Display</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function viewScreenshot(restaurantId) {
            const restaurant = DB.restaurants[restaurantId];
            if (restaurant?.paymentProof?.screenshot) {
                window.open(restaurant.paymentProof.screenshot, '_blank');
            } else { 
                alert('No screenshot'); 
            }
        }
        
        function approvePayment(restaurantId) {
            if (confirm('Approve Premium?')) {
                FirebaseDB.approvePremium(restaurantId);
                DB.approvePremium(restaurantId);
                alert('‚úÖ Premium activated!');
                handleRoute();
            }
        }
        
        function rejectPayment(restaurantId) {
            if (confirm('Reject payment?')) {
                FirebaseDB.rejectPremium(restaurantId);
                DB.rejectPremium(restaurantId);
                alert('‚ùå Rejected');
                handleRoute();
            }
        }
        
        async function adminLogout() {
            await FirebaseAdmin.signOut();
            sessionStorage.removeItem('adminAuth');
            sessionStorage.removeItem('adminEmail');
            alert('‚úÖ Logged out');
            navigate('/');
        }
        
        // Daily QR Token System
        function generateDailyToken(restaurantId, date = new Date()) {
            const dateStr = date.toISOString().slice(0, 10).replace(/-/g, ''); // "20241205"
            const secret = restaurantId + dateStr + "QUEUEAPP_SECRET_2024";
            
            // Simple hash
            let hash = 0;
            for (let i = 0; i < secret.length; i++) {
                const char = secret.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            return dateStr + '-' + Math.abs(hash).toString(36);
        }
        
        function verifyDailyToken(restaurantId, token) {
            if (!token) return false;
            
            // Extract date from token: "20241205-abc123"
            const tokenDate = token.split('-')[0];
            
            // Get today's date in same format: "20241205"
            const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            // Check if token is for today
            if (tokenDate !== today) {
                console.log('‚ùå Token expired - not for today');
                return false;
            }
            
            // Generate what today's token SHOULD be
            const expectedToken = generateDailyToken(restaurantId, new Date());
            
            // Compare
            if (token !== expectedToken) {
                console.log('‚ùå Token invalid - does not match');
                return false;
            }
            
            console.log('‚úÖ Token valid for today');
            return true;
        }
        
        // QR Code Utilities
        function generateQRCode(containerId, restaurantId, size = 300) {
            const qrUrl = `${window.location.origin}${window.location.pathname}#/r/${restaurantId}/join`;
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = ''; // Clear existing
                new QRCode(container, {
                    text: qrUrl,
                    width: size,
                    height: size,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        
        function generateDailyQRCode(containerId, restaurantId, size = 300) {
            const token = generateDailyToken(restaurantId);
            const qrUrl = `${window.location.origin}${window.location.pathname}#/r/${restaurantId}/join/${token}`;
            
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = ''; // Clear existing
                new QRCode(container, {
                    text: qrUrl,
                    width: size,
                    height: size,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                console.log('üîÑ Generated daily QR with token:', token);
            }
        }
        
        function scheduleQRRefresh(restaurantId, containerId, size) {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // Midnight
            
            const msUntilMidnight = tomorrow - now;
            const minutesUntilMidnight = Math.round(msUntilMidnight / 1000 / 60);
            
            console.log(`‚è∞ QR will refresh in ${minutesUntilMidnight} minutes (at midnight)`);
            
            setTimeout(() => {
                console.log('üîÑ Midnight! Refreshing QR code...');
                generateDailyQRCode(containerId, restaurantId, size);
                scheduleQRRefresh(restaurantId, containerId, size);
            }, msUntilMidnight);
        }
        
        function downloadQR(restaurantId, restaurantName) {
            const canvas = document.querySelector(`#qr-${restaurantId} canvas`);
            if (canvas) {
                const link = document.createElement('a');
                link.download = `${restaurantName}-QR-Code.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }
        
        function printQR(restaurantId) {
            const qrElement = document.getElementById(`qr-${restaurantId}`);
            if (qrElement) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html><head><title>QR Code - Print</title>
                    <style>
                        body { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; font-family: Arial; }
                        h1 { margin-bottom: 2rem; }
                        .qr-container { border: 2px solid #000; padding: 2rem; }
                    </style>
                    </head><body>
                    <h1>Scan to Join Queue</h1>
                    <div class="qr-container">${qrElement.innerHTML}</div>
                    <script>window.onload = function() { window.print(); }</script>
                    </body></html>
                `);
                printWindow.document.close();
            }
        }
        
        // Export functions
        window.navigate = navigate;
        window.navigateHome = navigateHome;
        window.generateQRCode = generateQRCode;
        window.generateDailyQRCode = generateDailyQRCode;
        window.downloadQR = downloadQR;
        window.printQR = printQR;
        window.selectGuests = selectGuests;
        window.handleSignup = handleSignup;
        window.handleLogin = handleLogin;
        window.handleRestaurantLogin = handleRestaurantLogin;
        window.handleJoinQueue = handleJoinQueue;
        window.allocateTable = allocateTable;
        window.logout = logout;
        window.firebaseAdminLogin = firebaseAdminLogin;
        window.adminLogout = adminLogout;
        window.handleUpgrade = handleUpgrade;
        window.previewScreenshot = previewScreenshot;
        window.submitPaymentProof = submitPaymentProof;
        window.viewScreenshot = viewScreenshot;
        window.approvePayment = approvePayment;
        window.rejectPayment = rejectPayment;
        
        // Firebase Auth Listener
        FirebaseAdmin.onAuthStateChanged((user) => {
            if (user) {
                console.log('üî• Admin:', user.email);
                if (sessionStorage.getItem('adminAuth') !== 'yes') {
                    sessionStorage.setItem('adminAuth', 'yes');
                    sessionStorage.setItem('adminEmail', user.email);
                }
            } else {
                if (sessionStorage.getItem('adminAuth') === 'yes') {
                    sessionStorage.removeItem('adminAuth');
                    sessionStorage.removeItem('adminEmail');
                }
            }
        });
        
        // Initialize
        setTimeout(() => {
            handleRoute();
            checkDailyCleanup();
        }, 500);
    </script>
</body>
</html>
