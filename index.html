<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<title>QueueApp - Smart Queue Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#f97316;--primary-dark:#ea580c;--secondary:#ec4899;--success:#22c55e;--warning:#eab308;--danger:#dc2626;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-600:#4b5563;--gray-700:#374151;--gray-900:#111827;--white:#fff;--nav-height:70px;--mobile-nav-height:60px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;color:var(--gray-900);background:var(--gray-50);font-size:16px;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}
h1{font-size:clamp(1.5rem,5vw,3.5rem);font-weight:700;line-height:1.2}
h2{font-size:clamp(1.25rem,4vw,2.5rem);font-weight:700;line-height:1.3}
h3{font-size:clamp(1.1rem,3vw,2rem);font-weight:600;line-height:1.4}
.container{width:100%;max-width:1400px;margin:0 auto;padding:0 clamp(1rem,3vw,2rem)}
nav{background:var(--white);box-shadow:0 2px 10px rgba(0,0,0,.1);padding:1rem clamp(.75rem,2vw,1.5rem);position:sticky;top:0;z-index:100;height:var(--nav-height);display:flex;align-items:center}
nav .nav-content{display:flex;justify-content:space-between;align-items:center;width:100%;gap:1rem}
nav h1{color:var(--primary);cursor:pointer;font-size:clamp(1.25rem,3vw,2rem);flex-shrink:0}
nav .nav-buttons{display:flex;gap:clamp(.5rem,1.5vw,.75rem);align-items:center;flex-wrap:wrap}
.mobile-menu-toggle{display:none;background:none;border:none;font-size:1.75rem;cursor:pointer;padding:.5rem;color:var(--gray-900);min-width:44px;min-height:44px}
.nav-buttons.mobile-menu{position:fixed;top:var(--mobile-nav-height);left:0;right:0;background:var(--white);flex-direction:column;padding:1rem;box-shadow:0 4px 20px rgba(0,0,0,.15);transform:translateY(-100%);opacity:0;transition:transform .3s ease,opacity .3s ease;z-index:99;pointer-events:none}
.nav-buttons.mobile-menu.active{transform:translateY(0);opacity:1;pointer-events:auto}
button,.btn{padding:clamp(.65rem,1.5vw,1rem) clamp(1.25rem,3vw,2rem);min-height:48px;border:none;border-radius:clamp(.5rem,1vw,1rem);font-size:clamp(.875rem,1.5vw,1rem);font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;text-align:center;white-space:nowrap;-webkit-tap-highlight-color:transparent}
button:active,.btn:active{transform:scale(.98)}
button:hover,.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
button:disabled,.btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
.btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:var(--white)}
.btn-secondary{background:var(--gray-600);color:var(--white)}
.btn-success{background:var(--success);color:var(--white)}
.btn-danger{background:var(--danger);color:var(--white)}
.btn-warning{background:var(--warning);color:var(--white)}
.card{background:var(--white);border-radius:clamp(1rem,2vw,1.5rem);padding:clamp(1.25rem,3vw,2.5rem);box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:clamp(1rem,2vw,2rem)}
.grid{display:grid;gap:clamp(1rem,2vw,2rem);margin-bottom:clamp(1rem,2vw,2rem)}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(min(300px,100%),1fr))}
.grid-3{grid-template-columns:repeat(auto-fit,minmax(min(250px,100%),1fr))}
.grid-4{grid-template-columns:repeat(auto-fit,minmax(min(180px,100%),1fr))}
input,select,textarea{width:100%;padding:clamp(.875rem,2vw,1.125rem);min-height:48px;border:2px solid var(--gray-200);border-radius:clamp(.5rem,1vw,1rem);font-size:max(16px,clamp(.875rem,1.5vw,1.125rem));margin-bottom:clamp(.75rem,1.5vw,1.5rem);transition:border .3s ease;-webkit-appearance:none}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}
.badge{display:inline-block;padding:clamp(.3rem,.5vw,.5rem) clamp(.6rem,1vw,1rem);border-radius:999px;font-size:clamp(.75rem,1vw,.875rem);font-weight:700;white-space:nowrap}
.badge-primary{background:var(--primary);color:var(--white)}
.badge-warning{background:var(--warning);color:var(--white)}
.badge-danger{background:var(--danger);color:var(--white)}
.badge-secondary{background:var(--gray-600);color:var(--white)}
.bg-gradient{background:linear-gradient(135deg,#fff7ed 0%,#fce7f3 100%)}
.bg-gradient-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);color:var(--white)}
.display-screen{background:linear-gradient(135deg,#1f2937 0%,#111827 100%);color:var(--white);min-height:100vh;padding:clamp(1rem,3vw,4rem)}
.display-screen h1{font-size:clamp(2rem,6vw,6rem);margin-bottom:clamp(1rem,3vw,3rem)}
.display-screen h2{font-size:clamp(1.5rem,4vw,4rem)}
.display-screen .queue-number{font-size:clamp(3rem,10vw,12rem);font-weight:900}
.alert{padding:clamp(1rem,2vw,1.5rem);border-radius:clamp(.5rem,1vw,1rem);margin-bottom:clamp(1rem,2vw,1.5rem);border:2px solid}
.alert-warning{background:#fef9c3;border-color:var(--warning);color:#854d0e}
.alert-danger{background:#fee2e2;border-color:var(--danger);color:#991b1b}
.alert-success{background:#dcfce7;border-color:var(--success);color:#166534}
.alert-info{background:#dbeafe;border-color:#2563eb;color:#1e40af}
.display-qr-fixed{position:fixed;z-index:1000;cursor:move;transition:opacity .3s ease}
.display-qr-fixed.dragging{opacity:.8;cursor:grabbing}
.display-qr-fixed.hidden{display:none}
.qr-controls{position:fixed;top:1rem;left:1rem;background:rgba(0,0,0,.9);color:white;padding:1rem;border-radius:1rem;z-index:2000;box-shadow:0 8px 32px rgba(0,0,0,.5);min-width:220px}
.qr-controls.minimized{padding:.5rem;min-width:auto}
.qr-controls.minimized .qr-controls-content{display:none}
.qr-controls h3{font-size:1rem;margin-bottom:.75rem;color:var(--primary)}
.qr-control-btn{background:var(--primary);color:white;border:none;padding:.5rem 1rem;border-radius:.5rem;cursor:pointer;font-size:.875rem;font-weight:600;margin:.25rem;transition:all .2s ease;display:inline-block}
.qr-control-btn:hover{background:var(--primary-dark);transform:scale(1.05)}
.qr-control-btn.active{background:var(--success)}
.qr-control-btn.small{padding:.35rem .75rem;font-size:.75rem}
.qr-size-control{margin:.75rem 0}
.qr-size-control label{display:block;font-size:.875rem;margin-bottom:.5rem;color:rgba(255,255,255,.9)}
.qr-size-slider{width:100%;margin:.5rem 0}
.qr-toggle-btn{background:rgba(249,115,22,.9);color:white;border:none;padding:.75rem;border-radius:50%;cursor:pointer;font-size:1.25rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;transition:all .3s ease}
.qr-toggle-btn:hover{background:rgba(249,115,22,1);transform:scale(1.1)}
.control-group{margin-bottom:.75rem}
.control-group:last-child{margin-bottom:0}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:1rem;animation:fadeIn .3s ease}
.modal-content{background:white;border-radius:1rem;padding:clamp(1.5rem,4vw,2rem);max-width:600px;width:100%;max-height:90vh;overflow-y:auto;animation:slideIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes pulse-badge{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.text-center{text-align:center}
.flex{display:flex}
.flex-wrap{flex-wrap:wrap}
.items-center{align-items:center}
.justify-between{justify-content:space-between}
.justify-center{justify-content:center}
.gap-1{gap:clamp(.5rem,1vw,1rem)}
.w-full{width:100%}
.hidden{display:none}
.space-y>*+*{margin-top:clamp(.75rem,1.5vw,1.5rem)}
.mb{margin-bottom:clamp(1rem,2vw,2rem)}
.mt{margin-top:clamp(1rem,2vw,2rem)}
.loading-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(135deg,#fff7ed 0%,#fce7f3 100%)}
.loading-icon{font-size:clamp(3rem,8vw,6rem);margin-bottom:clamp(1rem,2vw,2rem);animation:pulse 2s ease-in-out infinite}
.progress-bar{background:var(--gray-200);height:30px;border-radius:999px;overflow:hidden;position:relative}
.progress-fill{height:100%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;transition:width .3s ease}
.qr-container{background:white;padding:clamp(1rem,3vw,2rem);border-radius:1rem;display:inline-block;box-shadow:0 8px 24px rgba(0,0,0,.15)}
@media (max-width:767px){
:root{--nav-height:var(--mobile-nav-height)}
nav{height:var(--mobile-nav-height);padding:.75rem 1rem}
.mobile-menu-toggle{display:flex}
nav .nav-buttons:not(.mobile-menu){display:none}
nav .nav-buttons.mobile-menu button{width:100%;margin-bottom:.5rem}
.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
.card{padding:1rem;border-radius:.75rem}
.space-y button,.space-y .btn{width:100%}
.display-screen{padding:1rem;padding-bottom:200px}
.display-screen h1{font-size:clamp(1.5rem,8vw,2rem)}
.display-screen h2{font-size:clamp(1.25rem,6vw,1.75rem)}
.display-screen .queue-number{font-size:clamp(2.5rem,15vw,4rem)}
.display-qr-fixed{bottom:1rem;right:1rem;left:1rem;max-width:100%}
.display-qr-fixed .qr-card{padding:1rem!important}
.display-qr-fixed #display-qr{width:120px!important;height:120px!important;margin:0 auto}
.display-qr-fixed .qr-text{font-size:.75rem!important}
.qr-controls{top:.5rem;left:.5rem;right:.5rem;min-width:auto;padding:.75rem}
input,select,textarea{min-height:52px;font-size:16px}
.flex.gap-1{gap:.75rem}
.modal-content{padding:1.25rem;margin:1rem}
.alert{padding:.875rem}
.hide-mobile{display:none!important}
}
@media (min-width:768px) and (max-width:1024px){
.grid-3,.grid-4{grid-template-columns:repeat(2,1fr)}
.display-screen .queue-number{font-size:clamp(4rem,12vw,8rem)}
.display-qr-fixed{top:1rem;right:1rem;max-width:280px}
.display-qr-fixed .qr-card{padding:1.25rem!important}
.display-qr-fixed #display-qr{width:160px!important;height:160px!important}
.card{padding:1.5rem}
.mobile-menu-toggle{display:none}
nav .nav-buttons{display:flex}
}
@media (min-width:1025px){
.grid-3{grid-template-columns:repeat(3,1fr)}
.grid-4{grid-template-columns:repeat(4,1fr)}
button:hover,.btn:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,.2)}
.display-qr-fixed{top:1.5rem;right:1.5rem;max-width:300px}
.display-qr-fixed .qr-card{padding:1.5rem!important}
}
@media (min-width:1281px) and (max-width:1919px){
.display-qr-fixed{top:1.5rem;right:1.5rem;max-width:320px}
.display-qr-fixed .qr-card{padding:1.75rem!important}
}
@media (min-width:1920px){
body{font-size:20px}
.display-screen .queue-number{font-size:15rem}
button,.btn{min-height:60px;padding:1rem 2.5rem}
.display-qr-fixed{top:2rem;right:2rem;max-width:380px}
.display-qr-fixed .qr-card{padding:2rem!important}
.display-qr-fixed #display-qr{width:280px!important;height:280px!important}
}
@media (min-width:2560px){
body{font-size:24px}
.container{max-width:2000px}
.display-screen .queue-number{font-size:20rem}
button,.btn{min-height:70px;padding:1.25rem 3rem}
.display-qr-fixed{top:3rem;right:3rem;max-width:450px}
.display-qr-fixed .qr-card{padding:2.5rem!important}
.display-qr-fixed #display-qr{width:350px!important;height:350px!important}
}
@media print{
*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;color-adjust:exact!important}
body *{visibility:hidden}
.poster-modal-overlay,.poster-modal-overlay *{visibility:visible!important}
.poster-modal-content,.poster-modal-content *{visibility:visible!important}
.poster-template4,.poster-template4 *,.poster-template4::before,.poster-template4::after{visibility:visible!important}
.poster-scan-me::before,.poster-scan-me::after{visibility:visible!important}
.poster-modal-overlay{background:white!important;position:fixed!important;padding:0!important;top:0!important;left:0!important;right:0!important;bottom:0!important}
.poster-modal-content{max-width:none!important;width:210mm!important;height:297mm!important;padding:0!important;margin:0 auto!important;border-radius:0!important;overflow:visible!important;box-shadow:none!important}
.poster-template4{display:flex!important;flex-direction:column!important;align-items:center!important;justify-content:space-around!important;width:210mm!important;height:297mm!important;min-height:297mm!important;margin:0!important;padding:3rem 2rem!important;page-break-after:always!important;box-sizing:border-box!important;position:relative!important}
.poster-template4 .poster-restaurant-name{display:block!important}
.poster-template4 .poster-welcome-text{display:block!important}
.poster-template4 .poster-main-message{display:block!important}
.poster-template4 .poster-main-text{display:block!important}
.poster-template4 .poster-qr-container{display:flex!important;justify-content:center!important}
.poster-template4 .poster-scan-me{display:block!important}
.poster-template4 .poster-powered-by{display:block!important}
.poster-template4::before,.poster-template4::after{opacity:.1!important}
.poster-actions{display:none!important;visibility:hidden!important}
.qr-container,.qr-container *{visibility:visible!important}
.qr-container{position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;padding:2rem!important}
#poster-qr,#poster-qr *,#daily-qr,#daily-qr *{visibility:visible!important}
}
@media (prefers-reduced-motion:reduce){
*{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}
}
*:focus-visible{outline:3px solid var(--primary);outline-offset:2px}
.poster-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:99999;padding:1rem;animation:fadeIn .3s ease}
.poster-modal-content{background:white;border-radius:1rem;padding:2rem;max-width:900px;width:100%;max-height:95vh;overflow-y:auto}
.poster-template4{background:linear-gradient(180deg,#fef3c7 0%,#fef3c7 50%,white 50%,white 100%);display:flex;flex-direction:column;align-items:center;justify-content:space-around;padding:3rem 2rem;position:relative;min-height:600px}
.poster-template4::after{content:'üçΩÔ∏è';position:absolute;font-size:4rem;opacity:.1;top:2rem;right:2rem;z-index:1;pointer-events:none}
.poster-template4::before{content:'üçΩÔ∏è';position:absolute;font-size:4rem;opacity:.1;bottom:2rem;left:2rem;z-index:1;pointer-events:none}
.poster-template4 .poster-restaurant-name{font-size:clamp(1.5rem,4vw,2.5rem);color:#f59e0b;font-weight:900;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,.1);z-index:2}
.poster-template4 .poster-welcome-text{font-size:clamp(1rem,2vw,1.5rem);color:#666;text-align:center;margin:1rem 0;z-index:2}
.poster-template4 .poster-main-message{background:linear-gradient(135deg,#fbbf24 0%,#f59e0b 100%);color:white;border-radius:2rem;padding:clamp(1.5rem,3vw,2rem) clamp(2rem,4vw,3rem);margin:1rem 0;box-shadow:0 8px 30px rgba(251,191,36,.4);z-index:2}
.poster-template4 .poster-main-text{font-size:clamp(1.25rem,3vw,2rem);font-weight:900;text-align:center;line-height:1.3}
.poster-template4 .poster-qr-container{background:white;padding:clamp(1.5rem,3vw,2rem);border-radius:1.5rem;box-shadow:0 8px 30px rgba(0,0,0,.15);border:5px solid #fbbf24;z-index:2;display:flex;justify-content:center}
.poster-template4 .poster-scan-me{font-size:clamp(1rem,2vw,1.5rem);color:#f59e0b;font-weight:900;margin-top:1.5rem;text-align:center;z-index:2}
.poster-template4 .poster-scan-me::before,.poster-template4 .poster-scan-me::after{content:'üëá';margin:0 .5rem}
.poster-template4 .poster-powered-by{font-size:clamp(.75rem,1.5vw,1rem);color:#666;text-align:center;z-index:2;margin-top:1rem}
.poster-actions{display:flex;gap:1rem;justify-content:center;margin-top:2rem;flex-wrap:wrap}
input[type="checkbox"],input[type="radio"]{width:20px!important;height:20px!important;min-height:20px!important;-webkit-appearance:checkbox!important;appearance:checkbox!important;margin-bottom:0!important;cursor:pointer;flex-shrink:0;accent-color:var(--primary)}
input[type="radio"]{-webkit-appearance:radio!important;appearance:radio!important}
input[type="file"]{-webkit-appearance:none;appearance:none;padding:.5rem!important;min-height:auto!important;cursor:pointer}
input[type="range"]{-webkit-appearance:auto!important;appearance:auto!important;padding:0!important;min-height:auto!important;height:8px;cursor:pointer}
.flex input[type="checkbox"]{margin-top:.25rem}
</style>
</head>
<body>
<div id="app"><div class="loading-screen"><div class="loading-icon">‚è≥</div><h1>Loading QueueApp...</h1></div></div>

<!-- Load archive manager first -->
<script src="archive-manager.js"></script>
<script src="analytics.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyBQRfA1_qgG9x4w4aiDqAzAPghMEc5zE6Q",authDomain:"queueapp-97728.firebaseapp.com",projectId:"queueapp-97728",storageBucket:"queueapp-97728.firebasestorage.app",messagingSenderId:"41156558140",appId:"1:41156558140:web:f3277e7018176d0870f239",measurementId:"G-QSP7ZXNSFT"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();

const getTodayQRCode = rid => `${window.location.origin}/#/r/${rid}/join`;
const generateQRCode=(eid,rid)=>{const el=document.getElementById(eid);if(!el)return;el.innerHTML='';const sw=window.innerWidth;let sz=sw<768?120:sw<1024?160:sw<1920?220:sw<2560?280:350;new QRCode(el,{text:getTodayQRCode(rid),width:sz,height:sz,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H})};

const FirebaseAdmin={async signIn(e,p){try{const u=await auth.signInWithEmailAndPassword(e,p);return{success:true,user:u.user}}catch(err){return{success:false,error:err.message}}},async signOut(){try{await auth.signOut();return{success:true}}catch(err){return{success:false,error:err.message}}},getCurrentUser(){return auth.currentUser},onAuthStateChanged(cb){return auth.onAuthStateChanged(cb)}};
window.FirebaseAdmin=FirebaseAdmin;

const FirebaseDB={
  async addRestaurant(rid,data){
    try{
      const cm=new Date().toISOString().slice(0,7);
      const td=new Date().toISOString().slice(0,10);
      await db.collection('restaurants').doc(rid).set({
        ...data,
        queue:[],
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        plan:'free',
        planStatus:'active',
        analytics:{
          currentMonth:cm,
          customersThisMonth:0,
          lastResetDate:td,
          dailyStats:{}
        },
        monthlyHistory:[],
        queueArchive:{},
        lastCleanupDate:td
      });
      return{success:true,id:rid};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async getRestaurant(rid){
    try{
      const doc=await db.collection('restaurants').doc(rid).get();
      return doc.exists?{success:true,data:doc.data()}:{success:false,error:'Not found'};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async getAllRestaurants(){
    try{
      const snap=await db.collection('restaurants').get();
      const rests={};
      snap.forEach(d=>rests[d.id]=d.data());
      return{success:true,data:rests};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async addToQueue(rid,cust){
    try{
      const rref=db.collection('restaurants').doc(rid);
      const doc=await rref.get();
      if(!doc.exists) return{success:false,error:'Restaurant not found'};
      
      const rest=doc.data();
      const cm=new Date().toISOString().slice(0,7);
      const td=new Date().toISOString().slice(0,10);
      
      let anl=rest.analytics||{currentMonth:cm,customersThisMonth:0,lastResetDate:td,dailyStats:{}};
      
      if(anl.currentMonth!==cm){
        const mh=rest.monthlyHistory||[];
        mh.push({
          month:anl.currentMonth,
          totalCustomers:anl.customersThisMonth,
          dailyStats:anl.dailyStats,
          archivedAt:new Date().toISOString()
        });
        anl={currentMonth:cm,customersThisMonth:0,lastResetDate:td,dailyStats:{}};
        await rref.update({monthlyHistory:mh,analytics:anl});
      }
      
      if(rest.plan==='free'&&anl.customersThisMonth>=500){
        return{
          success:false,
          error:'LIMIT_REACHED',
          message:'Monthly limit reached. Upgrade to Premium.',
          customersUsed:anl.customersThisMonth,
          limit:500
        };
      }
      
      const qn=`A-${Math.floor(Math.random()*900)+100}`;
      const qi={
        ...cust,
        queueNumber:qn,
        status:'waiting',
        joinedAt:new Date().toISOString()
      };
      
      anl.customersThisMonth+=1;
      anl.dailyStats[td]=(anl.dailyStats[td]||0)+1;
      
      await rref.update({
        queue:firebase.firestore.FieldValue.arrayUnion(qi),
        analytics:anl
      });
      
      return{
        success:true,
        queueNumber:qn,
        customersThisMonth:anl.customersThisMonth,
        limit:rest.plan==='free'?500:'unlimited'
      };
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async allocateTable(rid,qn,tbl){
    try{
      const res=await this.getRestaurant(rid);
      if(!res.success) return res;
      
      const uq=res.data.queue.map(q=>
        q.queueNumber===qn?{
          ...q,
          status:'allocated',
          tableNo:tbl,
          allocatedAt:new Date().toISOString()
        }:q
      );
      
      await db.collection('restaurants').doc(rid).update({queue:uq});
      return{success:true};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async getAnalytics(rid){
    try{
      const doc=await db.collection('restaurants').doc(rid).get();
      if(!doc.exists) return{success:false,error:'Not found'};
      const r=doc.data();
      return{
        success:true,
        analytics:r.analytics||{},
        monthlyHistory:r.monthlyHistory||[]
      };
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async dailyCleanup(rid, isManual = false) {
    try {
      const td = new Date().toISOString().slice(0, 10);
      
      return await db.runTransaction(async trans => {
        const rref = db.collection('restaurants').doc(rid);
        const doc = await trans.get(rref);
        if (!doc.exists) return { success: false, error: 'Not found' };
        
        const r = doc.data();
        if (r.lastCleanupDate === td) return { success: false, error: 'Already cleaned today' };
        if (r.plan === 'free' && !isManual) return { success: false, error: 'FREE plan requires manual cleanup' };
        
        const queue = r.queue || [];
        
        // ‚úÖ Use ArchiveManager to prepare archive data
        const archiveData = ArchiveManager.prepareArchiveData(queue, td, isManual ? 'manual' : 'auto');
        
        // ‚úÖ Check which system to use
        if (ArchiveManager.useNewSystem(td)) {
          // NEW SYSTEM: Store in archives collection
          ArchiveManager.storeFirestoreNewSystem(trans, db, rid, r, archiveData, td);
          
          // Clear queue
          trans.update(rref, {
            queue: [],
            lastCleanupDate: td,
            lastCleanup: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // OLD SYSTEM: Store in queueArchive field
          ArchiveManager.storeFirestoreOldSystem(trans, rref, r, archiveData, td);
        }
        
        return { success: true };
      });
    } catch (err) {
      return { success: false, error: err.message };
    }
  },
  
  async savePaymentProof(rid,pd){
    try{
      await db.collection('restaurants').doc(rid).update({
        paymentProof:{
          ...pd,
          uploadedAt:firebase.firestore.FieldValue.serverTimestamp()
        },
        planStatus:'pending'
      });
      return{success:true};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async approvePremium(rid,ad){
    try{
      const exp=new Date();
      exp.setDate(exp.getDate()+30);
      const upd={
        plan:'premium',
        planStatus:'active',
        planExpiryDate:exp.getTime()
      };
      if(ad){
        upd['paymentProof.approvedAt']=firebase.firestore.FieldValue.serverTimestamp();
        upd['paymentProof.approvedBy']=ad.approvedBy||'platform_admin';
        upd['paymentProof.approvalReason']=ad.approvalReason||'Approved';
      }
      await db.collection('restaurants').doc(rid).update(upd);
      return{success:true};
    }catch(err){
      return{success:false,error:err.message};
    }
  },
  
  async rejectPremium(rid,rsn,ad){
    try{
      const upd={
        planStatus:'rejected',
        'paymentProof.rejectedAt':firebase.firestore.FieldValue.serverTimestamp(),
        'paymentProof.rejectionReason':rsn
      };
      if(ad){
        upd['paymentProof.rejectedBy']=ad.rejectedBy||'platform_admin';
        upd['paymentProof.rejectedTimestamp']=ad.rejectedTimestamp;
      }
      await db.collection('restaurants').doc(rid).update(upd);
      return{success:true};
    }catch(err){
      return{success:false,error:err.message};
    }
  }
};
window.FirebaseDB=FirebaseDB;

const checkInternet=()=>{
  if(!navigator.onLine){
    alert('‚ö†Ô∏è No Internet Connection\n\nPlease connect to the internet to continue.');
    return false;
  }
  return true;
};

const DB={
  restaurants:JSON.parse(localStorage.getItem('restaurants')||'{}'),
  
  save(){
    localStorage.setItem('restaurants',JSON.stringify(this.restaurants));
  },
  
  addRestaurant(id,d){
    const cm=new Date().toISOString().slice(0,7);
    const td=new Date().toISOString().slice(0,10);
    this.restaurants[id]={
      ...d,
      queue:[],
      plan:'free',
      planStatus:'active',
      analytics:{
        currentMonth:cm,
        customersThisMonth:0,
        lastResetDate:td,
        dailyStats:{}
      },
      monthlyHistory:[],
      lastCleanupDate:td
    };
    this.save();
    return id;
  },
  
  addToQueue(rid,c){
    const r=this.restaurants[rid];
    if(!r) return null;
    
    const cm=new Date().toISOString().slice(0,7);
    const td=new Date().toISOString().slice(0,10);
    
    if(!r.analytics){
      r.analytics={currentMonth:cm,customersThisMonth:0,lastResetDate:td,dailyStats:{}};
    }
    
    if(r.analytics.currentMonth!==cm){
      if(!r.monthlyHistory) r.monthlyHistory=[];
      r.monthlyHistory.push({
        month:r.analytics.currentMonth,
        totalCustomers:r.analytics.customersThisMonth
      });
      r.analytics={currentMonth:cm,customersThisMonth:0,lastResetDate:td,dailyStats:{}};
    }
    
    if(r.plan==='free'&&r.analytics.customersThisMonth>=500) return null;
    
    const qn=`A-${Math.floor(Math.random()*900)+100}`;
    r.queue.push({
      ...c,
      queueNumber:qn,
      status:'waiting',
      joinedAt:new Date().toISOString()
    });
    r.analytics.customersThisMonth+=1;
    r.analytics.dailyStats[td]=(r.analytics.dailyStats[td]||0)+1;
    this.save();
    return qn;
  },
  
  allocateTable(rid,qn,tno){
    const r=this.restaurants[rid];
    if(!r) return false;
    const qi=r.queue.find(q=>q.queueNumber===qn);
    if(qi){
      qi.status='allocated';
      qi.tableNo=tno;
      qi.allocatedAt=new Date().toISOString();
      this.save();
      return true;
    }
    return false;
  },
  
  savePaymentProof(rid,pd){
    const r=this.restaurants[rid];
    if(r){
      r.paymentProof={...pd,uploadedAt:Date.now()};
      r.planStatus='pending';
      this.save();
      return true;
    }
    return false;
  },
  
  approvePremium(rid){
    const r=this.restaurants[rid];
    if(r){
      r.plan='premium';
      r.planStatus='active';
      const exp=new Date();
      exp.setDate(exp.getDate()+30);
      r.planExpiryDate=exp.getTime();
      this.save();
      return true;
    }
    return false;
  },
  
  rejectPremium(rid,rsn){
    const r=this.restaurants[rid];
    if(r){
      r.planStatus='rejected';
      if(r.paymentProof){
        r.paymentProof.rejectedAt=Date.now();
        r.paymentProof.rejectionReason=rsn;
      }
      this.save();
      return true;
    }
    return false;
  },
  
  dailyCleanup(rid, isManual = false) {
    const r = this.restaurants[rid];
    if (!r) return { success: false, error: 'Not found' };
    
    const td = new Date().toISOString().slice(0, 10);
    
    if (r.lastCleanupDate === td) return { success: false, error: 'Already cleaned today' };
    if (r.plan === 'free' && !isManual) return { success: false, error: 'FREE plan requires manual cleanup' };
    
    const queue = r.queue || [];
    
    // ‚úÖ Use ArchiveManager to prepare archive data
    const archiveData = ArchiveManager.prepareArchiveData(queue, td, isManual ? 'manual' : 'auto');
    
    // ‚úÖ Check which system to use
    if (ArchiveManager.useNewSystem(td)) {
      // NEW SYSTEM: Store in separate localStorage entries
      ArchiveManager.storeNewSystem(rid, r, archiveData, td);
    } else {
      // OLD SYSTEM: Store in queueArchive field
      ArchiveManager.storeOldSystem(r, archiveData, td);
    }
    
    r.queue = [];
    r.lastCleanupDate = td;
    this.save();
    return { success: true };
  }
};
window.DB=DB;

const getLoggedInRest=()=>{
  for(let id of Object.keys(DB.restaurants)){
    if(sessionStorage.getItem(`loggedIn_${id}`)) return{id,data:DB.restaurants[id]};
  }
  return null;
};

const navigateHome=()=>{
  const lg=getLoggedInRest();
  lg?navigate(`/r/${lg.id}/admin`):navigate('/');
};

const render=h=>document.getElementById('app').innerHTML=h;
const navigate=p=>window.location.hash=p;

const toggleMobileMenu=()=>{
  const menu=document.querySelector('.nav-buttons.mobile-menu');
  if(menu) menu.classList.toggle('active');
};
window.toggleMobileMenu=toggleMobileMenu;

let platformAdminListener=null,adminUnsubscribe=null,displayUnsubscribe=null;

function handleRoute(){
  const h=window.location.hash.slice(1)||'/';
  const p=h.split('/').filter(Boolean);
  
  if(h!=='/admin'&&platformAdminListener){
    platformAdminListener();
    platformAdminListener=null;
  }
  
  if(h==='/'||h==='') showHome();
  else if(h==='/pricing') showPricing();
  else if(h==='/terms') showLegal('Terms of Service',`<h3>1. Acceptance</h3><p>By using QueueApp, you agree to these Terms.</p><h3>2. Service</h3><p>QueueApp provides queue management, QR entry, displays, and analytics.</p><h3>3. Plans</h3><p><strong>Free:</strong> 500 customers/month, basic features.<br><strong>Premium (‚Çπ1,999/month):</strong> Unlimited customers, analytics.</p><h3>4. Payment</h3><p>Monthly billing. Non-refundable. Cancel anytime.</p><h3>5. Contact</h3><p>Phone: +91 7200 36 9191 Email: queueapphelpdesk@gmail.com</p>`);
  else if(h==='/privacy') showLegal('Privacy Policy',`<h3>1. Data Collection</h3><p>Restaurant and customer info for service delivery.</p><h3>2. Data Use</h3><p>Service provision, analytics, improvements.</p><h3>3. Storage</h3><p>Firebase cloud storage with localStorage backup.</p><h3>4. Rights</h3><p>Access, correct, delete data anytime.</p><h3>5. Contact</h3><p>Phone: +91 7200 36 9191 Email: queueapphelpdesk@gmail.com</p>`);
  else if(h==='/signup') showSignup();
  else if(h==='/login') showLogin();
  else if(h==='/admin') checkFirebaseAdminAuth()?showPlatformAdmin():showAdminPasswordPrompt();
  else if(p[0]==='payment'&&p[1]&&p[2]==='upload') showUploadScreenshot(p[1]);
  else if(p[0]==='payment'&&p[1]) showPaymentPage(p[1]);
  else if(p[0]==='r'&&p[2]==='join') showJoinQueue(p[1]);
  else if(p[0]==='r'&&p[2]==='display') showDisplay(p[1],p[3]||null);
  else if(p[0]==='r'&&p[2]==='status'&&p[3]) showQueueStatus(p[1],p[3]);
  else if(p[0]==='r'&&p[2]==='admin') sessionStorage.getItem(`loggedIn_${p[1]}`)?showRestaurantAdmin(p[1]):showRestaurantLogin(p[1]);
  else if(p[0]==='r'&&p[2]==='analytics') sessionStorage.getItem(`loggedIn_${p[1]}`)?showAnalytics(p[1]):showRestaurantLogin(p[1]);
  else render(`<div class="container text-center" style="padding-top:4rem"><h1>404 - Not Found</h1><button onclick="navigate('/')" class="btn btn-primary mt">Go Home</button></div>`);
}
window.onhashchange=handleRoute;

function showLegal(t,c){
  render(`<div style="min-height:100vh;background:var(--gray-50)"><nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1><button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button><div class="nav-buttons"><button onclick="navigateHome()" class="btn btn-secondary">‚Üê Back</button></div></div></nav><div class="container" style="padding:3rem 0;max-width:900px"><h1 class="mb">${t}</h1><p style="color:var(--gray-600);margin-bottom:2rem">Last Updated: December 2024</p><div class="card"><div class="space-y">${c}</div></div><div class="text-center mt"><button onclick="navigateHome()" class="btn btn-primary">Back</button></div></div></div>`);
}

function showHome(){
  render(`<div class="bg-gradient" style="min-height:100vh"><nav><div class="container nav-content"><h1 onclick="navigateHome()">QueueApp</h1><button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button><div class="nav-buttons mobile-menu"><button onclick="navigate('/pricing')" class="btn btn-secondary">Pricing</button><button onclick="navigate('/login')" class="btn btn-secondary">Login</button><button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button></div><div class="nav-buttons"><button onclick="navigate('/pricing')" class="btn btn-secondary">Pricing</button><button onclick="navigate('/login')" class="btn btn-secondary">Login</button><button onclick="navigate('/signup')" class="btn btn-primary">Sign Up</button></div></div></nav><main class="container text-center" style="padding:clamp(2rem,5vw,8rem) 0"><h1 style="margin-bottom:1rem">Smart Queue Management</h1><p style="font-size:clamp(1.125rem,2vw,1.5rem);color:var(--gray-600);margin-bottom:2rem">No more crowded entrances. Happy customers.</p><div class="grid grid-3 mb"><div class="card text-center"><div style="font-size:4rem;margin-bottom:1rem">üì±</div><h3>Digital Queue</h3><p style="color:var(--gray-600)">QR code entry</p></div><div class="card text-center"><div style="font-size:4rem;margin-bottom:1rem">üì∫</div><h3>Live Display</h3><p style="color:var(--gray-600)">Real-time updates</p></div><div class="card text-center"><div style="font-size:4rem;margin-bottom:1rem">üìä</div><h3>Analytics</h3><p style="color:var(--gray-600)">Track customer flow</p></div></div><button onclick="navigate('/signup')" class="btn btn-primary" style="font-size:clamp(1.25rem,3vw,1.5rem);padding:clamp(1rem,3vw,1.5rem) clamp(2rem,5vw,3rem)">Start Free Forever</button><p style="margin-top:1rem;color:var(--gray-600);font-size:clamp(.875rem,2vw,1rem)">500 customers/month free ‚Ä¢ No credit card</p></main><footer style="background:white;border-top:2px solid var(--gray-200);padding:2rem 0;margin-top:4rem"><div class="container text-center"><div style="display:flex;justify-content:center;gap:clamp(1rem,3vw,2rem);flex-wrap:wrap;margin-bottom:1rem"><button onclick="navigate('/terms')" style="background:none;border:none;color:var(--gray-600);cursor:pointer;text-decoration:underline;padding:.5rem">Terms</button><button onclick="navigate('/privacy')" style="background:none;border:none;color:var(--gray-600);cursor:pointer;text-decoration:underline;padding:.5rem">Privacy</button><a href="mailto:queueapphelpdesk@gmail.com" style="color:var(--gray-600);text-decoration:underline">Support</a></div><p style="color:var(--gray-500);font-size:.875rem">¬© 2025 QueueApp Phone: +91 7200 36 9191 Email: queueapphelpdesk@gmail.com</p></div></footer></div>`);
}

// Continue with remaining functions...
// Due to character limit, I'll provide the rest in a separate message

/* REST OF THE CODE CONTINUES EXACTLY AS IN YOUR ORIGINAL FILE */
/* Including: showPricing, showPaymentPage, showUploadScreenshot, submitPaymentProof, handleUpgrade, */
/* showLogin, handleLogin, showRestaurantLogin, handleRestaurantLogin, showSignup, handleSignup, */
/* showJoinQueue, handleJoinQueue, showLoadingSuccess, showUpgradeModal, showQueueStatus, showDisplay, */
/* showCleanupChoiceModal, performCleanup, showCleanupSuccessModal, showProgressiveUpgradeModal, */
/* showRestaurantAdmin, allocateTable, logout, showAdminPasswordPrompt, firebaseAdminLogin, */
/* checkFirebaseAdminAuth, showPlatformAdmin, renderPlatformAdminDashboard, viewScreenshot, */
/* approvePayment, rejectPayment, adminLogout, showQRPosterModal, printQRPoster, downloadQRPoster, */
/* closePosterModal, and all window assignments */

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
